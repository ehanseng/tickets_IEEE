{% extends "base.html" %}

{% block title %}Tickets - IEEE Tadeo Control System{% endblock %}

{% block content %}
<div class="rounded-lg border bg-card text-card-foreground shadow-sm">
    <div class="p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-3xl font-bold tracking-tight">Gestión de Tickets</h2>
            <div class="flex gap-2 flex-wrap">
                <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-purple-600 text-white hover:bg-purple-700 h-10 px-4 py-2" onclick="openValidationModeModal()">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                    </svg>
                    Modo de Validación
                </button>
                <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-green-600 text-white hover:bg-green-700 h-10 px-4 py-2" onclick="openWhatsAppModal()">
                    <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Enviar por WhatsApp
                </button>
                <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-blue-600 text-white hover:bg-blue-700 h-10 px-4 py-2" onclick="openEmailModal()">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Enviar por Email
                </button>
                <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2" onclick="openBulkModal()">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Crear Tickets de Eventos
                </button>
                <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2" onclick="openModal()">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Generar Nuevo Ticket
                </button>
            </div>
        </div>

        <!-- Barra de búsqueda y filtros -->
        <div class="mb-6 flex flex-col gap-4">
            <div class="flex-1 relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Buscar por usuario, evento o código de ticket..."
                    class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                    onkeyup="filterTickets()"
                >
            </div>
            <div class="flex gap-2 flex-wrap">
                <select id="statusFilter" onchange="filterTickets()" class="flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    <option value="all">Todos los tickets</option>
                    <option value="available">Solo disponibles</option>
                    <option value="used">Solo usados</option>
                </select>
                <select id="eventFilter" onchange="filterTickets()" class="flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    <option value="all">Todos los eventos</option>
                    {% for event in events %}
                    <option value="{{ event.id }}">{{ event.name }}</option>
                    {% endfor %}
                </select>
                <select id="validationModeFilter" onchange="filterTickets()" class="flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    <option value="all">Todos los modos</option>
                    <option value="once">Solo modo 'Once'</option>
                    <option value="daily">Solo modo 'Daily'</option>
                </select>
            </div>
        </div>

        {% if tickets %}
        <div class="relative w-full overflow-auto max-h-[calc(100vh-300px)]">
            <table class="w-full caption-bottom text-sm">
                <thead class="[&_tr]:border-b sticky top-0 z-10 bg-background">
                    <tr class="border-b transition-colors bg-background">
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground w-12">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="rounded border-gray-300">
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(1)">
                            <div class="flex items-center gap-1">
                                ID
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(2)">
                            <div class="flex items-center gap-1">
                                Usuario
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(3)">
                            <div class="flex items-center gap-1">
                                Evento
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Personas</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Modo</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Código</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(7)">
                            <div class="flex items-center gap-1">
                                Fecha Creación
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Estado</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Acciones</th>
                    </tr>
                </thead>
                <tbody class="[&_tr:last-child]:border-0" id="ticketsTableBody">
                    {% for ticket in tickets %}
                    <tr class="border-b transition-colors hover:bg-muted/50" data-event-id="{{ ticket.event_id if ticket.event_id is defined else '' }}">
                        <td class="p-2 align-middle">
                            <input type="checkbox" name="ticketSelect" value="{{ ticket.id }}" onchange="updateSelectedCount()" class="rounded border-gray-300">
                        </td>
                        <td class="p-2 align-middle">{{ ticket.id }}</td>
                        <td class="p-2 align-middle font-medium">{{ ticket.user_name }}</td>
                        <td class="p-2 align-middle">{{ ticket.event_name }}</td>
                        <td class="p-2 align-middle">
                            {% set comp = ticket.companions if ticket.companions is defined else 0 %}
                            <div class="flex items-center gap-2">
                                <strong class="text-primary">{{ 1 + comp }}</strong>
                                <span class="text-xs text-muted-foreground flex items-center gap-1">
                                    {% if comp == 0 %}
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    {% else %}
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                    </svg>
                                    +{{ comp }}
                                    {% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="p-2 align-middle">
                            {% if ticket.validation_mode == 'daily' %}
                            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-green-100 text-green-700 border border-green-200">
                                <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                                </svg>
                                Diario
                            </span>
                            {% else %}
                            <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium bg-orange-100 text-orange-700 border border-orange-200">
                                <svg class="mr-1 h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                                Una vez
                            </span>
                            {% endif %}
                        </td>
                        <td class="p-2 align-middle">
                            <div class="flex items-center gap-2">
                                <code class="relative rounded bg-muted px-2 py-1 font-mono text-xs max-w-[120px] overflow-hidden text-ellipsis"
                                      title="{{ ticket.ticket_code }}">
                                    {{ ticket.ticket_code[:16] }}...
                                </code>
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-6 w-6" title="Copiar código"
                                        onclick="copyCode('{{ ticket.ticket_code }}')">
                                    <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                        <td class="p-2 align-middle">{{ ticket.created_at.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td class="p-2 align-middle">
                            {% if ticket.is_used %}
                            <span class="inline-flex items-center rounded-full border border-transparent bg-red-100 text-red-700 px-2.5 py-0.5 text-xs font-semibold" id="status-{{ ticket.id }}">Usado</span>
                            <br>
                            <small class="text-xs text-muted-foreground">{{ ticket.used_at.strftime('%d/%m/%Y %H:%M') if ticket.used_at else '' }}</small>
                            {% else %}
                            <span class="inline-flex items-center rounded-full border border-transparent bg-emerald-100 text-emerald-700 px-2.5 py-0.5 text-xs font-semibold" id="status-{{ ticket.id }}">Disponible</span>
                            {% endif %}
                        </td>
                        <td class="p-2 align-middle">
                            <div class="flex flex-wrap gap-1">
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-7 w-7" title="Ver ticket"
                                        onclick="viewTicket({{ ticket.id }}, '{{ ticket.ticket_code }}')">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-blue-600 text-white hover:bg-blue-700 h-7 w-7" title="Enviar por email"
                                        onclick="sendEmail({{ ticket.id }})">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                    </svg>
                                </button>
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-emerald-600 text-white hover:bg-emerald-700 h-7 w-7" title="Enviar por WhatsApp"
                                        onclick="sendWhatsApp({{ ticket.id }})">
                                    <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                    </svg>
                                </button>
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7" title="Editar ticket"
                                        onclick="editTicket({{ ticket.id }}, {{ ticket.companions }})">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                {% if ticket.is_used %}
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-emerald-600 text-white hover:bg-emerald-700 h-7 w-7" title="Reactivar ticket"
                                        id="reactivate-{{ ticket.id }}"
                                        onclick="reactivateTicket({{ ticket.id }})">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                </button>
                                {% endif %}
                                <button class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-7 w-7" title="Eliminar ticket"
                                        onclick="deleteTicket({{ ticket.id }})">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-center text-muted-foreground py-8">No hay tickets generados</p>
        {% endif %}
    </div>
</div>

<!-- Modal para generar ticket -->
<div id="ticketModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-lg">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Generar Nuevo Ticket</h2>
                <button onclick="closeModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <form id="ticketForm" class="space-y-4">
                <div class="space-y-2">
                    <label for="user_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Usuario *</label>
                    <select id="user_id" name="user_id" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione un usuario</option>
                        {% for user in users %}
                        <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="space-y-2">
                    <label for="event_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Evento *</label>
                    <select id="event_id" name="event_id" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione un evento</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.name }} - {{ event.event_date.strftime('%d/%m/%Y') }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="space-y-2">
                    <label for="companions" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Acompañantes (0-4)</label>
                    <input type="number" id="companions" name="companions" min="0" max="4" value="0" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    <p class="text-xs text-muted-foreground">Cantidad de personas adicionales que acompañan al titular (maximo 4)</p>
                </div>

                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">Generar Ticket</button>
            </form>

            <div id="message" class="mt-4"></div>
        </div>
    </div>
</div>

<!-- Modal para ver QR -->
<div id="qrModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-lg">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Codigo QR del Ticket</h2>
                <button onclick="closeQRModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div id="qrContent" class="text-center">
                <p class="text-muted-foreground">Cargando...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar ticket -->
<div id="editModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-lg">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Editar Ticket</h2>
                <button onclick="closeEditModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="edit_ticket_id">

                <div class="space-y-2">
                    <label for="edit_companions" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Acompañantes (0-4)</label>
                    <input type="number" id="edit_companions" name="edit_companions" min="0" max="4" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    <p class="text-xs text-muted-foreground">Cantidad de personas adicionales que acompañan al titular</p>
                </div>

                <button type="submit" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">Guardar Cambios</button>
            </form>

            <div id="editMessage" class="mt-4"></div>
        </div>
    </div>
</div>

<!-- Modal para crear tickets masivos por etiqueta -->
<div id="bulkModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-lg">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Crear Tickets de Eventos Masivos</h2>
                <button onclick="closeBulkModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-sm">
                <p class="font-semibold text-blue-900 mb-1">Generación masiva de tickets</p>
                <p class="text-blue-700 text-xs">
                    Esta función creará tickets para todos los usuarios que tengan la etiqueta seleccionada.
                    Solo se crearán tickets para usuarios que aún NO tengan un ticket para el evento seleccionado.
                </p>
            </div>

            <form id="bulkForm" class="space-y-4">
                <div class="space-y-2">
                    <label for="bulk_event_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Evento *</label>
                    <select id="bulk_event_id" name="bulk_event_id" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione un evento</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.name }} - {{ event.event_date.strftime('%d/%m/%Y') }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="space-y-2">
                    <label for="bulk_tag_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Etiqueta *</label>
                    <select id="bulk_tag_id" name="bulk_tag_id" required onchange="updateUserPreview()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione una etiqueta</option>
                    </select>
                    <p class="text-xs text-muted-foreground">Se crearán tickets para todos los usuarios con esta etiqueta</p>
                </div>

                <div class="space-y-2">
                    <label for="bulk_companions" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Acompañantes (0-4)</label>
                    <input type="number" id="bulk_companions" name="bulk_companions" min="0" max="4" value="0" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    <p class="text-xs text-muted-foreground">Cantidad de acompañantes para cada ticket (mismo valor para todos)</p>
                </div>

                <!-- Vista previa de usuarios -->
                <div id="userPreview" class="hidden space-y-2">
                    <label class="text-sm font-medium">Vista previa de usuarios</label>
                    <div class="border rounded-lg p-3 bg-muted max-h-40 overflow-y-auto">
                        <p id="userPreviewCount" class="text-xs text-muted-foreground mb-2"></p>
                        <div id="userPreviewList" class="text-xs space-y-1"></div>
                    </div>
                </div>

                <button type="submit" id="bulkSubmitBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Crear Tickets Masivos
                </button>
            </form>

            <div id="bulkMessage" class="mt-4"></div>
        </div>
    </div>
</div>

<!-- Modal para envío masivo de tickets por WhatsApp -->
<div id="whatsappModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Enviar Tickets por WhatsApp</h2>
                <button onclick="closeWhatsAppModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 text-sm">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    <span class="font-semibold text-green-900">Envío masivo por evento</span>
                </div>
                <p class="text-green-700 text-xs">
                    Esta función enviará los tickets por WhatsApp a todos los usuarios que tengan ticket para el evento seleccionado.
                    Se omitirán usuarios sin número de teléfono registrado.
                </p>
            </div>

            <form id="whatsappForm" class="space-y-4">
                <div class="space-y-2">
                    <label for="whatsapp_event_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Evento *</label>
                    <select id="whatsapp_event_id" name="whatsapp_event_id" required onchange="updateTicketPreview(); updateTemplatePreview(); updateBulkMessagePreview();" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione un evento</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.name }} - {{ event.event_date.strftime('%d/%m/%Y') }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-muted-foreground">Selecciona el evento cuyos tickets deseas enviar</p>
                </div>

                <!-- Opción de método de envío -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none">Metodo de envio *</label>
                    <div class="grid grid-cols-2 gap-3">
                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-green-400 transition-colors" id="methodFreeTextLabel">
                            <input type="radio" name="send_method" value="free_text" class="sr-only" onchange="updateSendMethodUI(); updateBulkMessagePreview();">
                            <span class="flex flex-1 flex-col">
                                <span class="flex items-center gap-2 text-sm font-medium text-gray-900">
                                    <svg class="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                                    </svg>
                                    Mensaje Libre
                                </span>
                                <span class="mt-1 text-xs text-gray-500">Mensaje personalizado con formato completo. Solo funciona si el usuario ha interactuado en las ultimas 24h.</span>
                            </span>
                            <svg class="h-5 w-5 text-green-600 hidden" id="checkFreeText" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </label>
                        <label class="relative flex cursor-pointer rounded-lg border bg-white p-4 shadow-sm focus:outline-none hover:border-green-400 transition-colors" id="methodTemplateLabel">
                            <input type="radio" name="send_method" value="template" class="sr-only" checked onchange="updateSendMethodUI(); updateBulkMessagePreview();">
                            <span class="flex flex-1 flex-col">
                                <span class="flex items-center gap-2 text-sm font-medium text-gray-900">
                                    <svg class="h-5 w-5 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    Template Meta
                                </span>
                                <span class="mt-1 text-xs text-gray-500">Usa template pre-aprobado por Meta. Funciona siempre, incluso fuera de ventana de 24h.</span>
                            </span>
                            <svg class="h-5 w-5 text-green-600 hidden" id="checkTemplate" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </label>
                    </div>
                </div>

                <!-- Selector de template (visible solo cuando se selecciona Template Meta) -->
                <div id="templateSelectorSection" class="space-y-2">
                    <label for="whatsapp_template_name" class="text-sm font-medium leading-none">Template a usar *</label>
                    <select id="whatsapp_template_name" name="whatsapp_template_name" onchange="updateBulkMessagePreview()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                        <option value="tickets_event" selected>tickets_event (con QR en header)</option>
                        <option value="confirmacion_evento_v2">confirmacion_evento_v2 (sin imagen)</option>
                        <option value="recordatorio_evento">recordatorio_evento (recordatorio)</option>
                    </select>
                    <p id="bulkQrInfo" class="text-xs text-blue-600 bg-blue-50 p-2 rounded-md">El template "tickets_event" generara y enviara el codigo QR de cada ticket como imagen de encabezado.</p>
                </div>

                <!-- Textarea para mensaje libre masivo (solo visible con Mensaje Libre) -->
                <div id="bulkFreeTextSection" class="hidden space-y-2">
                    <label for="bulk_free_text_message" class="text-sm font-medium leading-none">Mensaje personalizado *</label>
                    <textarea id="bulk_free_text_message" name="bulk_free_text_message" rows="6" oninput="updateBulkMessagePreview()"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                        placeholder="Escribe tu mensaje aqui...

Puedes usar variables:
{nombre} - Nombre del usuario
{evento} - Nombre del evento
{fecha} - Fecha del evento
{lugar} - Lugar del evento"></textarea>
                    <p class="text-xs text-muted-foreground">
                        Variables disponibles: <code>{nombre}</code>, <code>{evento}</code>, <code>{fecha}</code>, <code>{lugar}</code>
                    </p>
                    <p class="text-xs text-amber-600 flex items-center gap-1">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        Solo funciona si los usuarios han interactuado con el numero en las ultimas 24 horas
                    </p>
                </div>

                <!-- Preview del template que se usará -->
                <div id="bulkPreviewSection" class="space-y-2">
                    <label class="text-sm font-medium">Preview del Mensaje</label>
                    <div class="border rounded-lg bg-[#e5ddd5] p-3">
                        <!-- Burbuja estilo WhatsApp -->
                        <div class="flex justify-end">
                            <div class="bg-[#dcf8c6] rounded-lg p-2 max-w-[85%] shadow-sm">
                                <!-- Imagen QR placeholder (solo para tickets_event) -->
                                <div id="bulkPreviewImage" class="mb-2 bg-white rounded p-2 flex items-center justify-center">
                                    <svg class="w-24 h-24 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <rect x="3" y="3" width="7" height="7" stroke-width="2" rx="1"/>
                                        <rect x="14" y="3" width="7" height="7" stroke-width="2" rx="1"/>
                                        <rect x="3" y="14" width="7" height="7" stroke-width="2" rx="1"/>
                                        <rect x="14" y="14" width="4" height="4" stroke-width="2" rx="0.5"/>
                                        <rect x="17" y="17" width="4" height="4" stroke-width="2" rx="0.5"/>
                                        <rect x="14" y="17" width="2" height="2" stroke-width="1.5" rx="0.25"/>
                                    </svg>
                                </div>
                                <!-- Mensaje -->
                                <div id="bulkPreviewContent" class="text-sm whitespace-pre-wrap text-gray-800"></div>
                                <!-- Footer -->
                                <div id="bulkPreviewFooter" class="text-xs text-gray-500 mt-1 pt-1 border-t border-gray-200"></div>
                            </div>
                        </div>
                    </div>
                    <p class="text-xs text-muted-foreground">Los valores mostrados son de ejemplo. Cada usuario recibira su mensaje personalizado.</p>
                </div>

                <!-- Vista previa de tickets a enviar -->
                <div id="ticketPreview" class="hidden space-y-2">
                    <label class="text-sm font-medium">Vista previa de envíos</label>
                    <div class="border rounded-lg p-3 bg-muted max-h-40 overflow-y-auto">
                        <p id="ticketPreviewCount" class="text-xs text-muted-foreground mb-2"></p>
                        <div id="ticketPreviewList" class="text-xs space-y-1"></div>
                    </div>
                </div>

                <button type="submit" id="whatsappSubmitBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-green-600 text-white hover:bg-green-700 h-10 px-4 py-2 w-full">
                    <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Enviar Tickets por WhatsApp
                </button>
            </form>

            <div id="whatsappMessage" class="mt-4"></div>
        </div>
    </div>
</div>

<!-- Modal para preview de mensaje individual de WhatsApp -->
<div id="whatsappPreviewModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Enviar por WhatsApp</h2>
                <button onclick="closeWhatsAppPreviewModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6 space-y-4">
            <!-- Info del destinatario -->
            <div class="bg-muted rounded-lg p-3 text-sm">
                <div class="space-y-1">
                    <div><strong>Usuario:</strong> <span id="previewUserName"></span></div>
                    <div><strong>Teléfono:</strong> <span id="previewPhone"></span></div>
                    <div><strong>Evento:</strong> <span id="previewEventName"></span></div>
                </div>
            </div>

            <!-- Metodo de envio (primero) -->
            <div>
                <label class="text-sm font-medium mb-2 block">Metodo de envio:</label>
                <div class="flex gap-2 mb-2">
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 flex-1 text-sm" id="singleMethodTemplateLabel">
                        <input type="radio" name="single_send_method" value="template" checked onchange="updateSingleSendMethodUI()">
                        <span>Template Meta</span>
                    </label>
                    <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer hover:bg-gray-50 flex-1 text-sm" id="singleMethodFreeTextLabel">
                        <input type="radio" name="single_send_method" value="free_text" onchange="updateSingleSendMethodUI()">
                        <span>Mensaje Libre</span>
                    </label>
                </div>
                <p id="singleMethodHint" class="text-xs text-muted-foreground">Template Meta funciona siempre, incluso fuera de ventana de 24h</p>
            </div>

            <!-- Selector de Template (solo visible con Template Meta) -->
            <div id="singleTemplateSelectorSection">
                <label class="text-sm font-medium mb-2 block">Template:</label>
                <select id="singleWhatsappTemplate" onchange="updateTemplateInfo()" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                    <option value="tickets_event" selected>tickets_event (con QR)</option>
                    <option value="confirmacion_evento_v2">confirmacion_evento_v2</option>
                    <option value="recordatorio_evento">recordatorio_evento</option>
                </select>

                <!-- Info de QR (solo visible con tickets_event) -->
                <div id="templateQrInfo" class="mt-3 p-3 rounded-lg text-sm bg-blue-50 border border-blue-200">
                    <div class="flex items-start gap-2">
                        <svg class="h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <p class="font-medium text-blue-900">Este template incluye codigo QR</p>
                            <p class="text-blue-700 text-xs mt-1">El codigo QR del ticket sera generado automaticamente y enviado como imagen en el header del mensaje.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Textarea para mensaje libre (solo visible con Mensaje Libre) -->
            <div id="singleFreeTextSection" class="hidden">
                <label class="text-sm font-medium mb-2 block">Mensaje personalizado:</label>
                <textarea id="singleFreeTextMessage" rows="6" oninput="updateMessagePreview('free_text', null)"
                    class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                    placeholder="Escribe tu mensaje aqui..."></textarea>
                <p class="text-xs text-amber-600 mt-2 flex items-center gap-1">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                    Solo funciona si el usuario ha interactuado con el numero en las ultimas 24 horas
                </p>
            </div>

            <!-- Preview del mensaje (al final) -->
            <div id="messagePreviewSection">
                <label class="text-sm font-medium mb-2 block">Vista previa del mensaje:</label>
                <div class="border rounded-lg bg-white overflow-hidden">
                    <!-- Preview de imagen QR (si existe) -->
                    <div id="previewImageSection" class="hidden border-b p-3 bg-gray-50 flex justify-center">
                        <img id="previewImage" src="" alt="QR del ticket" class="max-w-[120px] max-h-[120px] object-contain rounded">
                    </div>
                    <!-- Contenido del mensaje -->
                    <div class="p-4 max-h-64 overflow-y-auto whitespace-pre-wrap text-sm">
                        <div id="previewMessageContent"></div>
                    </div>
                </div>
                <p id="previewTemplateSource" class="text-xs text-muted-foreground mt-1 italic"></p>
            </div>

            <!-- Botones de accion -->
            <div class="flex gap-2 pt-2">
                <button onclick="confirmSendWhatsApp()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-green-600 text-white hover:bg-green-700 h-10 px-4 py-2 flex-1">
                    <svg class="mr-2 h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    Enviar Ahora
                </button>
                <button onclick="closeWhatsAppPreviewModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para envío masivo de Email -->
<div id="emailModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Enviar Tickets por Email</h2>
                <button onclick="closeEmailModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-sm">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span class="font-semibold text-blue-900">Envío masivo por evento</span>
                </div>
                <p class="text-blue-700 text-xs">
                    Esta función enviará los tickets por correo electrónico a todos los usuarios que tengan ticket para el evento seleccionado.
                    Se omitirán usuarios sin correo electrónico registrado.
                </p>
            </div>

            <form id="emailForm" class="space-y-4">
                <div class="space-y-2">
                    <label for="email_event_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Evento *</label>
                    <select id="email_event_id" name="email_event_id" required onchange="updateEmailTemplatePreview();" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione un evento</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.name }} - {{ event.event_date.strftime('%d/%m/%Y') }}</option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-muted-foreground">Selecciona el evento cuyos tickets deseas enviar</p>
                </div>

                <!-- Preview del template de email -->
                <div id="emailTemplatePreviewSection" class="hidden space-y-2">
                    <label class="text-sm font-medium">Preview del Email</label>
                    <div class="border rounded-lg p-4 bg-white space-y-3">
                        <div>
                            <span class="text-xs font-medium text-muted-foreground">Template:</span>
                            <span id="emailTemplateSourceName" class="text-xs italic ml-1"></span>
                        </div>

                        <div>
                            <span class="text-xs font-medium text-muted-foreground">Asunto:</span>
                            <div id="emailSubjectPreview" class="text-sm font-semibold mt-1"></div>
                        </div>

                        <!-- Preview HTML del email -->
                        <div>
                            <div class="text-xs font-medium text-muted-foreground mb-2">Vista previa del email:</div>
                            <div class="border rounded-lg bg-white max-h-96 overflow-y-auto">
                                <iframe id="emailPreviewFrame" class="w-full h-96 border-0" sandbox="allow-same-origin"></iframe>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" id="emailSubmitBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-blue-600 text-white hover:bg-blue-700 h-10 px-4 py-2 w-full">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    Enviar Tickets por Email
                </button>
            </form>

            <div id="emailMessage" class="mt-4"></div>

            <!-- Progress container -->
            <div id="emailProgressContainer" class="hidden mt-4">
                <div class="bg-muted rounded-lg p-4">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium">Enviando emails...</span>
                        <span id="emailProgressText" class="text-xs text-muted-foreground">0/0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="emailProgressBar" class="bg-blue-600 h-2.5 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                    <div id="emailProgressLog" class="mt-3 max-h-60 overflow-y-auto text-xs space-y-1"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para preview de email individual -->
<div id="emailPreviewModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-2xl font-semibold leading-none tracking-tight">Preview de Email</h2>
                <button onclick="closeEmailPreviewModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
        </div>

        <div class="p-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-sm">
                <div class="flex items-center gap-2 mb-2">
                    <svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                    <span class="font-semibold text-blue-900">Vista previa del email</span>
                </div>
                <p class="text-blue-700 text-xs">
                    Este es el email que se enviará al usuario
                </p>
            </div>

            <div class="space-y-4">
                <!-- Info del destinatario -->
                <div class="bg-muted rounded-lg p-3 text-sm">
                    <div class="space-y-1">
                        <div><strong>Usuario:</strong> <span id="emailPreviewUserName"></span></div>
                        <div><strong>Email:</strong> <span id="emailPreviewEmail"></span></div>
                        <div><strong>Evento:</strong> <span id="emailPreviewEventName"></span></div>
                        <div><strong>Template:</strong> <span id="emailPreviewTemplateSource" class="text-xs italic"></span></div>
                    </div>
                </div>

                <!-- Asunto del email -->
                <div>
                    <label class="text-sm font-medium">Asunto:</label>
                    <div id="emailPreviewSubject" class="mt-2 text-base font-semibold"></div>
                </div>

                <!-- Preview del HTML -->
                <div>
                    <label class="text-sm font-medium">Vista previa del email:</label>
                    <div class="mt-2 border rounded-lg bg-white max-h-96 overflow-y-auto">
                        <iframe id="emailPreviewHTMLFrame" class="w-full h-96 border-0" sandbox="allow-same-origin"></iframe>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="flex gap-2">
                    <button onclick="confirmSendEmail()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-blue-600 text-white hover:bg-blue-700 h-10 px-4 py-2 flex-1">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        Enviar Ahora
                    </button>
                    <button onclick="closeEmailPreviewModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function openModal() {
        document.getElementById('ticketModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('ticketModal').classList.add('hidden');
        document.getElementById('ticketForm').reset();
        document.getElementById('message').innerHTML = '';
    }

    function closeQRModal() {
        document.getElementById('qrModal').classList.add('hidden');
    }

    function copyCode(code) {
        navigator.clipboard.writeText(code).then(() => {
            alert('✓ Código copiado al portapapeles');
        }).catch(err => {
            // Fallback para navegadores antiguos
            const textArea = document.createElement('textarea');
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('✓ Código copiado al portapapeles');
        });
    }

    async function viewTicket(ticketId, ticketCode) {
        document.getElementById('qrModal').classList.remove('hidden');
        document.getElementById('qrContent').innerHTML = '<p class="text-muted-foreground">Cargando...</p>';

        try {
            const response = await fetch(`/tickets/${ticketId}/qr-base64`);
            const data = await response.json();

            if (response.ok) {
                document.getElementById('qrContent').innerHTML = `
                    <img src="${data.qr_code}" alt="QR Code" class="max-w-full border-2 border-border p-2 rounded-lg mx-auto">

                    <div class="mt-5 p-4 rounded-lg bg-muted">
                        <p class="text-sm text-muted-foreground mb-2">Codigo del ticket:</p>
                        <code class="block bg-background p-3 rounded-md break-all text-xs border border-border font-mono">
                            ${ticketCode}
                        </code>
                        <button class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 mt-3 w-full"
                                onclick="copyCode('${ticketCode}')">Copiar Codigo</button>
                    </div>

                    <p class="mt-5">
                        <a href="/tickets/${ticketId}/qr" download="ticket_${ticketId}.png" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-emerald-600 text-white hover:bg-emerald-700 h-10 px-4 py-2 w-full">Descargar QR</a>
                    </p>
                `;
            } else {
                document.getElementById('qrContent').innerHTML =
                    '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error al cargar el QR</div>';
            }
        } catch (error) {
            document.getElementById('qrContent').innerHTML =
                '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error al cargar el QR</div>';
        }
    }

    document.getElementById('ticketForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            user_id: parseInt(document.getElementById('user_id').value),
            event_id: parseInt(document.getElementById('event_id').value),
            companions: parseInt(document.getElementById('companions').value)
        };

        try {
            const response = await fetch('/tickets/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('message').innerHTML =
                    '<div class="rounded-lg border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-700">Ticket generado exitosamente</div>';
                setTimeout(() => {
                    closeModal();
                    viewTicket(data.id, data.ticket_code);
                    setTimeout(() => window.location.reload(), 2000);
                }, 1500);
            } else {
                document.getElementById('message').innerHTML =
                    `<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error: ${data.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('message').innerHTML =
                '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error al generar ticket</div>';
        }
    });

    async function reactivateTicket(ticketId) {
        if (!confirm('¿Estás seguro de que quieres reactivar este ticket? Permitirá que se use nuevamente.')) {
            return;
        }

        try {
            const response = await fetch(`/tickets/${ticketId}/reactivate`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });

            const data = await response.json();

            if (response.ok) {
                // Actualizar la interfaz sin recargar la página
                const statusBadge = document.getElementById(`status-${ticketId}`);
                const reactivateBtn = document.getElementById(`reactivate-${ticketId}`);

                if (statusBadge) {
                    statusBadge.className = 'inline-flex items-center rounded-full border border-transparent bg-emerald-100 text-emerald-700 px-2.5 py-0.5 text-xs font-semibold';
                    statusBadge.textContent = 'Disponible';
                    // Remover la fecha de uso
                    const smallTag = statusBadge.nextElementSibling;
                    if (smallTag && smallTag.tagName === 'BR') {
                        smallTag.nextElementSibling?.remove();
                        smallTag.remove();
                    }
                }

                if (reactivateBtn) {
                    reactivateBtn.remove();
                }

                alert('✓ Ticket reactivado exitosamente');
            } else {
                alert(`Error: ${data.detail || 'No se pudo reactivar el ticket'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al reactivar el ticket');
        }
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('editForm').reset();
        document.getElementById('editMessage').innerHTML = '';
    }

    function editTicket(ticketId, currentCompanions) {
        document.getElementById('edit_ticket_id').value = ticketId;
        document.getElementById('edit_companions').value = currentCompanions;
        document.getElementById('editModal').classList.remove('hidden');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const ticketId = document.getElementById('edit_ticket_id').value;
        const companions = parseInt(document.getElementById('edit_companions').value);

        try {
            const response = await fetch(`/tickets/${ticketId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ companions: companions })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('editMessage').innerHTML =
                    '<div class="rounded-lg border border-emerald-200 bg-emerald-50 p-4 text-sm text-emerald-700">Ticket actualizado exitosamente</div>';
                setTimeout(() => {
                    closeEditModal();
                    window.location.reload();
                }, 1500);
            } else {
                document.getElementById('editMessage').innerHTML =
                    `<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error: ${data.detail || 'No se pudo actualizar el ticket'}</div>`;
            }
        } catch (error) {
            document.getElementById('editMessage').innerHTML =
                '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error al actualizar ticket</div>';
        }
    });

    let currentEmailPreviewTicketId = null;

    async function sendEmail(ticketId) {
        try {
            const token = localStorage.getItem('access_token');

            // Obtener preview del email
            const response = await fetch(`/tickets/${ticketId}/email-preview`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                // Guardar el ID del ticket para enviar después
                currentEmailPreviewTicketId = ticketId;

                // Mostrar el preview en el modal
                document.getElementById('emailPreviewUserName').textContent = data.user_name;
                document.getElementById('emailPreviewEmail').textContent = data.email || 'Sin email';
                document.getElementById('emailPreviewEventName').textContent = data.event_name;
                document.getElementById('emailPreviewTemplateSource').textContent = data.template_source || 'default';
                document.getElementById('emailPreviewSubject').textContent = data.subject;

                // Mostrar el HTML en el iframe
                const iframe = document.getElementById('emailPreviewHTMLFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                iframeDoc.open();
                iframeDoc.write(data.html_preview);
                iframeDoc.close();

                // Abrir el modal
                document.getElementById('emailPreviewModal').classList.remove('hidden');
            } else {
                alert(`Error: ${data.detail || 'No se pudo obtener el preview del email'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al obtener preview del email');
        }
    }

    function closeEmailPreviewModal() {
        document.getElementById('emailPreviewModal').classList.add('hidden');
        currentEmailPreviewTicketId = null;
    }

    async function confirmSendEmail() {
        if (!currentEmailPreviewTicketId) {
            alert('Error: No hay ticket seleccionado');
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/tickets/${currentEmailPreviewTicketId}/send-email`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                alert(`✓ Correo enviado exitosamente a ${data.email}`);
                closeEmailPreviewModal();
                // Recargar la tabla de tickets
                location.reload();
            } else {
                alert(`Error: ${data.detail || 'No se pudo enviar el correo'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al enviar el correo');
        }
    }

    // Cerrar modal de email preview al hacer clic fuera
    const emailPreviewModal = document.getElementById('emailPreviewModal');
    window.addEventListener('click', function(event) {
        if (event.target == emailPreviewModal) {
            closeEmailPreviewModal();
        }
    });

    let currentPreviewTicketId = null;
    let currentPreviewData = null; // Guardar datos del ticket para preview de templates

    // Definicion de templates con su estructura (DEBE coincidir con los templates aprobados en Meta)
    const templateDefinitions = {
        'tickets_event': {
            hasImage: true,
            imageLabel: 'Codigo QR del ticket',
            body: `🎫 ¡Hola {{1}}! Tu registro para {{2}} ha sido confirmado.

📅 Fecha: {{3}}
📍 Lugar: {{4}}

Tu código QR de acceso está en el encabezado de este mensaje.

¡Te esperamos!`,
            footer: 'IEEE Tadeo Student Branch'
        },
        'confirmacion_evento_v2': {
            hasImage: false,
            body: `🎫 ¡Hola {{1}}! Tu registro para {{2}} ha sido confirmado.

📅 Fecha: {{3}}
📍 Lugar: {{4}}

¡Te esperamos!`,
            footer: 'IEEE Tadeo Student Branch'
        },
        'recordatorio_evento': {
            hasImage: false,
            body: `⏰ ¡Hola {{1}}!

Te recordamos que mañana tienes el evento:

🎯 {{2}}

📅 Fecha: {{3}}
📍 Lugar: {{4}}

¡Te esperamos!`,
            footer: 'IEEE Tadeo Student Branch'
        }
    };

    async function sendWhatsApp(ticketId) {
        try {
            const token = localStorage.getItem('access_token');

            // Obtener preview del mensaje
            const response = await fetch(`/tickets/${ticketId}/whatsapp-preview`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                // Guardar el ID del ticket y datos para preview
                currentPreviewTicketId = ticketId;
                currentPreviewData = data;

                // Mostrar el preview en el modal
                document.getElementById('previewUserName').textContent = data.user_name;
                document.getElementById('previewPhone').textContent = data.phone || 'Sin teléfono';
                document.getElementById('previewEventName').textContent = data.event_name;

                // Inicializar el modal con Template Meta seleccionado por defecto
                const templateRadio = document.querySelector('input[name="single_send_method"][value="template"]');
                if (templateRadio) templateRadio.checked = true;

                // Resetear selector de template a tickets_event
                const templateSelect = document.getElementById('singleWhatsappTemplate');
                if (templateSelect) templateSelect.value = 'tickets_event';

                // Actualizar UI del metodo y template (esto tambien actualiza el preview)
                updateSingleSendMethodUI();

                // Abrir modal de preview
                document.getElementById('whatsappPreviewModal').classList.remove('hidden');
            } else {
                alert(`Error: ${data.detail || 'No se pudo obtener el preview'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al obtener preview de WhatsApp');
        }
    }

    // Función para actualizar UI del método de envío individual
    function updateSingleSendMethodUI() {
        const freeTextRadio = document.querySelector('input[name="single_send_method"][value="free_text"]');
        const templateRadio = document.querySelector('input[name="single_send_method"][value="template"]');
        const freeTextLabel = document.getElementById('singleMethodFreeTextLabel');
        const templateLabel = document.getElementById('singleMethodTemplateLabel');
        const hint = document.getElementById('singleMethodHint');
        const templateSection = document.getElementById('singleTemplateSelectorSection');
        const freeTextSection = document.getElementById('singleFreeTextSection');

        if (freeTextRadio && freeTextRadio.checked) {
            freeTextLabel.classList.add('border-green-500', 'bg-green-50');
            templateLabel.classList.remove('border-green-500', 'bg-green-50');
            hint.textContent = 'Mensaje libre solo funciona si el usuario ha interactuado en las ultimas 24h';
            // Ocultar selector de template, mostrar textarea
            if (templateSection) templateSection.classList.add('hidden');
            if (freeTextSection) freeTextSection.classList.remove('hidden');
            // Inicializar mensaje libre con datos del usuario si existe
            initializeFreeTextMessage();
            // Mostrar preview de mensaje libre
            updateMessagePreview('free_text');
        } else if (templateRadio && templateRadio.checked) {
            templateLabel.classList.add('border-green-500', 'bg-green-50');
            freeTextLabel.classList.remove('border-green-500', 'bg-green-50');
            hint.textContent = 'Template Meta funciona siempre, incluso fuera de ventana de 24h';
            // Mostrar selector de template, ocultar textarea
            if (templateSection) templateSection.classList.remove('hidden');
            if (freeTextSection) freeTextSection.classList.add('hidden');
            // Actualizar info del template y preview
            updateTemplateInfo();
        }
    }

    // Función para inicializar el mensaje libre con datos del ticket
    function initializeFreeTextMessage() {
        const textarea = document.getElementById('singleFreeTextMessage');
        if (!textarea || !currentPreviewData) return;

        // Solo inicializar si está vacío
        if (textarea.value.trim() === '') {
            const defaultMessage = `🎫 ¡Hola ${currentPreviewData.user_name}!

Tu registro para *${currentPreviewData.event_name}* ha sido confirmado.

📅 Fecha: ${currentPreviewData.event_date || 'Por confirmar'}
📍 Lugar: ${currentPreviewData.event_location || 'Por confirmar'}

¡Te esperamos!`;
            textarea.value = defaultMessage;
        }
    }

    // Función para actualizar info del template seleccionado
    function updateTemplateInfo() {
        const templateSelect = document.getElementById('singleWhatsappTemplate');
        const qrInfo = document.getElementById('templateQrInfo');

        if (!templateSelect || !qrInfo) return;

        const selectedTemplate = templateSelect.value;

        // Mostrar info de QR solo para tickets_event
        if (selectedTemplate === 'tickets_event') {
            qrInfo.classList.remove('hidden');
        } else {
            qrInfo.classList.add('hidden');
        }

        // Actualizar preview del mensaje
        updateMessagePreview('template', selectedTemplate);
    }

    // Función para actualizar el preview del mensaje segun metodo y template
    function updateMessagePreview(method, templateName = 'tickets_event') {
        const previewContent = document.getElementById('previewMessageContent');
        const previewSource = document.getElementById('previewTemplateSource');
        const previewImageSection = document.getElementById('previewImageSection');

        if (!currentPreviewData || !previewContent) return;

        if (method === 'free_text') {
            // Mostrar mensaje del textarea
            const textarea = document.getElementById('singleFreeTextMessage');
            const messageText = textarea ? textarea.value : (currentPreviewData.message_preview || '');
            previewContent.textContent = messageText;
            previewSource.textContent = 'Mensaje personalizado';

            // No mostrar imagen en mensaje libre
            previewImageSection.classList.add('hidden');
        } else {
            // Mostrar preview del template seleccionado
            const templateDef = templateDefinitions[templateName];

            if (templateDef) {
                // Reemplazar variables con datos reales
                let previewText = templateDef.body
                    .replace('{{1}}', currentPreviewData.user_name || '[Nombre]')
                    .replace('{{2}}', currentPreviewData.event_name || '[Evento]')
                    .replace('{{3}}', currentPreviewData.event_date || '[Fecha]')
                    .replace('{{4}}', currentPreviewData.event_location || '[Lugar]');

                previewContent.textContent = previewText;
                previewSource.textContent = 'Template: ' + templateName;

                // Mostrar imagen QR real si el template tiene imagen
                if (templateDef.hasImage) {
                    previewImageSection.classList.remove('hidden');
                    // Usar el QR real del ticket en base64 si está disponible
                    if (currentPreviewData.qr_base64) {
                        // qr_base64 ya incluye el prefijo data:image/png;base64,
                        document.getElementById('previewImage').src = currentPreviewData.qr_base64;
                    } else {
                        // Fallback a placeholder si no hay QR
                        document.getElementById('previewImage').src = 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100">
                                <rect fill="#f3f4f6" width="100" height="100"/>
                                <text x="50" y="42" text-anchor="middle" fill="#6b7280" font-family="sans-serif" font-size="10">Codigo QR</text>
                                <text x="50" y="58" text-anchor="middle" fill="#6b7280" font-family="sans-serif" font-size="8">(automatico)</text>
                            </svg>
                        `);
                    }
                } else {
                    previewImageSection.classList.add('hidden');
                }
            }
        }
    }

    async function confirmSendWhatsApp() {
        if (!currentPreviewTicketId) return;

        // Obtener método de envío seleccionado
        const sendMethod = document.querySelector('input[name="single_send_method"]:checked')?.value || 'template';
        const useTemplate = sendMethod === 'template';

        try {
            const token = localStorage.getItem('access_token');

            // Construir URL con parámetros
            let url = `/tickets/${currentPreviewTicketId}/send-whatsapp`;
            const params = new URLSearchParams();

            if (useTemplate) {
                const selectedTemplate = document.getElementById('singleWhatsappTemplate')?.value || 'tickets_event';
                params.append('use_template', 'true');
                params.append('template_name', selectedTemplate);
            } else {
                // Mensaje libre - obtener del textarea
                const customMessage = document.getElementById('singleFreeTextMessage')?.value || '';
                if (!customMessage.trim()) {
                    alert('Por favor escribe un mensaje');
                    return;
                }
                params.append('custom_message', customMessage);
            }

            if (params.toString()) {
                url += '?' + params.toString();
            }

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                closeWhatsAppPreviewModal();
                const methodInfo = useTemplate ? ' (via Template)' : ' (Mensaje libre)';
                alert(`✓ Ticket enviado por WhatsApp exitosamente${methodInfo}\n\nTelefono: ${data.phone}\nUsuario: ${data.user_name}`);
            } else {
                alert(`Error: ${data.detail || 'No se pudo enviar el ticket por WhatsApp'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al enviar por WhatsApp');
        }
    }

    function closeWhatsAppPreviewModal() {
        document.getElementById('whatsappPreviewModal').classList.add('hidden');
        currentPreviewTicketId = null;
        currentPreviewData = null;
        // Reset radio buttons - Template Meta por defecto
        const templateRadio = document.querySelector('input[name="single_send_method"][value="template"]');
        if (templateRadio) templateRadio.checked = true;
        // Reset template selector
        const templateSelect = document.getElementById('singleWhatsappTemplate');
        if (templateSelect) templateSelect.value = 'tickets_event';
        // Limpiar textarea de mensaje libre
        const freeTextArea = document.getElementById('singleFreeTextMessage');
        if (freeTextArea) freeTextArea.value = '';
        updateSingleSendMethodUI();
    }

    async function deleteTicket(ticketId) {
        if (!confirm('¿Estás seguro de que quieres eliminar este ticket? Esta acción no se puede deshacer.')) {
            return;
        }

        try {
            const response = await fetch(`/tickets/${ticketId}`, {
                method: 'DELETE'
            });

            const data = await response.json();

            if (response.ok) {
                alert('✓ Ticket eliminado exitosamente');
                window.location.reload();
            } else {
                alert(`Error: ${data.detail || 'No se pudo eliminar el ticket'}`);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error al eliminar el ticket');
        }
    }

    window.onclick = function(event) {
        const ticketModal = document.getElementById('ticketModal');
        const qrModal = document.getElementById('qrModal');
        const editModal = document.getElementById('editModal');
        const bulkModal = document.getElementById('bulkModal');
        const whatsappModal = document.getElementById('whatsappModal');
        const whatsappPreviewModal = document.getElementById('whatsappPreviewModal');

        if (event.target == ticketModal) {
            closeModal();
        }
        if (event.target == qrModal) {
            closeQRModal();
        }
        if (event.target == editModal) {
            closeEditModal();
        }
        if (event.target == bulkModal) {
            closeBulkModal();
        }
        if (event.target == whatsappModal) {
            closeWhatsAppModal();
        }
        if (event.target == whatsappPreviewModal) {
            closeWhatsAppPreviewModal();
        }
    }

    // ========== FUNCIONES PARA CREACIÓN MASIVA DE TICKETS ==========

    let availableTags = [];
    let usersByTag = {};

    async function loadTags() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/tags/?active_only=true', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                availableTags = await response.json();
                populateBulkTagSelect();
            }
        } catch (error) {
            console.error('Error al cargar tags:', error);
        }
    }

    function populateBulkTagSelect() {
        const select = document.getElementById('bulk_tag_id');
        select.innerHTML = '<option value="">Seleccione una etiqueta</option>';

        availableTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.id;
            option.textContent = `${tag.name} - ${tag.description || 'Sin descripción'}`;
            select.appendChild(option);
        });
    }

    async function loadUsersByTag(tagId) {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/users/by-tag/${tagId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const users = await response.json();
                usersByTag[tagId] = users;
                return users;
            }
            return [];
        } catch (error) {
            console.error('Error al cargar usuarios por tag:', error);
            return [];
        }
    }

    async function updateUserPreview() {
        const tagId = document.getElementById('bulk_tag_id').value;
        const previewDiv = document.getElementById('userPreview');
        const countP = document.getElementById('userPreviewCount');
        const listDiv = document.getElementById('userPreviewList');

        if (!tagId) {
            previewDiv.classList.add('hidden');
            return;
        }

        countP.textContent = 'Cargando...';
        listDiv.innerHTML = '';
        previewDiv.classList.remove('hidden');

        const users = await loadUsersByTag(tagId);

        if (users.length === 0) {
            countP.textContent = 'No hay usuarios con esta etiqueta';
            listDiv.innerHTML = '<p class="text-muted-foreground">Sin usuarios</p>';
        } else {
            countP.textContent = `Se crearán tickets para ${users.length} usuario(s):`;
            listDiv.innerHTML = users.map(u =>
                `<div class="flex items-center gap-2">
                    <svg class="h-3 w-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    <span>${u.name} (${u.email})</span>
                </div>`
            ).join('');
        }
    }

    function openBulkModal() {
        loadTags();
        document.getElementById('bulkModal').classList.remove('hidden');
        document.getElementById('bulkForm').reset();
        document.getElementById('bulkMessage').innerHTML = '';
        document.getElementById('userPreview').classList.add('hidden');
    }

    function closeBulkModal() {
        document.getElementById('bulkModal').classList.add('hidden');
        document.getElementById('bulkForm').reset();
        document.getElementById('bulkMessage').innerHTML = '';
        document.getElementById('userPreview').classList.add('hidden');
    }

    document.getElementById('bulkForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const eventId = parseInt(document.getElementById('bulk_event_id').value);
        const tagId = parseInt(document.getElementById('bulk_tag_id').value);
        const companions = parseInt(document.getElementById('bulk_companions').value);
        const submitBtn = document.getElementById('bulkSubmitBtn');
        const messageDiv = document.getElementById('bulkMessage');

        if (!eventId || !tagId) {
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Por favor complete todos los campos</div>';
            return;
        }

        submitBtn.disabled = true;
        messageDiv.innerHTML = '<div class="rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm text-blue-700">Creando tickets... Por favor espere.</div>';

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/tickets/bulk-by-tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    event_id: eventId,
                    tag_id: tagId,
                    companions: companions
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                messageDiv.innerHTML = `
                    <div class="rounded-lg border border-green-200 bg-green-50 p-4 text-sm">
                        <div class="flex items-center gap-2 text-green-700 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold">Tickets creados exitosamente</span>
                        </div>
                        <div class="space-y-1 text-green-700">
                            <p><strong>Tickets creados:</strong> ${data.created_count}</p>
                            <p><strong>Usuarios procesados:</strong> ${data.total_users}</p>
                            ${data.skipped_count > 0 ? `<p class="text-xs"><em>Usuarios omitidos (ya tenían ticket): ${data.skipped_count}</em></p>` : ''}
                        </div>
                    </div>
                `;
                setTimeout(() => {
                    closeBulkModal();
                    window.location.reload();
                }, 2000);
            } else {
                messageDiv.innerHTML = `
                    <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
                        Error: ${data.detail || 'No se pudieron crear los tickets'}
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error de conexión al crear tickets</div>';
        } finally {
            submitBtn.disabled = false;
        }
    });

    // ========== FUNCIONES PARA ENVÍO MASIVO POR WHATSAPP ==========

    let ticketsByEvent = {};

    async function loadTicketsByEvent(eventId) {
        try {
            const token = localStorage.getItem('access_token');
            // Obtener todos los tickets del evento desde el servidor
            const response = await fetch(`/tickets/?event_id=${eventId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const allTickets = await response.json();
                // Filtrar solo los del evento seleccionado
                const tickets = allTickets.filter(t => t.event_id == eventId);
                ticketsByEvent[eventId] = tickets;
                return tickets;
            }
            return [];
        } catch (error) {
            console.error('Error al cargar tickets por evento:', error);
            return [];
        }
    }

    async function updateTicketPreview() {
        const eventId = document.getElementById('whatsapp_event_id').value;
        const previewDiv = document.getElementById('ticketPreview');
        const countP = document.getElementById('ticketPreviewCount');
        const listDiv = document.getElementById('ticketPreviewList');

        if (!eventId) {
            previewDiv.classList.add('hidden');
            return;
        }

        countP.textContent = 'Cargando...';
        listDiv.innerHTML = '';
        previewDiv.classList.remove('hidden');

        const tickets = await loadTicketsByEvent(eventId);

        if (tickets.length === 0) {
            countP.textContent = 'No hay tickets para este evento';
            listDiv.innerHTML = '<p class="text-muted-foreground">Sin tickets</p>';
        } else {
            const ticketsWithPhone = tickets.filter(t => t.user && t.user.phone);
            const ticketsWithoutPhone = tickets.length - ticketsWithPhone.length;

            countP.textContent = `Se enviarán ${ticketsWithPhone.length} ticket(s) de ${tickets.length} total(es):`;
            listDiv.innerHTML = ticketsWithPhone.map(t =>
                `<div class="flex items-center gap-2">
                    <svg class="h-3 w-3 text-green-600" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                    </svg>
                    <span>${t.user.name} (${t.user.phone})</span>
                </div>`
            ).join('');

            if (ticketsWithoutPhone > 0) {
                listDiv.innerHTML += `<p class="text-xs text-amber-600 mt-2">⚠ ${ticketsWithoutPhone} usuario(s) sin teléfono serán omitidos</p>`;
            }
        }
    }

    async function updateTemplatePreview() {
        const eventId = document.getElementById('whatsapp_event_id').value;
        const previewSection = document.getElementById('templatePreviewSection');
        const previewContent = document.getElementById('templatePreviewContent');
        const templateSourceName = document.getElementById('templateSourceName');

        if (!eventId) {
            previewSection.classList.add('hidden');
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/events/${eventId}/whatsapp-template-preview`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            const data = await response.json();

            if (response.ok) {
                previewContent.textContent = data.message_preview;
                templateSourceName.textContent = data.template_source_name;

                // Mostrar imagen si existe
                if (data.has_image && data.image_url) {
                    document.getElementById('templatePreviewImage').src = data.image_url;
                    document.getElementById('templateImageSection').classList.remove('hidden');
                } else {
                    document.getElementById('templateImageSection').classList.add('hidden');
                }

                // Mostrar indicador de envío de QR
                const qrIndicator = document.getElementById('templateQrIndicator');
                if (data.send_qr_with_whatsapp) {
                    qrIndicator.className = 'p-2 rounded-lg text-xs bg-blue-50 border border-blue-200';
                    qrIndicator.innerHTML = '✅ <strong>El código QR se enviará directamente en WhatsApp</strong>';
                } else {
                    qrIndicator.className = 'p-2 rounded-lg text-xs bg-gray-50 border border-gray-200';
                    qrIndicator.innerHTML = '🔗 <strong>El código QR se enviará como enlace</strong>';
                }

                previewSection.classList.remove('hidden');
            } else {
                previewSection.classList.add('hidden');
            }
        } catch (error) {
            console.error('Error loading template preview:', error);
            previewSection.classList.add('hidden');
        }
    }

    function openWhatsAppModal() {
        document.getElementById('whatsappModal').classList.remove('hidden');
        document.getElementById('whatsappForm').reset();
        document.getElementById('whatsappMessage').innerHTML = '';
        document.getElementById('ticketPreview').classList.add('hidden');

        // Establecer Template Meta como seleccionado por defecto
        const templateRadio = document.querySelector('input[name="send_method"][value="template"]');
        if (templateRadio) {
            templateRadio.checked = true;
        }

        // Seleccionar tickets_event por defecto
        const templateSelect = document.getElementById('whatsapp_template_name');
        if (templateSelect) {
            templateSelect.value = 'tickets_event';
        }

        updateSendMethodUI();
        updateBulkMessagePreview();
    }

    function closeWhatsAppModal() {
        document.getElementById('whatsappModal').classList.add('hidden');
        document.getElementById('whatsappForm').reset();
        document.getElementById('whatsappMessage').innerHTML = '';
        document.getElementById('ticketPreview').classList.add('hidden');
        document.getElementById('templateSelectorSection').classList.add('hidden');
        document.getElementById('bulkFreeTextSection')?.classList.add('hidden');
        // Limpiar textarea de mensaje libre
        const bulkTextarea = document.getElementById('bulk_free_text_message');
        if (bulkTextarea) bulkTextarea.value = '';
        // Restaurar Template Meta como default
        const templateRadio = document.querySelector('input[name="send_method"][value="template"]');
        if (templateRadio) templateRadio.checked = true;
        updateSendMethodUI();
    }

    // Función para actualizar la UI según el método de envío seleccionado
    function updateSendMethodUI() {
        const freeTextRadio = document.querySelector('input[name="send_method"][value="free_text"]');
        const templateRadio = document.querySelector('input[name="send_method"][value="template"]');
        const templateSelector = document.getElementById('templateSelectorSection');
        const freeTextSection = document.getElementById('bulkFreeTextSection');
        const freeTextLabel = document.getElementById('methodFreeTextLabel');
        const templateLabel = document.getElementById('methodTemplateLabel');
        const checkFreeText = document.getElementById('checkFreeText');
        const checkTemplate = document.getElementById('checkTemplate');

        if (freeTextRadio && freeTextRadio.checked) {
            templateSelector.classList.add('hidden');
            if (freeTextSection) freeTextSection.classList.remove('hidden');
            freeTextLabel.classList.add('border-green-500', 'bg-green-50');
            templateLabel.classList.remove('border-green-500', 'bg-green-50');
            checkFreeText.classList.remove('hidden');
            checkTemplate.classList.add('hidden');
            // Inicializar mensaje por defecto si está vacío
            initializeBulkFreeTextMessage();
        } else if (templateRadio && templateRadio.checked) {
            templateSelector.classList.remove('hidden');
            if (freeTextSection) freeTextSection.classList.add('hidden');
            templateLabel.classList.add('border-green-500', 'bg-green-50');
            freeTextLabel.classList.remove('border-green-500', 'bg-green-50');
            checkTemplate.classList.remove('hidden');
            checkFreeText.classList.add('hidden');
        }
        updateBulkMessagePreview();
    }

    // Función para inicializar el mensaje libre masivo
    function initializeBulkFreeTextMessage() {
        const textarea = document.getElementById('bulk_free_text_message');
        if (!textarea) return;

        // Solo inicializar si está vacío
        if (textarea.value.trim() === '') {
            textarea.value = `🎫 ¡Hola {nombre}!

Tu registro para *{evento}* ha sido confirmado.

📅 Fecha: {fecha}
📍 Lugar: {lugar}

¡Te esperamos!`;
        }
    }

    // Funcion para actualizar preview del mensaje masivo
    function updateBulkMessagePreview() {
        const previewSection = document.getElementById('bulkPreviewSection');
        const previewImage = document.getElementById('bulkPreviewImage');
        const previewContent = document.getElementById('bulkPreviewContent');
        const previewFooter = document.getElementById('bulkPreviewFooter');
        const qrInfo = document.getElementById('bulkQrInfo');

        const sendMethod = document.querySelector('input[name="send_method"]:checked')?.value || 'template';
        const templateName = document.getElementById('whatsapp_template_name')?.value || 'tickets_event';

        // Obtener datos del evento seleccionado para preview
        const eventSelect = document.getElementById('whatsapp_event_id');
        const selectedOption = eventSelect?.options[eventSelect.selectedIndex];
        const eventText = selectedOption?.text || 'Nombre del Evento - DD/MM/YYYY';

        // Extraer nombre y fecha del evento
        let eventName = 'IEEE Workshop 2025';
        let eventDate = '15/01/2025';
        if (selectedOption && selectedOption.value) {
            const parts = eventText.split(' - ');
            if (parts.length >= 2) {
                eventName = parts.slice(0, -1).join(' - ');
                eventDate = parts[parts.length - 1];
            }
        }

        if (sendMethod === 'free_text') {
            // Mensaje libre - mostrar contenido del textarea con variables reemplazadas
            previewImage.classList.add('hidden');

            const textarea = document.getElementById('bulk_free_text_message');
            let messageText = textarea ? textarea.value : '';

            // Reemplazar variables con datos de ejemplo
            messageText = messageText
                .replace(/\{nombre\}/g, 'María García')
                .replace(/\{evento\}/g, eventName)
                .replace(/\{fecha\}/g, eventDate)
                .replace(/\{lugar\}/g, 'Auditorio IEEE Tadeo');

            previewContent.textContent = messageText || '(Escribe tu mensaje arriba)';
            previewFooter.textContent = '';
            qrInfo.classList.add('hidden');
            document.getElementById('templateSelectorSection').classList.add('hidden');
            document.getElementById('bulkFreeTextSection')?.classList.remove('hidden');
        } else {
            // Template Meta
            document.getElementById('templateSelectorSection').classList.remove('hidden');
            document.getElementById('bulkFreeTextSection')?.classList.add('hidden');
            const template = templateDefinitions[templateName];

            if (template) {
                // Mostrar/ocultar imagen segun template
                if (template.hasImage) {
                    previewImage.classList.remove('hidden');
                    qrInfo.classList.remove('hidden');
                    qrInfo.textContent = 'El template "tickets_event" generara y enviara el codigo QR de cada ticket como imagen de encabezado.';
                } else {
                    previewImage.classList.add('hidden');
                    qrInfo.classList.remove('hidden');
                    qrInfo.textContent = 'Este template no incluye imagen de encabezado.';
                    qrInfo.className = 'text-xs text-gray-600 bg-gray-50 p-2 rounded-md';
                }

                // Sustituir variables con datos de ejemplo
                let body = template.body
                    .replace('{{1}}', 'Maria Garcia')
                    .replace('{{2}}', eventName)
                    .replace('{{3}}', eventDate)
                    .replace('{{4}}', 'Auditorio IEEE Tadeo');

                previewContent.textContent = body;
                previewFooter.textContent = template.footer || '';

                // Restaurar estilo del qrInfo si es tickets_event
                if (template.hasImage) {
                    qrInfo.className = 'text-xs text-blue-600 bg-blue-50 p-2 rounded-md';
                }
            }
        }

        previewSection.classList.remove('hidden');
    }

    // Inicializar UI al cargar
    document.addEventListener('DOMContentLoaded', function() {
        updateSendMethodUI();
        updateBulkMessagePreview();
    });

    document.getElementById('whatsappForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const eventId = parseInt(document.getElementById('whatsapp_event_id').value);
        const submitBtn = document.getElementById('whatsappSubmitBtn');
        const messageDiv = document.getElementById('whatsappMessage');

        // Obtener método de envío seleccionado
        const sendMethod = document.querySelector('input[name="send_method"]:checked')?.value || 'template';
        const useTemplate = sendMethod === 'template';
        const templateName = document.getElementById('whatsapp_template_name')?.value || 'tickets_event';
        const customMessage = document.getElementById('bulk_free_text_message')?.value || '';

        if (!eventId) {
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Por favor seleccione un evento</div>';
            return;
        }

        // Validar mensaje personalizado si es mensaje libre
        if (!useTemplate && !customMessage.trim()) {
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Por favor escribe un mensaje personalizado</div>';
            return;
        }

        submitBtn.disabled = true;

        const methodLabel = useTemplate ? `Template: ${templateName}` : 'Mensaje libre';

        // Crear contenedor para progreso en tiempo real
        messageDiv.innerHTML = `
            <div class="rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm space-y-3">
                <div class="flex items-center gap-2 text-blue-700">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-700"></div>
                    <span class="font-semibold">Enviando tickets por WhatsApp...</span>
                </div>
                <p class="text-xs text-blue-600">Metodo: <strong>${methodLabel}</strong></p>

                <!-- Barra de progreso -->
                <div class="w-full bg-blue-100 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-xs text-blue-600">Iniciando...</p>

                <!-- Log de eventos -->
                <div id="progressLog" class="mt-3 max-h-60 overflow-y-auto bg-white rounded border border-blue-200 p-2 text-xs space-y-1 font-mono"></div>
            </div>
        `;

        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const progressLog = document.getElementById('progressLog');

        let sentCount = 0;
        let skippedCount = 0;
        let totalTickets = 0;
        let errors = [];

        try {
            const token = localStorage.getItem('access_token');

            // Usar fetch con streaming manual (EventSource no permite headers personalizados)
            const response = await fetch('/tickets/send-whatsapp-by-event-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    event_id: eventId,
                    use_template: useTemplate,
                    template_name: templateName,
                    custom_message: useTemplate ? null : customMessage
                })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));

                        if (data.event === 'start') {
                            totalTickets = data.total;
                            progressText.textContent = `Iniciando envío de ${totalTickets} ticket(s)...`;
                            progressLog.innerHTML += `<div class="text-blue-600">📋 Evento: ${data.event_name}</div>`;
                            progressLog.innerHTML += `<div class="text-blue-600">📊 Total de tickets: ${totalTickets}</div>`;
                            progressLog.innerHTML += `<div class="text-gray-400">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>`;
                        }
                        else if (data.event === 'sending') {
                            const percent = Math.round((data.index / totalTickets) * 100);
                            progressBar.style.width = `${percent}%`;
                            progressText.textContent = `Enviando ${data.index}/${totalTickets} (${percent}%)...`;
                            progressLog.innerHTML += `<div class="text-blue-600">⏳ [${data.index}/${totalTickets}] Enviando a ${data.user} (${data.phone})...</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'success') {
                            sentCount++;
                            progressLog.innerHTML += `<div class="text-green-600">✓ [${data.index}/${totalTickets}] ${data.user} - Enviado exitosamente</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'skip') {
                            skippedCount++;
                            progressLog.innerHTML += `<div class="text-amber-600">⚠ [${data.index}/${totalTickets}] ${data.user} - Omitido: ${data.reason}</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'error') {
                            skippedCount++;
                            errors.push(`${data.user}: ${data.reason}`);
                            progressLog.innerHTML += `<div class="text-red-600">✗ [${data.index}/${totalTickets}] ${data.user} - Error: ${data.reason}</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'complete') {
                            progressBar.style.width = '100%';
                            progressText.textContent = 'Completado';
                            progressLog.innerHTML += `<div class="text-gray-400">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>`;
                            progressLog.innerHTML += `<div class="text-green-600 font-bold">✓ Proceso completado</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;

                            // Mostrar resumen final
                            setTimeout(() => {
                                messageDiv.innerHTML = `
                                    <div class="rounded-lg border border-green-200 bg-green-50 p-4 text-sm">
                                        <div class="flex items-center gap-2 text-green-700 mb-2">
                                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                                            </svg>
                                            <span class="font-semibold">Tickets enviados exitosamente</span>
                                        </div>
                                        <div class="space-y-1 text-green-700">
                                            <p><strong>Mensajes enviados:</strong> ${sentCount}</p>
                                            <p><strong>Total de tickets:</strong> ${totalTickets}</p>
                                            ${skippedCount > 0 ? `<p class="text-xs"><em>Usuarios omitidos (sin teléfono o error): ${skippedCount}</em></p>` : ''}
                                            ${errors.length > 0 ? `
                                                <details class="mt-2">
                                                    <summary class="cursor-pointer text-xs">Ver errores (${errors.length})</summary>
                                                    <ul class="text-xs mt-1 ml-4 list-disc">
                                                        ${errors.map(err => `<li>${err}</li>`).join('')}
                                                    </ul>
                                                </details>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                                submitBtn.disabled = false;
                                setTimeout(() => {
                                    closeWhatsAppModal();
                                }, 3000);
                            }, 1000);
                        }
                    }
                }
            }

        } catch (error) {
            console.error('Error:', error);
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error de conexión al enviar tickets por WhatsApp</div>';
            submitBtn.disabled = false;
        }
    });

    // ============================================
    // Funciones para Email Modal
    // ============================================

    function openEmailModal() {
        document.getElementById('emailModal').classList.remove('hidden');
        document.getElementById('emailForm').reset();
        document.getElementById('emailMessage').innerHTML = '';
        document.getElementById('emailTemplatePreviewSection').classList.add('hidden');
        document.getElementById('emailProgressContainer').classList.add('hidden');
    }

    function closeEmailModal() {
        document.getElementById('emailModal').classList.add('hidden');
        document.getElementById('emailForm').reset();
        document.getElementById('emailMessage').innerHTML = '';
        document.getElementById('emailTemplatePreviewSection').classList.add('hidden');
        document.getElementById('emailProgressContainer').classList.add('hidden');
    }

    async function updateEmailTemplatePreview() {
        const eventId = document.getElementById('email_event_id').value;

        if (!eventId) {
            document.getElementById('emailTemplatePreviewSection').classList.add('hidden');
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/events/${eventId}/email-template-preview`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!response.ok) {
                console.error('Error al obtener preview del email');
                return;
            }

            const data = await response.json();

            // Mostrar sección de preview
            document.getElementById('emailTemplatePreviewSection').classList.remove('hidden');

            // Actualizar información
            document.getElementById('emailTemplateSourceName').textContent = data.template_source_name;
            document.getElementById('emailSubjectPreview').textContent = data.subject;

            // Mostrar el HTML del email en el iframe
            const iframe = document.getElementById('emailPreviewFrame');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            iframeDoc.open();
            iframeDoc.write(data.html_preview);
            iframeDoc.close();

        } catch (error) {
            console.error('Error:', error);
        }
    }

    document.getElementById('emailForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const eventId = parseInt(document.getElementById('email_event_id').value);
        const submitBtn = document.getElementById('emailSubmitBtn');
        const messageDiv = document.getElementById('emailMessage');
        const progressContainer = document.getElementById('emailProgressContainer');

        if (!eventId) {
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Por favor seleccione un evento</div>';
            return;
        }

        submitBtn.disabled = true;
        progressContainer.classList.remove('hidden');
        messageDiv.innerHTML = '';

        const progressBar = document.getElementById('emailProgressBar');
        const progressText = document.getElementById('emailProgressText');
        const progressLog = document.getElementById('emailProgressLog');

        progressLog.innerHTML = '';
        progressBar.style.width = '0%';
        progressText.textContent = '0/0';

        let sentCount = 0;
        let skippedCount = 0;
        let totalTickets = 0;
        let errors = [];

        try {
            const token = localStorage.getItem('access_token');

            const response = await fetch('/tickets/send-email-by-event-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ event_id: eventId })
            });

            const reader = response.body.getReader();
            const decoder = new TextDecoder();

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const data = JSON.parse(line.substring(6));

                        if (data.event === 'start') {
                            totalTickets = data.total;
                            progressText.textContent = `0/${totalTickets}`;
                            progressLog.innerHTML += `<div class="text-blue-600">📋 Evento: ${data.event_name}</div>`;
                            progressLog.innerHTML += `<div class="text-blue-600">📊 Total de tickets: ${totalTickets}</div>`;
                            progressLog.innerHTML += `<div class="text-gray-400">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>`;
                        }
                        else if (data.event === 'sending') {
                            const percent = Math.round((data.index / totalTickets) * 100);
                            progressBar.style.width = `${percent}%`;
                            progressText.textContent = `${data.index}/${totalTickets}`;
                            progressLog.innerHTML += `<div class="text-blue-600">⏳ [${data.index}/${totalTickets}] Enviando a ${data.user} (${data.email})...</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'success') {
                            sentCount++;
                            progressLog.innerHTML += `<div class="text-green-600">✓ [${data.index}/${totalTickets}] ${data.user} - Enviado exitosamente</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'skip') {
                            skippedCount++;
                            progressLog.innerHTML += `<div class="text-amber-600">⚠ [${data.index}/${totalTickets}] ${data.user} - Omitido: ${data.reason}</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'error') {
                            skippedCount++;
                            errors.push(`${data.user}: ${data.reason}`);
                            progressLog.innerHTML += `<div class="text-red-600">✗ [${data.index}/${totalTickets}] ${data.user} - Error: ${data.reason}</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;
                        }
                        else if (data.event === 'complete') {
                            progressBar.style.width = '100%';
                            progressText.textContent = `${totalTickets}/${totalTickets}`;
                            progressLog.innerHTML += `<div class="text-gray-400">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━</div>`;
                            progressLog.innerHTML += `<div class="text-green-600 font-bold">✓ Proceso completado</div>`;
                            progressLog.scrollTop = progressLog.scrollHeight;

                            // Mostrar resumen final
                            setTimeout(() => {
                                messageDiv.innerHTML = `
                                    <div class="rounded-lg border border-green-200 bg-green-50 p-4 text-sm">
                                        <div class="flex items-center gap-2 text-green-700 mb-2">
                                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                            </svg>
                                            <span class="font-semibold">Tickets enviados exitosamente por Email</span>
                                        </div>
                                        <div class="space-y-1 text-green-700">
                                            <p><strong>Emails enviados:</strong> ${sentCount}</p>
                                            <p><strong>Total de tickets:</strong> ${totalTickets}</p>
                                            ${skippedCount > 0 ? `<p class="text-xs"><em>Usuarios omitidos (sin email o error): ${skippedCount}</em></p>` : ''}
                                            ${errors.length > 0 ? `
                                                <details class="mt-2">
                                                    <summary class="cursor-pointer text-xs">Ver errores (${errors.length})</summary>
                                                    <ul class="text-xs mt-1 ml-4 list-disc">
                                                        ${errors.map(err => `<li>${err}</li>`).join('')}
                                                    </ul>
                                                </details>
                                            ` : ''}
                                        </div>
                                    </div>
                                `;
                                submitBtn.disabled = false;
                                progressContainer.classList.add('hidden');
                                setTimeout(() => {
                                    closeEmailModal();
                                }, 3000);
                            }, 1000);
                        }
                    }
                }
            }

        } catch (error) {
            console.error('Error:', error);
            messageDiv.innerHTML = '<div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">Error de conexión al enviar tickets por Email</div>';
            submitBtn.disabled = false;
            progressContainer.classList.add('hidden');
        }
    });

    // Cerrar modal al hacer clic fuera de él
    const emailModal = document.getElementById('emailModal');
    window.addEventListener('click', function(event) {
        if (event.target == emailModal) {
            closeEmailModal();
        }
    });

    // ============================================
    // Fin de funciones para Email Modal
    // ============================================

    // Función de búsqueda y filtrado
    function filterTickets() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const eventFilter = document.getElementById('eventFilter').value;
        const validationModeFilter = document.getElementById('validationModeFilter')?.value || 'all';
        const tbody = document.getElementById('ticketsTableBody');
        const rows = tbody.getElementsByTagName('tr');

        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];

            // Saltar el mensaje de "no resultados" si existe
            if (row.id === 'noResultsMessage') continue;

            const cells = row.getElementsByTagName('td');

            if (cells.length === 0) continue;

            // Obtener texto de las columnas relevantes (cells[0] es el checkbox ahora)
            const id = cells[1] ? cells[1].textContent.toLowerCase() : '';
            const userName = cells[2] ? cells[2].textContent.toLowerCase() : '';
            const eventName = cells[3] ? cells[3].textContent.toLowerCase() : '';
            const ticketCode = cells[6] ? cells[6].textContent.toLowerCase() : '';

            // Verificar estado (buscar si tiene el badge de "Usado")
            const statusCell = cells[8];
            const isUsed = statusCell ? statusCell.innerHTML.includes('Usado') : false;

            // Verificar modo de validación (buscar "Diario" o "Una vez")
            const modeCell = cells[5];
            const isDaily = modeCell ? modeCell.textContent.includes('Diario') : false;
            const isOnce = modeCell ? modeCell.textContent.includes('Una vez') : false;

            // Obtener event_id del data attribute
            const rowEventId = row.getAttribute('data-event-id');

            // Filtrar por texto de búsqueda
            const matchesSearch = searchInput === '' ||
                userName.includes(searchInput) ||
                eventName.includes(searchInput) ||
                ticketCode.includes(searchInput) ||
                id.includes(searchInput);

            // Filtrar por estado
            const matchesStatusFilter =
                statusFilter === 'all' ||
                (statusFilter === 'available' && !isUsed) ||
                (statusFilter === 'used' && isUsed);

            // Filtrar por evento
            const matchesEventFilter =
                eventFilter === 'all' ||
                rowEventId === eventFilter;

            // Filtrar por modo de validación
            const matchesValidationMode =
                validationModeFilter === 'all' ||
                (validationModeFilter === 'daily' && isDaily) ||
                (validationModeFilter === 'once' && isOnce);

            // Mostrar u ocultar fila
            if (matchesSearch && matchesStatusFilter && matchesEventFilter && matchesValidationMode) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        // Mostrar mensaje si no hay resultados
        showFilterMessage(visibleCount);
    }

    function showFilterMessage(count) {
        const tbody = document.getElementById('ticketsTableBody');
        let messageRow = document.getElementById('noResultsMessage');

        if (count === 0) {
            // Si no hay resultados y no existe el mensaje, crearlo
            if (!messageRow) {
                messageRow = document.createElement('tr');
                messageRow.id = 'noResultsMessage';
                messageRow.innerHTML = `
                    <td colspan="8" class="p-8 text-center text-muted-foreground">
                        <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        No se encontraron tickets que coincidan con tu búsqueda
                    </td>
                `;
                tbody.appendChild(messageRow);
            }
        } else {
            // Si hay resultados, eliminar el mensaje si existe
            if (messageRow) {
                messageRow.parentNode.removeChild(messageRow);
            }
        }
    }

    // Función de ordenamiento
    let sortDirection = {};

    function sortTable(columnIndex) {
        const tbody = document.getElementById('ticketsTableBody');
        const rows = Array.from(tbody.getElementsByTagName('tr')).filter(row =>
            row.id !== 'noResultsMessage' && row.style.display !== 'none'
        );

        // Determinar dirección de ordenamiento
        if (!sortDirection[columnIndex]) {
            sortDirection[columnIndex] = 'asc';
        } else {
            sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
        }

        const direction = sortDirection[columnIndex];

        rows.sort((a, b) => {
            const cellA = a.getElementsByTagName('td')[columnIndex];
            const cellB = b.getElementsByTagName('td')[columnIndex];

            let valueA = cellA ? cellA.textContent.trim() : '';
            let valueB = cellB ? cellB.textContent.trim() : '';

            // Para columna ID (numérica)
            if (columnIndex === 1) {
                valueA = parseInt(valueA) || 0;
                valueB = parseInt(valueB) || 0;
            }

            // Para columna de fecha (convertir a timestamp para comparar)
            if (columnIndex === 7) {
                valueA = valueA ? new Date(valueA.split('/').reverse().join('-')).getTime() : 0;
                valueB = valueB ? new Date(valueB.split('/').reverse().join('-')).getTime() : 0;
            }

            // Comparación
            if (valueA < valueB) {
                return direction === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return direction === 'asc' ? 1 : -1;
            }
            return 0;
        });

        // Reordenar las filas en el DOM
        rows.forEach(row => tbody.appendChild(row));
    }
</script>

<!-- Modal para cambiar modo de validación -->
<!-- AGREGAR ESTE FRAGMENTO AL ARCHIVO tickets.html ANTES DEL TAG </div> FINAL -->

<div id="validationModeModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="rounded-lg border bg-card text-card-foreground shadow-lg w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <h3 class="text-2xl font-semibold leading-none tracking-tight">Gestionar Modo de Validación</h3>
            <p class="text-sm text-muted-foreground">Cambia cómo se validan los tickets: una vez total o una vez por día</p>
        </div>

        <div class="p-6 space-y-6">
            <!-- Selector de método -->
            <div class="space-y-4">
                <label class="text-sm font-medium">Selecciona el método de cambio:</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="selectValidationMethod('event')" id="methodEventBtn" class="p-4 border-2 border-purple-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-left">
                        <div class="flex items-start gap-3">
                            <svg class="h-6 w-6 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <div class="flex-1">
                                <div class="font-semibold">Por Evento Completo</div>
                                <div class="text-sm text-muted-foreground">Cambiar todos los tickets de un evento específico</div>
                            </div>
                        </div>
                    </button>

                    <button onclick="selectValidationMethod('selected')" id="methodSelectedBtn" class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-left">
                        <div class="flex items-start gap-3">
                            <svg class="h-6 w-6 text-purple-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                            </svg>
                            <div class="flex-1">
                                <div class="font-semibold">Tickets Seleccionados</div>
                                <div class="text-sm text-muted-foreground">Cambiar solo los tickets que marques en la tabla</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Formulario para evento completo -->
            <div id="eventMethodForm" class="space-y-4">
                <div>
                    <label class="text-sm font-medium">Selecciona el evento:</label>
                    <select id="validationEventSelect" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring mt-2">
                        <option value="">-- Selecciona un evento --</option>
                        {% for event in events %}
                        <option value="{{ event.id }}">{{ event.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Estadísticas del evento -->
                <div id="eventStats" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-4 space-y-2">
                    <div class="font-semibold text-blue-900">Estadísticas del Evento</div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                        <div>
                            <div class="text-muted-foreground">Total Tickets</div>
                            <div class="text-lg font-bold text-blue-700" id="statTotal">-</div>
                        </div>
                        <div>
                            <div class="text-muted-foreground">Modo 'Once'</div>
                            <div class="text-lg font-bold text-orange-600" id="statOnce">-</div>
                        </div>
                        <div>
                            <div class="text-muted-foreground">Modo 'Daily'</div>
                            <div class="text-lg font-bold text-green-600" id="statDaily">-</div>
                        </div>
                        <div>
                            <div class="text-muted-foreground">Validados</div>
                            <div class="text-lg font-bold text-purple-600" id="statValidated">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información para tickets seleccionados -->
            <div id="selectedMethodInfo" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div class="flex items-start gap-2">
                    <svg class="h-5 w-5 text-yellow-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="flex-1">
                        <div class="font-semibold text-yellow-900">Marca los tickets en la tabla</div>
                        <div class="text-sm text-yellow-700">Usa los checkboxes en la tabla principal para seleccionar los tickets que deseas modificar</div>
                        <div class="mt-2 font-medium text-yellow-900">Tickets seleccionados: <span id="selectedCount">0</span></div>
                    </div>
                </div>
            </div>

            <!-- Selector de modo de validación -->
            <div class="space-y-3">
                <label class="text-sm font-medium">Nuevo modo de validación:</label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="selectValidationMode('once')" id="modeOnceBtn" class="p-4 border-2 border-orange-200 bg-orange-50 rounded-lg hover:border-orange-500 transition-all text-left">
                        <div class="flex items-start gap-3">
                            <svg class="h-6 w-6 text-orange-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="flex-1">
                                <div class="font-semibold text-orange-900">Modo 'Once' (Una vez)</div>
                                <div class="text-sm text-orange-700">El ticket solo se puede validar UNA VEZ durante todo el evento</div>
                                <div class="text-xs text-orange-600 mt-1">✓ Ideal para eventos de 1 día o acceso único</div>
                            </div>
                        </div>
                    </button>

                    <button onclick="selectValidationMode('daily')" id="modeDailyBtn" class="p-4 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all text-left">
                        <div class="flex items-start gap-3">
                            <svg class="h-6 w-6 text-green-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>
                            <div class="flex-1">
                                <div class="font-semibold text-green-900">Modo 'Daily' (Diario)</div>
                                <div class="text-sm text-green-700">El ticket se puede validar UNA VEZ POR DÍA durante el evento</div>
                                <div class="text-xs text-green-600 mt-1">✓ Ideal para conferencias multi-día, talleres de varios días</div>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Mensaje de confirmación -->
            <div id="validationMessage" class="hidden"></div>
        </div>

        <div class="flex items-center p-6 border-t gap-2">
            <button type="button" onclick="closeValidationModeModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                Cancelar
            </button>
            <button id="applyValidationModeBtn" onclick="applyValidationMode()" disabled class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-purple-600 text-white hover:bg-purple-700 h-10 px-4 py-2">
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Aplicar Cambios
            </button>
        </div>
    </div>
</div>

<script>
// Variables globales para el modal de validación
let validationMethod = 'event'; // 'event' o 'selected'
let validationMode = 'once'; // 'once' o 'daily'
let selectedTicketIds = [];

function openValidationModeModal() {
    document.getElementById('validationModeModal').classList.remove('hidden');
    validationMethod = 'event';
    validationMode = 'once';
    selectValidationMethod('event');
    selectValidationMode('once');
    updateApplyButton();
}

function closeValidationModeModal() {
    document.getElementById('validationModeModal').classList.add('hidden');
    document.getElementById('validationMessage').classList.add('hidden');
    document.getElementById('eventStats').classList.add('hidden');
}

function selectValidationMethod(method) {
    validationMethod = method;

    // Actualizar botones de método
    document.getElementById('methodEventBtn').className = method === 'event'
        ? 'p-4 border-2 border-purple-500 bg-purple-50 rounded-lg transition-all text-left'
        : 'p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-left';

    document.getElementById('methodSelectedBtn').className = method === 'selected'
        ? 'p-4 border-2 border-purple-500 bg-purple-50 rounded-lg transition-all text-left'
        : 'p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-left';

    // Mostrar/ocultar formularios
    if (method === 'event') {
        document.getElementById('eventMethodForm').classList.remove('hidden');
        document.getElementById('selectedMethodInfo').classList.add('hidden');
    } else {
        document.getElementById('eventMethodForm').classList.add('hidden');
        document.getElementById('selectedMethodInfo').classList.remove('hidden');
        updateSelectedCount();
    }

    updateApplyButton();
}

function selectValidationMode(mode) {
    validationMode = mode;

    // Actualizar botones de modo
    document.getElementById('modeOnceBtn').className = mode === 'once'
        ? 'p-4 border-2 border-orange-500 bg-orange-50 rounded-lg transition-all text-left'
        : 'p-4 border-2 border-gray-200 rounded-lg hover:border-orange-500 hover:bg-orange-50 transition-all text-left';

    document.getElementById('modeDailyBtn').className = mode === 'daily'
        ? 'p-4 border-2 border-green-500 bg-green-50 rounded-lg transition-all text-left'
        : 'p-4 border-2 border-gray-200 rounded-lg hover:border-green-500 hover:bg-green-50 transition-all text-left';

    updateApplyButton();
}

function updateSelectedCount() {
    selectedTicketIds = Array.from(document.querySelectorAll('input[name="ticketSelect"]:checked'))
        .map(cb => parseInt(cb.value));
    document.getElementById('selectedCount').textContent = selectedTicketIds.length;
    updateApplyButton();
}

function updateApplyButton() {
    const btn = document.getElementById('applyValidationModeBtn');
    let enabled = false;

    if (validationMethod === 'event') {
        const eventId = document.getElementById('validationEventSelect').value;
        enabled = eventId !== '';
    } else if (validationMethod === 'selected') {
        enabled = selectedTicketIds.length > 0;
    }

    btn.disabled = !enabled;
}

// Cargar estadísticas cuando se selecciona un evento
document.getElementById('validationEventSelect')?.addEventListener('change', async function() {
    const eventId = this.value;
    if (!eventId) {
        document.getElementById('eventStats').classList.add('hidden');
        updateApplyButton();
        return;
    }

    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/events/${eventId}/validation-stats`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            const data = await response.json();
            document.getElementById('statTotal').textContent = data.total_tickets;
            document.getElementById('statOnce').textContent = data.validation_modes.once;
            document.getElementById('statDaily').textContent = data.validation_modes.daily;
            document.getElementById('statValidated').textContent = data.validations.validated_tickets;
            document.getElementById('eventStats').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading event stats:', error);
    }

    updateApplyButton();
});

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll').checked;
    document.querySelectorAll('input[name="ticketSelect"]').forEach(cb => {
        cb.checked = selectAll;
    });
    updateSelectedCount();
}

function updateSelectedCount() {
    const selected = document.querySelectorAll('input[name="ticketSelect"]:checked');
    const count = selected.length;

    // Actualizar el array de IDs seleccionados
    selectedTicketIds = Array.from(selected).map(cb => parseInt(cb.value));

    // Actualizar el contador en el modal
    const countElement = document.getElementById('selectedCount');
    if (countElement) {
        countElement.textContent = count;
    }

    // Actualizar el botón de aplicar si el método es 'selected'
    if (validationMethod === 'selected') {
        updateApplyButton();
    }
}

async function applyValidationMode() {
    const btn = document.getElementById('applyValidationModeBtn');
    const messageDiv = document.getElementById('validationMessage');

    btn.disabled = true;
    messageDiv.classList.remove('hidden');
    messageDiv.innerHTML = `
        <div class="rounded-lg border border-blue-200 bg-blue-50 p-4 text-sm text-blue-700">
            <div class="flex items-center gap-2">
                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-700"></div>
                <span>Aplicando cambios...</span>
            </div>
        </div>
    `;

    try {
        const token = localStorage.getItem('access_token');
        let url, body;

        if (validationMethod === 'event') {
            const eventId = document.getElementById('validationEventSelect').value;
            url = `/events/${eventId}/change-validation-mode`;
            body = { validation_mode: validationMode };
        } else {
            url = '/tickets/batch-change-validation-mode';
            body = {
                validation_mode: validationMode,
                ticket_ids: selectedTicketIds
            };
        }

        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok && data.success) {
            messageDiv.innerHTML = `
                <div class="rounded-lg border border-green-200 bg-green-50 p-4 text-sm text-green-700">
                    <div class="font-semibold mb-2">✅ ${data.message}</div>
                    <div class="text-xs space-y-1">
                        <div>• ${data.updated_count} tickets actualizados</div>
                        <div>• Nuevo modo: <strong>${data.validation_mode}</strong></div>
                    </div>
                </div>
            `;

            // Recargar la página después de 2 segundos
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            messageDiv.innerHTML = `
                <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
                    Error: ${data.detail || 'No se pudieron aplicar los cambios'}
                </div>
            `;
            btn.disabled = false;
        }
    } catch (error) {
        messageDiv.innerHTML = `
            <div class="rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-700">
                Error: ${error.message}
            </div>
        `;
        btn.disabled = false;
    }
}

</script>
{% endblock %}
