{% extends "base.html" %}

{% block title %}Usuarios - IEEE Tadeo Control System{% endblock %}

{% block content %}
<div class="rounded-lg border bg-card text-card-foreground shadow-sm">
    <div class="flex flex-col space-y-1.5 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-semibold leading-none tracking-tight">GestiÃ³n de Usuarios</h3>
                <p class="text-sm text-muted-foreground mt-1">Administra los usuarios registrados en el sistema</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openImportModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Importar Usuarios
                </button>
                <button onclick="openModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                    <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Registrar Usuario
                </button>
            </div>
        </div>

        <!-- Barra de bÃºsqueda y filtros -->
        <div class="mt-4 flex gap-4 items-center">
            <div class="flex-1 relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Buscar por nombre, email, cÃ©dula o universidad..."
                    class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                    onkeyup="filterUsers()"
                >
            </div>
            <select id="ieeeFilter" onchange="filterUsers()" class="flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="all">Todos los usuarios</option>
                <option value="ieee">Solo miembros IEEE</option>
                <option value="non-ieee">Solo no miembros IEEE</option>
            </select>
        </div>
    </div>
    <div class="p-6 pt-0">
        {% if users %}
        <div class="relative w-full overflow-auto">
            <table class="w-full caption-bottom text-sm">
                <thead class="[&_tr]:border-b">
                    <tr class="border-b transition-colors hover:bg-muted/50">
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(0)">
                            <div class="flex items-center gap-1">
                                ID
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(1)">
                            <div class="flex items-center gap-1">
                                Nombre
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(2)">
                            <div class="flex items-center gap-1">
                                Email
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">CÃ©dula</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(4)">
                            <div class="flex items-center gap-1">
                                Universidad
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">Etiquetas</th>
                        <th class="h-12 px-4 text-center align-middle font-medium text-muted-foreground">IEEE</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground">TelÃ©fono</th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(7)">
                            <div class="flex items-center gap-1">
                                Tickets
                                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                </svg>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-left align-middle font-medium text-muted-foreground cursor-pointer hover:text-foreground" onclick="sortTable(8)">
                            <div class="flex items-center gap-2">
                                <div class="flex items-center gap-1">
                                    CumpleaÃ±os
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                    </svg>
                                </div>
                                <button id="birthdayCheckInfo" onclick="showBirthdayCheckModal()" class="inline-flex items-center justify-center rounded-full text-xs bg-blue-100 text-blue-800 hover:bg-blue-200 h-5 px-2 transition-colors" title="Ver Ãºltima verificaciÃ³n automÃ¡tica">
                                    <svg class="h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span id="lastCheckBadge">...</span>
                                </button>
                            </div>
                        </th>
                        <th class="h-12 px-4 text-right align-middle font-medium text-muted-foreground">Acciones</th>
                    </tr>
                </thead>
                <tbody class="[&_tr:last-child]:border-0" id="usersTableBody">
                    {% for user in users %}
                    <tr class="border-b transition-colors hover:bg-muted/50">
                        <td class="p-2 align-middle">{{ user.id }}</td>
                        <td class="p-2 align-middle font-medium">
                            <div class="flex items-center gap-2">
                                {% if user.photo_path %}
                                <img src="{{ user.photo_path }}" alt="" class="w-8 h-8 rounded-full object-cover border border-gray-200">
                                {% else %}
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-xs font-bold">
                                    {{ user.name[0].upper() if user.name else '?' }}
                                </div>
                                {% endif %}
                                <div class="flex flex-col">
                                    <span>{{ user.name }}</span>
                                    {% if user.branch_role %}
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold bg-purple-100 text-purple-800 w-fit">
                                        {% set role_labels = {
                                            'presidente': 'Presidente/a',
                                            'vicepresidente': 'Vicepresidente/a',
                                            'secretario': 'Secretario/a',
                                            'tesorero': 'Tesorero/a',
                                            'webmaster': 'Webmaster',
                                            'consejero': 'Consejero/a',
                                            'mentor': 'Mentor/a'
                                        } %}
                                        {{ role_labels.get(user.branch_role, user.branch_role | replace('_', ' ') | title) }}
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </td>
                        <td class="p-2 align-middle">{{ user.email }}</td>
                        <td class="p-2 align-middle text-muted-foreground">{{ user.identification or '-' }}</td>
                        <td class="p-2 align-middle text-muted-foreground" title="{{ user.university.name if user.university else '' }}">
                            {{ user.university.short_name if user.university and user.university.short_name else (user.university.name if user.university else '-') }}
                        </td>
                        <td class="p-2 align-middle">
                            <div class="flex flex-wrap gap-1">
                                {% if user.tags %}
                                    {% for tag in user.tags %}
                                    <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold" style="background-color: {{ tag.color }}22; color: {{ tag.color }}; border: 1px solid {{ tag.color }}44;" title="{{ tag.description or tag.name }}">
                                        {{ tag.name }}
                                    </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-muted-foreground text-xs">-</span>
                                {% endif %}
                            </div>
                        </td>
                        <td class="p-2 align-middle text-center">
                            {% if user.is_ieee_member %}
                            <span class="inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-semibold bg-blue-100 text-blue-800 border-blue-200">
                                âœ“
                            </span>
                            {% else %}
                            <span class="text-muted-foreground">-</span>
                            {% endif %}
                        </td>
                        <td class="p-2 align-middle text-muted-foreground">{{ user.phone or '-' }}</td>
                        <td class="p-2 align-middle">
                            <span class="inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 border-transparent bg-primary text-primary-foreground">
                                {{ user.ticket_count }}
                            </span>
                        </td>
                        <td class="p-2 align-middle">
                            <div class="flex items-center gap-2">
                                <div class="flex-1">
                                    {% if user.birthday_status and user.birthday_status['days_until'] is not none %}
                                        {% if user.birthday_status['is_today'] %}
                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-semibold">
                                                Hoy
                                            </span>
                                        {% elif user.birthday_status['is_this_week'] %}
                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-yellow-100 text-yellow-800 text-xs font-semibold">
                                                En {{ user.birthday_status['days_until'] }} dÃ­a{% if user.birthday_status['days_until'] != 1 %}s{% endif %}
                                            </span>
                                        {% elif user.birthday_status['is_this_month'] %}
                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md bg-blue-100 text-blue-800 text-xs font-medium">
                                                En {{ user.birthday_status['days_until'] }} dÃ­as
                                            </span>
                                        {% else %}
                                            <span class="text-muted-foreground text-xs">
                                                {{ user.birthday_status['date_str'] }}
                                            </span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted-foreground text-xs">-</span>
                                    {% endif %}
                                </div>
                                {% if user.birthday %}
                                    <button onclick="sendBirthdayGreeting({{ user.id }}, '{{ user.name }}')" class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-green-600 text-white hover:bg-green-700 h-6 w-6" title="Enviar felicitaciÃ³n (Email + WhatsApp)">
                                        ðŸŽ‚
                                    </button>
                                {% endif %}
                            </div>
                        </td>
                        <td class="p-2 align-middle text-right">
                            <div class="flex justify-end gap-1">
                                <button onclick="viewUser({{ user.id }})" class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7" title="Ver ficha del usuario">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                                <button onclick="editUser({{ user.id }}, '{{ user.name|e }}', '{{ (user.nick or '')|e }}', '{{ user.email|e }}', '{{ (user.identification or '')|e }}', {{ user.university_id or 'null' }}, '{{ (user.country_code or '+57')|e }}', '{{ (user.phone or '')|e }}', {{ 'true' if user.is_ieee_member else 'false' }}, '{{ user.birthday.strftime('%Y-%m-%d') if user.birthday else '' }}', '{{ (user.email_personal or '')|e }}', '{{ (user.email_institutional or '')|e }}', '{{ (user.email_ieee or '')|e }}', '{{ (user.primary_email_type or 'email')|e }}', '{{ (user.branch_role or '')|e }}')" class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7" title="Editar usuario">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteUser({{ user.id }}, '{{ user.name }}', {{ user.ticket_count }})" class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors focus-visible:outline-none disabled:pointer-events-none disabled:opacity-50 bg-destructive text-destructive-foreground hover:bg-destructive/90 h-7 w-7" title="Eliminar usuario">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="flex flex-col items-center justify-center py-8 text-center">
            <svg class="h-12 w-12 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
            </svg>
            <p class="text-muted-foreground">No hay usuarios registrados</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal para crear/editar usuario -->
<div id="userModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h3 id="modalTitle" class="text-lg font-semibold leading-none tracking-tight">Registrar Nuevo Usuario</h3>
                <button onclick="closeModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="userForm" class="space-y-4">
                <input type="hidden" id="userId" name="userId">
                <div class="space-y-2">
                    <label for="name" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Nombre Completo *</label>
                    <input type="text" id="name" name="name" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>

                <div class="space-y-2">
                    <label for="nick" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Apodo / Nick</label>
                    <input type="text" id="nick" name="nick" placeholder="Forma corta de llamar (opcional)" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>

                <!-- Email Principal - solo visible en modo creaciÃ³n -->
                <div id="emailPrincipalGroup" class="space-y-2">
                    <label for="email" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Email Principal *</label>
                    <input type="email" id="email" name="email" required class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>

                <!-- Emails adicionales (solo visibles en modo ediciÃ³n) -->
                <div id="additionalEmails" class="hidden space-y-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between">
                        <p class="text-sm font-medium text-gray-700">Correos ElectrÃ³nicos</p>
                        <span class="text-xs text-gray-500">â˜… = Email para OTP</span>
                    </div>

                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="radio" id="primary_email_personal" name="primary_email_type" value="email_personal" class="text-primary focus:ring-primary">
                            <label for="email_personal" class="text-xs font-medium leading-none text-gray-600 flex-1">Email Personal</label>
                        </div>
                        <input type="email" id="email_personal" name="email_personal" placeholder="correo@gmail.com" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    </div>

                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="radio" id="primary_email_institutional" name="primary_email_type" value="email_institutional" class="text-primary focus:ring-primary">
                            <label for="email_institutional" class="text-xs font-medium leading-none text-gray-600 flex-1">Email Institucional</label>
                        </div>
                        <input type="email" id="email_institutional" name="email_institutional" placeholder="correo@universidad.edu.co" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    </div>

                    <div class="space-y-2">
                        <div class="flex items-center gap-2">
                            <input type="radio" id="primary_email_ieee" name="primary_email_type" value="email_ieee" class="text-primary focus:ring-primary">
                            <label for="email_ieee" class="text-xs font-medium leading-none text-gray-600 flex-1">Email IEEE</label>
                        </div>
                        <input type="email" id="email_ieee" name="email_ieee" placeholder="correo@ieee.org" class="flex h-9 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    </div>

                    <p class="text-xs text-muted-foreground mt-2">Selecciona el radio del correo que recibirÃ¡ los cÃ³digos OTP</p>
                </div>

                <div class="space-y-2">
                    <label for="identification" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">CÃ©dula</label>
                    <input type="text" id="identification" name="identification" placeholder="NÃºmero de identificaciÃ³n" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>

                <div class="space-y-2">
                    <label for="university_id" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Universidad</label>
                    <select id="university_id" name="university_id" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Seleccione una universidad</option>
                    </select>
                </div>

                <div class="space-y-2">
                    <label for="phone" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">TelÃ©fono</label>
                    <div class="flex gap-2">
                        <select id="country_code" name="country_code" class="flex h-10 w-32 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            <option value="+57">ðŸ‡¨ðŸ‡´ +57</option>
                            <option value="+1">ðŸ‡ºðŸ‡¸ +1</option>
                            <option value="+52">ðŸ‡²ðŸ‡½ +52</option>
                            <option value="+54">ðŸ‡¦ðŸ‡· +54</option>
                            <option value="+55">ðŸ‡§ðŸ‡· +55</option>
                            <option value="+56">ðŸ‡¨ðŸ‡± +56</option>
                            <option value="+51">ðŸ‡µðŸ‡ª +51</option>
                            <option value="+58">ðŸ‡»ðŸ‡ª +58</option>
                            <option value="+593">ðŸ‡ªðŸ‡¨ +593</option>
                            <option value="+591">ðŸ‡§ðŸ‡´ +591</option>
                            <option value="+595">ðŸ‡µðŸ‡¾ +595</option>
                            <option value="+598">ðŸ‡ºðŸ‡¾ +598</option>
                            <option value="+507">ðŸ‡µðŸ‡¦ +507</option>
                            <option value="+506">ðŸ‡¨ðŸ‡· +506</option>
                            <option value="+503">ðŸ‡¸ðŸ‡» +503</option>
                            <option value="+502">ðŸ‡¬ðŸ‡¹ +502</option>
                            <option value="+504">ðŸ‡­ðŸ‡³ +504</option>
                            <option value="+505">ðŸ‡³ðŸ‡® +505</option>
                            <option value="+53">ðŸ‡¨ðŸ‡º +53</option>
                            <option value="+34">ðŸ‡ªðŸ‡¸ +34</option>
                        </select>
                        <input type="tel" id="phone" name="phone" placeholder="3001234567" class="flex h-10 flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                    </div>
                </div>

                <div class="space-y-2">
                    <label for="birthday" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Fecha de CumpleaÃ±os</label>
                    <input type="date" id="birthday" name="birthday" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                </div>

                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="is_ieee_member" name="is_ieee_member" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <label for="is_ieee_member" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                        Miembro activo de IEEE
                    </label>
                </div>

                <div class="space-y-2">
                    <label for="branch_role" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Rol en la Rama</label>
                    <select id="branch_role" name="branch_role" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                        <option value="">Sin rol asignado</option>
                        <option value="presidente">Presidente/a</option>
                        <option value="vicepresidente">Vicepresidente/a</option>
                        <option value="secretario">Secretario/a</option>
                        <option value="tesorero">Tesorero/a</option>
                        <option value="webmaster">Webmaster</option>
                        <option value="consejero">Consejero/a</option>
                        <option value="mentor">Mentor/a</option>
                    </select>
                </div>

                <button type="submit" id="submitBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                    Registrar Usuario
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para informaciÃ³n de verificaciÃ³n de cumpleaÃ±os -->
<div id="birthdayCheckModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold leading-none tracking-tight">Sistema de CumpleaÃ±os</h3>
                <button onclick="closeBirthdayCheckModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div id="birthdayCheckContent" class="space-y-4">
                <!-- Content will be populated by JavaScript -->
            </div>
            <div class="mt-6 flex gap-2">
                <button onclick="runBirthdayCheckNow()" id="runCheckBtn" class="flex-1 inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                    <svg class="h-4 w-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Ejecutar VerificaciÃ³n Ahora
                </button>
                <button onclick="closeBirthdayCheckModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                    Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para importar usuarios desde CSV -->
<div id="importModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold leading-none tracking-tight">Importar Usuarios desde CSV</h3>
                <button onclick="closeImportModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="importForm" class="space-y-4">
                <!-- Instrucciones -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm">
                    <p class="font-semibold text-blue-900 mb-2">ðŸ“‹ Formato CSV esperado:</p>
                    <code class="block bg-white p-2 rounded text-xs overflow-x-auto">
                        name,email,phone,country_code,identification,university_name,is_ieee_member,ieee_member_id
                    </code>
                    <p class="text-blue-700 mt-2 text-xs">
                        <strong>Campos obligatorios:</strong> name, email, phone<br>
                        <strong>Campos opcionales:</strong> country_code, identification, university_name, is_ieee_member, ieee_member_id<br>
                        <strong>DetecciÃ³n de duplicados:</strong> Por email (se agregarÃ¡ el tag sin eliminar los existentes)
                    </p>
                </div>

                <!-- Tabs para seleccionar mÃ©todo de importaciÃ³n -->
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px space-x-8">
                        <button type="button" id="fileTab" onclick="switchImportMethod('file')" class="border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium">
                            Subir Archivo
                        </button>
                        <button type="button" id="pasteTab" onclick="switchImportMethod('paste')" class="border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium">
                            Pegar Texto
                        </button>
                    </nav>
                </div>

                <!-- Contenido del tab de archivo -->
                <div id="fileContent" class="space-y-2">
                    <label for="csvFile" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Archivo CSV *</label>
                    <input
                        type="file"
                        id="csvFile"
                        name="csvFile"
                        accept=".csv"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
                    >
                </div>

                <!-- Contenido del tab de texto -->
                <div id="pasteContent" class="hidden space-y-2">
                    <label for="csvText" class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">Datos CSV *</label>
                    <textarea
                        id="csvText"
                        name="csvText"
                        rows="8"
                        placeholder="name,email,phone,country_code,identification,university_name,is_ieee_member,ieee_member_id&#10;MarÃ­a GarcÃ­a,maria@ieee.org,3001234567,+57,1234567890,Universidad Nacional,true,12345678&#10;Carlos RodrÃ­guez,carlos@ieee.org,3009876543,+57,9876543210,Universidad de los Andes,false,"
                        class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 font-mono text-xs"
                    ></textarea>
                    <p class="text-xs text-muted-foreground">Pegue los datos CSV incluyendo la lÃ­nea de encabezados</p>
                </div>

                <!-- Selector de tag con opciÃ³n de crear nuevo -->
                <div class="space-y-2">
                    <label class="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70">
                        Etiqueta a asignar *
                    </label>

                    <div class="flex gap-2">
                        <select id="importTag" name="importTag" onchange="handleTagSelection()" class="flex h-10 flex-1 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                            <option value="">Seleccione una etiqueta</option>
                            <option value="__new__">+ Crear nueva etiqueta</option>
                        </select>
                    </div>

                    <!-- Formulario para crear nuevo tag (oculto por defecto) -->
                    <div id="newTagForm" class="hidden mt-3 p-4 bg-gray-50 border border-gray-200 rounded-lg space-y-3">
                        <div class="space-y-2">
                            <label for="newTagName" class="text-sm font-medium">Nombre de la etiqueta *</label>
                            <input
                                type="text"
                                id="newTagName"
                                placeholder="Ej: IEEE WIE, Hackathon 2025"
                                class="flex h-10 w-full rounded-md border border-input bg-white px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                            >
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="space-y-2">
                                <label for="newTagColor" class="text-sm font-medium">Color</label>
                                <input
                                    type="color"
                                    id="newTagColor"
                                    value="#3B82F6"
                                    class="h-10 w-full rounded-md border border-input"
                                >
                            </div>
                            <div class="flex items-end">
                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <div id="newTagPreview" class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold" style="background-color: #3B82F622; color: #3B82F6; border: 1px solid #3B82F644;">
                                        Vista previa
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label for="newTagDescription" class="text-sm font-medium">DescripciÃ³n (opcional)</label>
                            <input
                                type="text"
                                id="newTagDescription"
                                placeholder="Breve descripciÃ³n de la etiqueta"
                                class="flex h-10 w-full rounded-md border border-input bg-white px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                            >
                        </div>
                    </div>

                    <p class="text-xs text-muted-foreground">Esta etiqueta se asignarÃ¡ a todos los usuarios importados</p>
                </div>

                <!-- Progreso -->
                <div id="importProgress" class="hidden space-y-2">
                    <div class="flex items-center justify-between text-sm">
                        <span id="importProgressText">Procesando...</span>
                        <span id="importProgressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="importProgressBar" class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Resultado -->
                <div id="importResult" class="hidden"></div>

                <!-- Botones -->
                <div class="flex gap-2 pt-4">
                    <button type="submit" id="importSubmitBtn" class="flex-1 inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Importar Usuarios
                    </button>
                    <button type="button" onclick="closeImportModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para agregar estudio -->
<div id="addStudyModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
        <div class="flex flex-col space-y-1.5 p-4 border-b bg-purple-600">
            <div class="flex items-center justify-between">
                <h3 class="text-base font-semibold leading-none tracking-tight text-white">Agregar Estudio</h3>
                <button onclick="closeAddStudyModal()" class="rounded-sm text-white opacity-70 transition-opacity hover:opacity-100">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-4 space-y-4">
            <input type="hidden" id="addStudyUserId">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Estudio *</label>
                <select id="addStudyType" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
                    <option value="">Seleccionar...</option>
                    <option value="pregrado">Pregrado</option>
                    <option value="posgrado">Posgrado</option>
                    <option value="otro">Otro (diplomado, certificaciÃ³n, etc.)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Programa *</label>
                <input type="text" id="addStudyProgram" placeholder="Ej: MaestrÃ­a en Ciencia de Datos" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">InstituciÃ³n</label>
                <input type="text" id="addStudyInstitution" placeholder="Universidad de BogotÃ¡ Jorge Tadeo Lozano" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-2 focus:ring-purple-500">
            </div>
            <div class="flex gap-2 pt-2">
                <button type="button" onclick="submitAddStudy()" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md text-sm font-medium hover:bg-purple-700 transition">
                    Agregar
                </button>
                <button type="button" onclick="closeAddStudyModal()" class="flex-1 border border-gray-300 py-2 px-4 rounded-md text-sm font-medium hover:bg-gray-50 transition">
                    Cancelar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para ver ficha del usuario -->
<div id="viewUserModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-lg max-h-[90vh] overflow-y-auto">
        <div class="flex flex-col space-y-1.5 p-6 border-b bg-gradient-to-r from-blue-600 to-purple-600">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-semibold leading-none tracking-tight text-white">Ficha del Usuario</h3>
                <button onclick="closeViewUserModal()" class="rounded-sm text-white opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6">
            <div id="viewUserContent" class="space-y-4">
                <!-- El contenido se llenarÃ¡ dinÃ¡micamente -->
                <div class="flex items-center justify-center py-8">
                    <svg class="animate-spin h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- NotificaciÃ³n flotante para mensajes -->
<div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] w-11/12 max-w-md shadow-lg rounded-lg transition-all duration-300"></div>
{% endblock %}

{% block extra_js %}
<script>
    let isEditMode = false;
    let universities = [];

    // Cargar universidades al iniciar
    async function loadUniversities() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/universities/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                universities = await response.json();
                populateUniversitySelect();
            }
        } catch (error) {
            console.error('Error al cargar universidades:', error);
        }
    }

    function populateUniversitySelect() {
        const select = document.getElementById('university_id');
        const currentValue = select.value;

        // Limpiar opciones existentes excepto la primera
        select.innerHTML = '<option value="">Seleccione una universidad</option>';

        // Agregar universidades
        universities.forEach(uni => {
            const option = document.createElement('option');
            option.value = uni.id;
            option.textContent = uni.name;
            select.appendChild(option);
        });

        // Restaurar valor si existÃ­a
        if (currentValue) {
            select.value = currentValue;
        }
    }

    // Cargar universidades al cargar la pÃ¡gina
    window.addEventListener('DOMContentLoaded', () => {
        loadUniversities();
        loadBirthdayCheckInfo();
    });

    // FunciÃ³n para mostrar notificaciÃ³n flotante
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const textColor = type === 'success' ? 'text-green-900' : 'text-red-900';

        notification.innerHTML = `
            <div class="border ${bgColor} px-4 py-3 ${textColor} flex items-center justify-between">
                <span class="font-medium">${message}</span>
                <button onclick="hideNotification()" class="ml-4 text-current opacity-70 hover:opacity-100">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;

        notification.classList.remove('hidden');

        // Auto-ocultar despuÃ©s de 3 segundos
        setTimeout(() => {
            hideNotification();
        }, 3000);
    }

    function hideNotification() {
        const notification = document.getElementById('notification');
        notification.classList.add('hidden');
    }

    function openModal() {
        isEditMode = false;
        document.getElementById('modalTitle').textContent = 'Registrar Nuevo Usuario';
        document.getElementById('submitBtn').textContent = 'Registrar Usuario';
        // Mostrar campo Email Principal en modo creaciÃ³n
        document.getElementById('emailPrincipalGroup').classList.remove('hidden');
        document.getElementById('email').required = true;
        // Ocultar secciÃ³n de emails adicionales en modo creaciÃ³n
        document.getElementById('additionalEmails').classList.add('hidden');
        document.getElementById('userModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('userModal').classList.add('hidden');
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        // Restaurar campo Email Principal para prÃ³xima apertura
        document.getElementById('emailPrincipalGroup').classList.remove('hidden');
        document.getElementById('email').required = true;
        // Ocultar y limpiar campos de emails adicionales
        document.getElementById('additionalEmails').classList.add('hidden');
        document.getElementById('email_personal').value = '';
        document.getElementById('email_institutional').value = '';
        document.getElementById('email_ieee').value = '';
        // Limpiar radio buttons
        document.querySelectorAll('input[name="primary_email_type"]').forEach(r => r.checked = false);
        document.getElementById('primary_email_personal').checked = true;
        isEditMode = false;
    }

    document.getElementById('userForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const userId = document.getElementById('userId').value;
        const token = localStorage.getItem('access_token');
        const universityId = document.getElementById('university_id').value;
        const birthdayValue = document.getElementById('birthday').value;

        const formData = {
            name: document.getElementById('name').value,
            nick: document.getElementById('nick').value || null,
            email: document.getElementById('email').value,
            identification: document.getElementById('identification').value || null,
            university_id: universityId ? parseInt(universityId) : null,
            country_code: document.getElementById('country_code').value || '+57',
            phone: document.getElementById('phone').value || null,
            birthday: birthdayValue ? birthdayValue + 'T00:00:00' : null,
            is_ieee_member: document.getElementById('is_ieee_member').checked
        };

        // Agregar campos de email adicionales y branch_role en modo ediciÃ³n
        if (isEditMode) {
            formData.email_personal = document.getElementById('email_personal').value || null;
            formData.email_institutional = document.getElementById('email_institutional').value || null;
            formData.email_ieee = document.getElementById('email_ieee').value || null;
            // Obtener el radio button seleccionado
            const selectedRadio = document.querySelector('input[name="primary_email_type"]:checked');
            formData.primary_email_type = selectedRadio ? selectedRadio.value : 'email_personal';
            // Agregar rol de rama
            formData.branch_role = document.getElementById('branch_role').value || null;
        }

        try {
            let response;
            if (isEditMode && userId) {
                // Actualizar usuario existente
                response = await fetch(`/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            } else {
                // Crear nuevo usuario
                response = await fetch('/users/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            }

            const data = await response.json();

            if (response.ok) {
                const successMessage = isEditMode ? 'âœ“ Usuario actualizado exitosamente' : 'âœ“ Usuario registrado exitosamente';
                showNotification(successMessage, 'success');
                closeModal();
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(`Error: ${data.detail}`, 'error');
            }
        } catch (error) {
            const errorMessage = isEditMode ? 'Error al actualizar usuario' : 'Error al registrar usuario';
            showNotification(errorMessage, 'error');
        }
    });

    function editUser(id, name, nick, email, identification, universityId, countryCode, phone, isIeeeMember, birthday, emailPersonal, emailInstitutional, emailIeee, primaryEmailType, branchRole) {
        isEditMode = true;
        document.getElementById('modalTitle').textContent = 'Editar Usuario';
        document.getElementById('submitBtn').textContent = 'Actualizar Usuario';

        // Llenar el formulario con los datos del usuario
        document.getElementById('userId').value = id;
        document.getElementById('name').value = name;
        document.getElementById('nick').value = nick || '';
        document.getElementById('email').value = email;
        document.getElementById('identification').value = identification || '';
        document.getElementById('university_id').value = universityId || '';
        document.getElementById('country_code').value = countryCode || '+57';
        document.getElementById('phone').value = phone || '';
        document.getElementById('birthday').value = birthday || '';
        document.getElementById('is_ieee_member').checked = isIeeeMember;
        document.getElementById('branch_role').value = branchRole || '';

        // Llenar campos de email adicionales
        document.getElementById('email_personal').value = emailPersonal || '';
        document.getElementById('email_institutional').value = emailInstitutional || '';
        document.getElementById('email_ieee').value = emailIeee || '';

        // Seleccionar el radio del email principal
        const primaryType = primaryEmailType || 'email_personal';
        const radioBtn = document.querySelector(`input[name="primary_email_type"][value="${primaryType}"]`);
        if (radioBtn) {
            radioBtn.checked = true;
        } else {
            // Por defecto seleccionar email_personal
            document.getElementById('primary_email_personal').checked = true;
        }

        // Ocultar campo Email Principal y mostrar secciÃ³n de emails con radios
        document.getElementById('emailPrincipalGroup').classList.add('hidden');
        document.getElementById('email').required = false;
        document.getElementById('additionalEmails').classList.remove('hidden');

        // Abrir el modal
        document.getElementById('userModal').classList.remove('hidden');
    }

    // FunciÃ³n para ver la ficha del usuario
    async function viewUser(userId) {
        const modal = document.getElementById('viewUserModal');
        const content = document.getElementById('viewUserContent');

        // Mostrar modal con loading
        modal.classList.remove('hidden');
        content.innerHTML = `
            <div class="flex items-center justify-center py-8">
                <svg class="animate-spin h-8 w-8 text-primary" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        `;

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/users/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const user = await response.json();
                renderUserCard(user);
                // Cargar estudios del usuario
                loadUserStudies(userId);
            } else {
                content.innerHTML = `
                    <div class="text-center py-8 text-red-600">
                        <p>Error al cargar los datos del usuario</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error:', error);
            content.innerHTML = `
                <div class="text-center py-8 text-red-600">
                    <p>Error de conexiÃ³n</p>
                </div>
            `;
        }
    }

    function renderUserCard(user) {
        const content = document.getElementById('viewUserContent');

        // Formatear fecha de cumpleaÃ±os
        let birthdayStr = '-';
        if (user.birthday) {
            const bd = new Date(user.birthday);
            birthdayStr = bd.toLocaleDateString('es-CO', { day: 'numeric', month: 'long' });
        }

        // Formatear fecha de registro
        const createdAt = new Date(user.created_at);
        const createdAtStr = createdAt.toLocaleDateString('es-CO', { year: 'numeric', month: 'long', day: 'numeric' });

        // Formatear fecha de graduaciÃ³n esperada
        let expectedGradStr = null;
        if (user.expected_graduation) {
            const grad = new Date(user.expected_graduation);
            expectedGradStr = grad.toLocaleDateString('es-CO', { year: 'numeric', month: 'long' });
        }

        // Formatear Ãºltimo login
        let lastLoginStr = null;
        if (user.last_login) {
            const ll = new Date(user.last_login);
            lastLoginStr = ll.toLocaleDateString('es-CO', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
        }

        // Mapeo de etiquetas de roles (igual que en el desplegable)
        const roleLabels = {
            'presidente': 'Presidente/a',
            'vicepresidente': 'Vicepresidente/a',
            'secretario': 'Secretario/a',
            'tesorero': 'Tesorero/a',
            'webmaster': 'Webmaster',
            'consejero': 'Consejero/a',
            'mentor': 'Mentor/a'
        };
        const branchRoleLabel = user.branch_role ? (roleLabels[user.branch_role] || user.branch_role) : null;

        // Verificar si tiene datos de perfilamiento
        const hasAcademicInfo = user.university || user.academic_program || user.semester_range || user.english_level;
        const hasIEEEInfo = user.ieee_membership_status || user.ieee_member_id || (user.ieee_societies && user.ieee_societies.length > 0) || user.ieee_roles_history || user.branch_role;
        const hasSkillsInfo = (user.skills && user.skills.length > 0) || user.interest_area;
        const hasAvailabilityInfo = user.availability_level || user.preferred_channel || user.goals_in_branch;

        content.innerHTML = `
            <!-- Header con nombre y foto -->
            <div class="text-center pb-4 border-b">
                ${user.photo_path ? `
                <img src="${user.photo_path}" alt="${user.name}" class="w-20 h-20 rounded-full object-cover mx-auto mb-3 border-4 border-white shadow-lg">
                ` : `
                <div class="inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 text-white text-2xl font-bold mb-3 shadow-lg">
                    ${user.name.charAt(0).toUpperCase()}
                </div>
                `}
                <h2 class="text-xl font-bold">${user.name}</h2>
                ${user.nick ? `<p class="text-sm text-muted-foreground">"${user.nick}"</p>` : ''}
                <div class="flex flex-wrap justify-center gap-2 mt-2">
                    ${user.is_ieee_member ? `
                        <span class="inline-flex items-center px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-semibold">
                            <svg class="h-3 w-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            Miembro IEEE
                        </span>
                    ` : ''}
                    ${user.profile_completed ? `
                        <span class="inline-flex items-center px-3 py-1 rounded-full bg-green-100 text-green-800 text-xs font-semibold">
                            Perfil completo
                        </span>
                    ` : ''}
                </div>
            </div>

            <!-- InformaciÃ³n de contacto -->
            <div class="space-y-3 pt-4">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Contacto</h4>

                <div class="space-y-2">
                    ${user.email_personal ? `
                    <div class="flex items-start gap-3 p-2 bg-gray-50 rounded-lg">
                        <svg class="h-5 w-5 text-purple-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                                Email Personal
                                ${user.primary_email_type === 'email_personal' ? '<span class="text-yellow-500" title="Email principal para OTP">â˜…</span>' : ''}
                            </p>
                            <p class="text-sm font-medium truncate">${user.email_personal}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${user.email_institutional ? `
                    <div class="flex items-start gap-3 p-2 bg-gray-50 rounded-lg">
                        <svg class="h-5 w-5 text-orange-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                                Email Institucional
                                ${user.primary_email_type === 'email_institutional' ? '<span class="text-yellow-500" title="Email principal para OTP">â˜…</span>' : ''}
                            </p>
                            <p class="text-sm font-medium truncate">${user.email_institutional}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${user.email_ieee ? `
                    <div class="flex items-start gap-3 p-2 bg-gray-50 rounded-lg">
                        <svg class="h-5 w-5 text-blue-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                                Email IEEE
                                ${user.primary_email_type === 'email_ieee' ? '<span class="text-yellow-500" title="Email principal para OTP">â˜…</span>' : ''}
                            </p>
                            <p class="text-sm font-medium truncate">${user.email_ieee}</p>
                        </div>
                    </div>
                    ` : ''}

                    ${user.phone ? `
                    <div class="flex items-start gap-3 p-2 bg-gray-50 rounded-lg">
                        <svg class="h-5 w-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs text-gray-500">TelÃ©fono</p>
                            <p class="text-sm font-medium">${user.country_code || '+57'} ${user.phone}</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>

            <!-- InformaciÃ³n bÃ¡sica -->
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">InformaciÃ³n BÃ¡sica</h4>

                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">CÃ©dula</p>
                        <p class="text-sm font-medium">${user.identification || '-'}</p>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">CumpleaÃ±os</p>
                        <p class="text-sm font-medium">${birthdayStr}</p>
                    </div>
                </div>
            </div>

            <!-- InformaciÃ³n AcadÃ©mica -->
            ${hasAcademicInfo ? `
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">InformaciÃ³n AcadÃ©mica</h4>

                ${user.university ? `
                <div class="p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-600">Universidad</p>
                    <p class="text-sm font-medium text-blue-900">${user.university.name}</p>
                </div>
                ` : ''}

                <div class="grid grid-cols-2 gap-3">
                    ${user.academic_program ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Programa</p>
                        <p class="text-sm font-medium">${user.academic_program.short_name || user.academic_program.name}</p>
                        ${user.academic_program.category ? `<p class="text-xs text-gray-400">${user.academic_program.category}</p>` : ''}
                    </div>
                    ` : ''}

                    ${user.semester_range ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Semestre</p>
                        <p class="text-sm font-medium">${user.semester_range.name}</p>
                    </div>
                    ` : ''}

                    ${user.english_level ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Nivel de InglÃ©s</p>
                        <p class="text-sm font-medium">${user.english_level.code ? user.english_level.code + ' - ' : ''}${user.english_level.name}</p>
                    </div>
                    ` : ''}

                    ${expectedGradStr ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">GraduaciÃ³n Esperada</p>
                        <p class="text-sm font-medium">${expectedGradStr}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}

            <!-- Otros Estudios -->
            <div class="space-y-3 pt-4 border-t">
                <div class="flex items-center justify-between">
                    <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Otros Estudios</h4>
                    <button onclick="openAddStudyModal(${user.id})" class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded hover:bg-purple-200 transition">
                        <svg class="inline h-3 w-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        Agregar
                    </button>
                </div>
                <div id="userStudiesList" class="space-y-2">
                    <div class="text-center py-2 text-gray-400 text-sm">
                        <svg class="animate-spin h-4 w-4 mx-auto mb-1" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                        Cargando estudios...
                    </div>
                </div>
            </div>

            <!-- InformaciÃ³n IEEE -->
            ${hasIEEEInfo ? `
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">MembresÃ­a IEEE</h4>

                <div class="grid grid-cols-2 gap-3">
                    ${user.ieee_membership_status ? `
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-600">Estado</p>
                        <p class="text-sm font-medium text-blue-900">${user.ieee_membership_status.name}</p>
                    </div>
                    ` : ''}

                    ${user.ieee_member_id ? `
                    <div class="p-3 bg-blue-50 rounded-lg">
                        <p class="text-xs text-blue-600">ID MembresÃ­a</p>
                        <p class="text-sm font-medium text-blue-900">${user.ieee_member_id}</p>
                    </div>
                    ` : ''}

                    ${user.branch_role ? `
                    <div class="p-3 bg-purple-50 rounded-lg col-span-2">
                        <p class="text-xs text-purple-600">Rol en la Rama</p>
                        <p class="text-sm font-semibold text-purple-900">${branchRoleLabel}</p>
                    </div>
                    ` : ''}
                </div>

                ${user.ieee_societies && user.ieee_societies.length > 0 ? `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500 mb-2">Sociedades de InterÃ©s</p>
                    <div class="flex flex-wrap gap-1">
                        ${user.ieee_societies.map(s => `
                            <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium" style="background-color: ${s.color || '#3B82F6'}22; color: ${s.color || '#3B82F6'};">
                                ${s.code || s.short_name || s.name}
                            </span>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                ${user.ieee_roles_history ? `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-500">Roles Previos en IEEE</p>
                    <p class="text-sm font-medium">${user.ieee_roles_history}</p>
                </div>
                ` : ''}
            </div>
            ` : ''}

            <!-- Habilidades e Intereses -->
            ${hasSkillsInfo ? `
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Habilidades e Intereses</h4>

                ${user.skills && user.skills.length > 0 ? `
                <div class="space-y-2">
                    ${user.skills.filter(s => s.category === 'technical').length > 0 ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-2">Habilidades TÃ©cnicas</p>
                        <div class="flex flex-wrap gap-1">
                            ${user.skills.filter(s => s.category === 'technical').map(s => `
                                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium" style="background-color: ${s.color || '#10B981'}22; color: ${s.color || '#10B981'};">
                                    ${s.icon ? '<i class="fas ' + s.icon + ' mr-1"></i>' : ''}${s.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}

                    ${user.skills.filter(s => s.category === 'soft').length > 0 ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500 mb-2">Habilidades Blandas</p>
                        <div class="flex flex-wrap gap-1">
                            ${user.skills.filter(s => s.category === 'soft').map(s => `
                                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium" style="background-color: ${s.color || '#8B5CF6'}22; color: ${s.color || '#8B5CF6'};">
                                    ${s.icon ? '<i class="fas ' + s.icon + ' mr-1"></i>' : ''}${s.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                ${user.interest_area ? `
                <div class="p-3 bg-purple-50 rounded-lg">
                    <p class="text-xs text-purple-600">Ãrea de InterÃ©s Principal</p>
                    <p class="text-sm font-medium text-purple-900">
                        ${user.interest_area.icon ? '<i class="fas ' + user.interest_area.icon + ' mr-1"></i>' : ''}${user.interest_area.name}
                    </p>
                </div>
                ` : ''}
            </div>
            ` : ''}

            <!-- Disponibilidad y Preferencias -->
            ${hasAvailabilityInfo ? `
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Disponibilidad y Preferencias</h4>

                <div class="grid grid-cols-2 gap-3">
                    ${user.availability_level ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Disponibilidad</p>
                        <p class="text-sm font-medium">${user.availability_level.name}</p>
                        ${user.availability_level.hours_description ? `<p class="text-xs text-gray-400">${user.availability_level.hours_description}</p>` : ''}
                    </div>
                    ` : ''}

                    ${user.preferred_channel ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Canal Preferido</p>
                        <p class="text-sm font-medium">
                            ${user.preferred_channel.icon ? '<i class="fas ' + user.preferred_channel.icon + ' mr-1"></i>' : ''}${user.preferred_channel.name}
                        </p>
                    </div>
                    ` : ''}
                </div>

                ${user.goals_in_branch ? `
                <div class="p-3 bg-yellow-50 rounded-lg">
                    <p class="text-xs text-yellow-600">Â¿QuÃ© busca en la Rama?</p>
                    <p class="text-sm font-medium text-yellow-900">${user.goals_in_branch}</p>
                </div>
                ` : ''}
            </div>
            ` : ''}

            <!-- Etiquetas -->
            ${user.tags && user.tags.length > 0 ? `
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Etiquetas</h4>
                <div class="flex flex-wrap gap-2">
                    ${user.tags.map(tag => `
                        <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold" style="background-color: ${tag.color}22; color: ${tag.color}; border: 1px solid ${tag.color}44;">
                            ${tag.name}
                        </span>
                    `).join('')}
                </div>
            </div>
            ` : ''}

            <!-- Actividad en el Portal -->
            ${user.login_count > 0 ? `
            <div class="space-y-3 pt-4 border-t">
                <h4 class="text-sm font-semibold text-gray-700 uppercase tracking-wide">Actividad en el Portal</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Inicios de SesiÃ³n</p>
                        <p class="text-sm font-medium">${user.login_count}</p>
                    </div>
                    ${lastLoginStr ? `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-xs text-gray-500">Ãšltimo Acceso</p>
                        <p class="text-sm font-medium">${lastLoginStr}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
            ` : ''}

            <!-- Pie con fecha de registro -->
            <div class="pt-4 border-t text-center">
                <p class="text-xs text-muted-foreground">Registrado el ${createdAtStr}</p>
                <p class="text-xs text-muted-foreground">ID: ${user.id}</p>
            </div>
        `;
    }

    function closeViewUserModal() {
        document.getElementById('viewUserModal').classList.add('hidden');
    }

    // ========== FUNCIONES DE ESTUDIOS ==========
    let currentViewUserId = null;

    function openAddStudyModal(userId) {
        currentViewUserId = userId;
        document.getElementById('addStudyUserId').value = userId;
        document.getElementById('addStudyType').value = '';
        document.getElementById('addStudyProgram').value = '';
        document.getElementById('addStudyInstitution').value = '';
        document.getElementById('addStudyModal').classList.remove('hidden');
    }

    function closeAddStudyModal() {
        document.getElementById('addStudyModal').classList.add('hidden');
    }

    async function loadUserStudies(userId) {
        const container = document.getElementById('userStudiesList');
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/users/${userId}/studies`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const studies = await response.json();
                renderUserStudies(studies, userId);
            } else {
                container.innerHTML = '<p class="text-sm text-gray-400 text-center">Error al cargar estudios</p>';
            }
        } catch (error) {
            container.innerHTML = '<p class="text-sm text-gray-400 text-center">Error de conexiÃ³n</p>';
        }
    }

    function renderUserStudies(studies, userId) {
        const container = document.getElementById('userStudiesList');
        currentViewUserId = userId;

        if (studies.length === 0) {
            container.innerHTML = '<p class="text-sm text-gray-400 italic text-center">No tiene otros estudios registrados</p>';
            return;
        }

        const typeLabels = {
            'pregrado': { label: 'Pregrado', color: 'blue' },
            'posgrado': { label: 'Posgrado', color: 'purple' },
            'otro': { label: 'Otro', color: 'gray' }
        };

        container.innerHTML = studies.map(study => {
            const typeInfo = typeLabels[study.study_type] || typeLabels['otro'];
            return `
                <div class="flex items-start justify-between p-2 bg-gray-50 rounded-lg border">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-1 mb-1">
                            <span class="text-xs px-1.5 py-0.5 rounded bg-${typeInfo.color}-100 text-${typeInfo.color}-700">${typeInfo.label}</span>
                            ${study.is_primary ? '<span class="text-xs px-1.5 py-0.5 rounded bg-green-100 text-green-700">Principal</span>' : ''}
                        </div>
                        <p class="text-sm font-medium truncate">${study.program_name}</p>
                        ${study.institution ? `<p class="text-xs text-gray-500 truncate">${study.institution}</p>` : ''}
                    </div>
                    <button onclick="deleteUserStudy(${userId}, ${study.id})" class="text-red-500 hover:text-red-700 p-1 flex-shrink-0" title="Eliminar estudio">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            `;
        }).join('');
    }

    async function submitAddStudy() {
        const userId = document.getElementById('addStudyUserId').value;
        const studyType = document.getElementById('addStudyType').value;
        const programName = document.getElementById('addStudyProgram').value.trim();
        const institution = document.getElementById('addStudyInstitution').value.trim();

        if (!studyType) {
            showNotification('Selecciona el tipo de estudio', 'error');
            return;
        }
        if (!programName) {
            showNotification('Ingresa el nombre del programa', 'error');
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/users/${userId}/studies`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    study_type: studyType,
                    program_name: programName,
                    institution: institution || null,
                    is_primary: false
                })
            });

            if (response.ok) {
                showNotification('Estudio agregado exitosamente', 'success');
                closeAddStudyModal();
                await loadUserStudies(userId);
            } else {
                const error = await response.json();
                showNotification(error.detail || 'Error al agregar estudio', 'error');
            }
        } catch (error) {
            showNotification('Error de conexiÃ³n', 'error');
        }
    }

    async function deleteUserStudy(userId, studyId) {
        if (!confirm('Â¿Eliminar este estudio?')) return;

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/users/${userId}/studies/${studyId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                showNotification('Estudio eliminado', 'success');
                await loadUserStudies(userId);
            } else {
                showNotification('Error al eliminar estudio', 'error');
            }
        } catch (error) {
            showNotification('Error de conexiÃ³n', 'error');
        }
    }

    async function sendBirthdayGreeting(userId, userName) {
        if (!confirm(`Â¿Enviar felicitaciÃ³n de cumpleaÃ±os a ${userName}?\n\nSe enviarÃ¡ por Email y WhatsApp (si tiene nÃºmero registrado).`)) {
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            showNotification(`Enviando felicitaciÃ³n a ${userName}...`, 'success');

            const response = await fetch(`/users/${userId}/send-birthday`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                const details = data.details;
                let message = `FelicitaciÃ³n enviada a ${userName}:\n`;

                if (details.email_sent) {
                    message += '\nâœ“ Email enviado';
                }
                if (details.whatsapp_sent) {
                    message += '\nâœ“ WhatsApp enviado';
                }
                if (details.errors && details.errors.length > 0) {
                    message += '\n\nAvisos: ' + details.errors.join(', ');
                }

                alert(message);
                showNotification('âœ“ FelicitaciÃ³n enviada correctamente', 'success');
            } else {
                const errorDetails = data.detail || data;
                let errorMsg = `Error al enviar felicitaciÃ³n`;

                if (errorDetails.details && errorDetails.details.errors) {
                    errorMsg += ':\n' + errorDetails.details.errors.join('\n');
                }

                showNotification(errorMsg, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error de conexiÃ³n al enviar felicitaciÃ³n', 'error');
        }
    }

    async function deleteUser(id, name, ticketCount) {
        if (ticketCount > 0) {
            showNotification(`No se puede eliminar "${name}" porque tiene ${ticketCount} tickets asociados`, 'error');
            return;
        }

        if (!confirm(`Â¿EstÃ¡s seguro de que quieres eliminar al usuario "${name}"?`)) {
            return;
        }

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch(`/users/${id}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('âœ“ Usuario eliminado exitosamente', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                showNotification(`Error: ${data.detail}`, 'error');
            }
        } catch (error) {
            showNotification('Error al eliminar usuario', 'error');
        }
    }

    // FunciÃ³n de bÃºsqueda y filtrado
    function filterUsers() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const ieeeFilter = document.getElementById('ieeeFilter').value;
        const tbody = document.getElementById('usersTableBody');
        const rows = tbody.getElementsByTagName('tr');

        let visibleCount = 0;

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];

            // Saltar el mensaje de "no resultados" si existe
            if (row.id === 'noResultsMessage') continue;

            const cells = row.getElementsByTagName('td');

            if (cells.length === 0) continue;

            // Obtener texto de las columnas relevantes con verificaciÃ³n
            const id = cells[0] ? cells[0].textContent.toLowerCase() : '';
            const name = cells[1] ? cells[1].textContent.toLowerCase() : '';
            const email = cells[2] ? cells[2].textContent.toLowerCase() : '';
            const identification = cells[3] ? cells[3].textContent.toLowerCase() : '';
            const university = cells[4] ? cells[4].textContent.toLowerCase() : '';
            const phone = cells[6] ? cells[6].textContent.toLowerCase() : '';

            // Verificar si es miembro IEEE (buscar el span con checkmark)
            const ieeeCell = cells[5];
            const isIeeeMember = ieeeCell ? ieeeCell.innerHTML.includes('âœ“') : false;

            // Filtrar por texto de bÃºsqueda
            const matchesSearch = searchInput === '' ||
                name.includes(searchInput) ||
                email.includes(searchInput) ||
                identification.includes(searchInput) ||
                university.includes(searchInput) ||
                phone.includes(searchInput) ||
                id.includes(searchInput);

            // Filtrar por estado IEEE
            const matchesIeeeFilter =
                ieeeFilter === 'all' ||
                (ieeeFilter === 'ieee' && isIeeeMember) ||
                (ieeeFilter === 'non-ieee' && !isIeeeMember);

            // Mostrar u ocultar fila
            if (matchesSearch && matchesIeeeFilter) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        }

        // Mostrar mensaje si no hay resultados
        showFilterMessage(visibleCount);
    }

    function showFilterMessage(count) {
        const tbody = document.getElementById('usersTableBody');
        let messageRow = document.getElementById('noResultsMessage');

        if (count === 0) {
            // Si no hay resultados y no existe el mensaje, crearlo
            if (!messageRow) {
                messageRow = document.createElement('tr');
                messageRow.id = 'noResultsMessage';
                messageRow.innerHTML = `
                    <td colspan="9" class="p-8 text-center text-muted-foreground">
                        <svg class="mx-auto h-12 w-12 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        No se encontraron usuarios que coincidan con tu bÃºsqueda
                    </td>
                `;
                tbody.appendChild(messageRow);
            }
        } else {
            // Si hay resultados, eliminar el mensaje si existe
            if (messageRow) {
                messageRow.parentNode.removeChild(messageRow);
            }
        }
    }

    // FunciÃ³n de ordenamiento
    let sortDirection = {};

    function sortTable(columnIndex) {
        const tbody = document.getElementById('usersTableBody');
        const rows = Array.from(tbody.getElementsByTagName('tr')).filter(row =>
            row.id !== 'noResultsMessage' && row.style.display !== 'none'
        );

        // Determinar direcciÃ³n de ordenamiento
        if (!sortDirection[columnIndex]) {
            sortDirection[columnIndex] = 'asc';
        } else {
            sortDirection[columnIndex] = sortDirection[columnIndex] === 'asc' ? 'desc' : 'asc';
        }

        const direction = sortDirection[columnIndex];

        rows.sort((a, b) => {
            const cellA = a.getElementsByTagName('td')[columnIndex];
            const cellB = b.getElementsByTagName('td')[columnIndex];

            let valueA = cellA.textContent.trim();
            let valueB = cellB.textContent.trim();

            // Para columnas numÃ©ricas (ID y Tickets)
            if (columnIndex === 0 || columnIndex === 7) {
                valueA = parseInt(valueA) || 0;
                valueB = parseInt(valueB) || 0;
            }

            // ComparaciÃ³n
            if (valueA < valueB) {
                return direction === 'asc' ? -1 : 1;
            }
            if (valueA > valueB) {
                return direction === 'asc' ? 1 : -1;
            }
            return 0;
        });

        // Reordenar las filas en el DOM
        rows.forEach(row => tbody.appendChild(row));
    }

    // ========== FUNCIONES DE VERIFICACIÃ“N DE CUMPLEAÃ‘OS ==========

    let lastCheckData = null;

    async function loadBirthdayCheckInfo() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/birthdays/last-check', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                lastCheckData = await response.json();
                updateBirthdayCheckBadge();
            } else {
                console.error(`Error al cargar informaciÃ³n de cumpleaÃ±os. Status: ${response.status}`);
                const errorText = await response.text();
                console.error('Detalles del error:', errorText);
                document.getElementById('lastCheckBadge').textContent = 'N/A';
                const badge = document.getElementById('lastCheckBadge').parentElement;
                badge.title = `No se puede cargar informaciÃ³n (${response.status})`;
            }
        } catch (error) {
            console.error('Error de conexiÃ³n al cargar informaciÃ³n de cumpleaÃ±os:', error);
            document.getElementById('lastCheckBadge').textContent = 'Error';
        }
    }

    function updateBirthdayCheckBadge() {
        const badge = document.getElementById('lastCheckBadge');

        if (!lastCheckData || !lastCheckData.has_logs) {
            badge.textContent = 'Nunca';
            badge.parentElement.title = 'No hay registros de verificaciones anteriores';
            return;
        }

        const lastCheck = lastCheckData.last_check;
        badge.textContent = lastCheck.time_since;

        // Cambiar color segÃºn el tiempo transcurrido
        const hours = lastCheck.hours_since;
        const button = badge.parentElement;

        if (hours < 24) {
            button.className = button.className.replace('bg-blue-100 text-blue-800', 'bg-green-100 text-green-800');
        } else if (hours < 48) {
            button.className = button.className.replace('bg-blue-100 text-blue-800', 'bg-yellow-100 text-yellow-800');
        } else {
            button.className = button.className.replace('bg-blue-100 text-blue-800', 'bg-red-100 text-red-800');
        }

        button.title = `Ãšltima verificaciÃ³n: ${lastCheck.time_since} | ${lastCheck.birthdays_found} cumpleaÃ±os encontrados`;
    }

    function showBirthdayCheckModal() {
        const modal = document.getElementById('birthdayCheckModal');
        const content = document.getElementById('birthdayCheckContent');

        if (!lastCheckData || !lastCheckData.has_logs) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <svg class="mx-auto h-12 w-12 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-muted-foreground">No hay registros de ejecuciones anteriores</p>
                    <p class="text-sm text-muted-foreground mt-2">Ejecuta una verificaciÃ³n manual para comenzar</p>
                </div>
            `;
        } else {
            const lastCheck = lastCheckData.last_check;
            const executionDate = new Date(lastCheck.executed_at);
            const formattedDate = executionDate.toLocaleString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            content.innerHTML = `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-600">Ãšltima ejecuciÃ³n</span>
                            <span class="text-xs px-2 py-1 rounded-full ${lastCheck.execution_type === 'manual' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                                ${lastCheck.execution_type === 'manual' ? 'Manual' : 'AutomÃ¡tica'}
                            </span>
                        </div>
                        <p class="text-lg font-semibold">${lastCheck.time_since}</p>
                        <p class="text-xs text-muted-foreground">${formattedDate}</p>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-purple-50 rounded-lg p-3">
                            <p class="text-xs text-purple-600 font-medium">CumpleaÃ±os Encontrados</p>
                            <p class="text-2xl font-bold text-purple-900">${lastCheck.birthdays_found}</p>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3">
                            <p class="text-xs text-blue-600 font-medium">WhatsApp Disponible</p>
                            <p class="text-2xl font-bold text-blue-900">${lastCheck.whatsapp_available ? 'âœ“ SÃ­' : 'âœ— No'}</p>
                        </div>
                    </div>

                    <div class="border rounded-lg divide-y">
                        <div class="p-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">Emails</span>
                                <span class="text-xs text-muted-foreground">${lastCheck.success_rate.email}</span>
                            </div>
                            <div class="flex gap-4 mt-2 text-sm">
                                <span class="text-green-600">âœ“ ${lastCheck.emails_sent} enviados</span>
                                ${lastCheck.emails_failed > 0 ? `<span class="text-red-600">âœ— ${lastCheck.emails_failed} fallidos</span>` : ''}
                            </div>
                        </div>
                        <div class="p-3">
                            <div class="flex items-center justify-between">
                                <span class="text-sm font-medium">WhatsApp</span>
                                <span class="text-xs text-muted-foreground">${lastCheck.success_rate.whatsapp}</span>
                            </div>
                            <div class="flex gap-4 mt-2 text-sm">
                                <span class="text-green-600">âœ“ ${lastCheck.whatsapp_sent} enviados</span>
                                ${lastCheck.whatsapp_failed > 0 ? `<span class="text-red-600">âœ— ${lastCheck.whatsapp_failed} fallidos</span>` : ''}
                            </div>
                        </div>
                    </div>

                    ${lastCheck.notes ? `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p class="text-xs font-medium text-yellow-800 mb-1">Notas</p>
                            <p class="text-sm text-yellow-700">${lastCheck.notes}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        modal.classList.remove('hidden');
    }

    function closeBirthdayCheckModal() {
        document.getElementById('birthdayCheckModal').classList.add('hidden');
    }

    async function runBirthdayCheckNow() {
        if (!confirm('Â¿Ejecutar verificaciÃ³n de cumpleaÃ±os ahora?\n\nSe enviarÃ¡n mensajes a todos los usuarios que cumplan aÃ±os hoy.')) {
            return;
        }

        const runBtn = document.getElementById('runCheckBtn');
        const originalText = runBtn.innerHTML;

        // Deshabilitar botÃ³n y mostrar loading
        runBtn.disabled = true;
        runBtn.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-2" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Ejecutando...
        `;

        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/birthdays/check-now', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showNotification('âœ“ VerificaciÃ³n ejecutada exitosamente', 'success');

                // Recargar informaciÃ³n
                await loadBirthdayCheckInfo();
                showBirthdayCheckModal();

                // Mostrar resultados
                const result = data.result;
                alert(`VerificaciÃ³n completada:\n\n` +
                      `â€¢ CumpleaÃ±os encontrados: ${result.birthdays_found}\n` +
                      `â€¢ Emails enviados: ${result.emails_sent}\n` +
                      `â€¢ WhatsApp enviados: ${result.whatsapp_sent}`);
            } else {
                showNotification(`Error: ${data.detail || 'No se pudo ejecutar la verificaciÃ³n'}`, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification('Error de conexiÃ³n al ejecutar verificaciÃ³n', 'error');
        } finally {
            // Restaurar botÃ³n
            runBtn.disabled = false;
            runBtn.innerHTML = originalText;
        }
    }

    // ========== FUNCIONES DE IMPORTACIÃ“N DE USUARIOS ==========

    let availableTags = [];

    async function loadTags() {
        try {
            const token = localStorage.getItem('access_token');
            const response = await fetch('/tags/?active_only=true', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                availableTags = await response.json();
                populateTagSelect();
            }
        } catch (error) {
            console.error('Error al cargar tags:', error);
        }
    }

    let currentImportMethod = 'file';

    function populateTagSelect() {
        const select = document.getElementById('importTag');
        select.innerHTML = '<option value="">Seleccione una etiqueta</option>';

        availableTags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag.id;
            option.textContent = `${tag.name} - ${tag.description || 'Sin descripciÃ³n'}`;
            select.appendChild(option);
        });

        // Agregar opciÃ³n para crear nueva etiqueta
        const newOption = document.createElement('option');
        newOption.value = '__new__';
        newOption.textContent = '+ Crear nueva etiqueta';
        select.appendChild(newOption);
    }

    function switchImportMethod(method) {
        currentImportMethod = method;

        const fileTab = document.getElementById('fileTab');
        const pasteTab = document.getElementById('pasteTab');
        const fileContent = document.getElementById('fileContent');
        const pasteContent = document.getElementById('pasteContent');

        if (method === 'file') {
            fileTab.className = 'border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium';
            pasteTab.className = 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium';
            fileContent.classList.remove('hidden');
            pasteContent.classList.add('hidden');
        } else {
            pasteTab.className = 'border-b-2 border-primary text-primary py-2 px-1 text-sm font-medium';
            fileTab.className = 'border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-2 px-1 text-sm font-medium';
            pasteContent.classList.remove('hidden');
            fileContent.classList.add('hidden');
        }
    }

    function handleTagSelection() {
        const select = document.getElementById('importTag');
        const newTagForm = document.getElementById('newTagForm');

        if (select.value === '__new__') {
            newTagForm.classList.remove('hidden');
        } else {
            newTagForm.classList.add('hidden');
        }
    }

    // Actualizar vista previa del color del tag
    document.getElementById('newTagColor')?.addEventListener('input', (e) => {
        const color = e.target.value;
        const preview = document.getElementById('newTagPreview');
        preview.style.backgroundColor = color + '22';
        preview.style.color = color;
        preview.style.borderColor = color + '44';
    });

    function openImportModal() {
        loadTags();
        document.getElementById('importModal').classList.remove('hidden');
        document.getElementById('importForm').reset();
        document.getElementById('importProgress').classList.add('hidden');
        document.getElementById('importResult').classList.add('hidden');
        document.getElementById('newTagForm').classList.add('hidden');
        switchImportMethod('file');
    }

    function closeImportModal() {
        document.getElementById('importModal').classList.add('hidden');
        document.getElementById('importForm').reset();
        document.getElementById('importProgress').classList.add('hidden');
        document.getElementById('importResult').classList.add('hidden');
        document.getElementById('newTagForm').classList.add('hidden');
    }

    document.getElementById('importForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const fileInput = document.getElementById('csvFile');
        const csvText = document.getElementById('csvText').value;
        const tagSelect = document.getElementById('importTag');
        const tagId = tagSelect.value;
        const submitBtn = document.getElementById('importSubmitBtn');
        const progressDiv = document.getElementById('importProgress');
        const resultDiv = document.getElementById('importResult');

        // Validar que hay datos (archivo o texto)
        if (currentImportMethod === 'file' && (!fileInput.files || !fileInput.files[0])) {
            showNotification('Por favor seleccione un archivo CSV', 'error');
            return;
        }

        if (currentImportMethod === 'paste' && !csvText.trim()) {
            showNotification('Por favor pegue los datos CSV', 'error');
            return;
        }

        if (!tagId) {
            showNotification('Por favor seleccione una etiqueta', 'error');
            return;
        }

        // Mostrar progreso
        progressDiv.classList.remove('hidden');
        resultDiv.classList.add('hidden');
        submitBtn.disabled = true;

        try {
            const token = localStorage.getItem('access_token');
            let finalTagId = tagId;

            // Si el usuario quiere crear un nuevo tag, crearlo primero
            if (tagId === '__new__') {
                const newTagName = document.getElementById('newTagName').value.trim();
                const newTagColor = document.getElementById('newTagColor').value;
                const newTagDescription = document.getElementById('newTagDescription').value.trim();

                if (!newTagName) {
                    showNotification('Por favor ingrese el nombre de la nueva etiqueta', 'error');
                    progressDiv.classList.add('hidden');
                    submitBtn.disabled = false;
                    return;
                }

                document.getElementById('importProgressText').textContent = 'Creando nueva etiqueta...';
                document.getElementById('importProgressBar').style.width = '20%';

                // Crear el nuevo tag
                const tagResponse = await fetch('/tags/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newTagName,
                        color: newTagColor,
                        description: newTagDescription,
                        is_active: true
                    })
                });

                const tagData = await tagResponse.json();

                if (!tagResponse.ok) {
                    showNotification(`Error al crear etiqueta: ${tagData.detail}`, 'error');
                    progressDiv.classList.add('hidden');
                    submitBtn.disabled = false;
                    return;
                }

                finalTagId = tagData.id;
                showNotification(`âœ“ Etiqueta "${newTagName}" creada exitosamente`, 'success');
            }

            document.getElementById('importProgressText').textContent = 'Procesando datos...';
            document.getElementById('importProgressBar').style.width = '50%';

            // Preparar datos segÃºn el mÃ©todo de importaciÃ³n
            let formData = new FormData();

            if (currentImportMethod === 'file') {
                formData.append('file', fileInput.files[0]);
            } else {
                // Crear un blob con el texto CSV
                const blob = new Blob([csvText], { type: 'text/csv' });
                formData.append('file', blob, 'pasted_data.csv');
            }

            formData.append('tag_id', finalTagId);

            document.getElementById('importProgressText').textContent = 'Importando usuarios...';
            document.getElementById('importProgressBar').style.width = '70%';

            const response = await fetch('/users/import-csv', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            document.getElementById('importProgressBar').style.width = '100%';
            document.getElementById('importProgressText').textContent = 'Procesado';

            const data = await response.json();

            if (response.ok && data.success) {
                // Mostrar resultado exitoso
                resultDiv.innerHTML = `
                    <div class="border rounded-lg p-4 space-y-3">
                        <div class="flex items-center gap-2 text-green-700">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold">Â¡ImportaciÃ³n completada exitosamente!</span>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="bg-green-50 rounded-lg p-3">
                                <p class="text-xs text-green-600 font-medium">Usuarios Creados</p>
                                <p class="text-2xl font-bold text-green-900">${data.stats.created}</p>
                            </div>
                            <div class="bg-blue-50 rounded-lg p-3">
                                <p class="text-xs text-blue-600 font-medium">Duplicados (Tag Agregado)</p>
                                <p class="text-2xl font-bold text-blue-900">${data.stats.tag_added}</p>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-3">
                                <p class="text-xs text-gray-600 font-medium">Ya TenÃ­an el Tag</p>
                                <p class="text-2xl font-bold text-gray-900">${data.stats.tag_already_exists}</p>
                            </div>
                            ${data.stats.errors > 0 ? `
                            <div class="bg-red-50 rounded-lg p-3">
                                <p class="text-xs text-red-600 font-medium">Errores</p>
                                <p class="text-2xl font-bold text-red-900">${data.stats.errors}</p>
                            </div>
                            ` : ''}
                        </div>

                        <div class="text-sm text-gray-600">
                            <p><strong>Total procesado:</strong> ${data.stats.total_processed} filas</p>
                            <p><strong>Tag asignado:</strong> ${data.tag_name}</p>
                        </div>

                        ${data.errors && data.errors.length > 0 ? `
                        <details class="text-sm">
                            <summary class="cursor-pointer text-red-600 font-medium">Ver errores (${data.errors.length})</summary>
                            <ul class="mt-2 space-y-1 text-xs text-red-700">
                                ${data.errors.slice(0, 10).map(err => `<li>â€¢ ${err}</li>`).join('')}
                                ${data.errors.length > 10 ? `<li>... y ${data.errors.length - 10} errores mÃ¡s</li>` : ''}
                            </ul>
                        </details>
                        ` : ''}

                        <button onclick="window.location.reload()" class="w-full inline-flex items-center justify-center rounded-md text-sm font-medium bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                            Recargar PÃ¡gina para Ver Cambios
                        </button>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                showNotification('âœ“ Usuarios importados exitosamente', 'success');
            } else {
                // Mostrar error
                resultDiv.innerHTML = `
                    <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                        <div class="flex items-center gap-2 text-red-700 mb-2">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-semibold">Error en la importaciÃ³n</span>
                        </div>
                        <p class="text-sm text-red-600">${data.detail || 'Error desconocido'}</p>
                    </div>
                `;
                resultDiv.classList.remove('hidden');
                showNotification(`Error: ${data.detail}`, 'error');
            }
        } catch (error) {
            console.error('Error:', error);
            resultDiv.innerHTML = `
                <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                    <p class="text-sm text-red-600">Error de conexiÃ³n al importar usuarios</p>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            showNotification('Error de conexiÃ³n al importar usuarios', 'error');
        } finally {
            submitBtn.disabled = false;
        }
    });
</script>
{% endblock %}
