<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Portal - IEEE Tadeo Control System</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ieee: '#0066cc'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-ieee rounded-lg flex items-center justify-center">
                        <i class="fas fa-user text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-xl font-bold text-gray-900">Mi Portal</h1>
                        <p class="text-xs text-gray-500">IEEE Tadeo</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 sm:gap-4">
                    <span id="userName" class="text-gray-600 text-sm hidden sm:inline"></span>
                    <!-- Botón Admin (solo si tiene acceso) -->
                    <button onclick="goToAdmin()" id="adminBtn" class="hidden bg-ieee text-white hover:bg-blue-700 text-sm px-3 py-1.5 rounded-lg flex items-center gap-1 transition">
                        <i class="fas fa-cog"></i>
                        <span class="hidden sm:inline">Admin</span>
                    </button>
                    <button onclick="logout()" class="text-red-600 hover:text-red-800 text-sm flex items-center gap-1">
                        <i class="fas fa-sign-out-alt"></i>
                        <span class="hidden sm:inline">Salir</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 sm:px-6 lg:px-8">
        <!-- Profile Completion Banner -->
        <div id="profileBanner" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
            <div class="flex items-start gap-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 mt-0.5"></i>
                <div class="flex-1">
                    <h3 class="font-medium text-yellow-800">Completa tu perfil</h3>
                    <p class="text-sm text-yellow-700">Ayúdanos a conocerte mejor completando tu información.</p>
                </div>
                <button onclick="switchTab('profile')" class="text-sm text-yellow-800 font-medium hover:underline">
                    Completar ahora
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px">
                    <button onclick="switchTab('dashboard')" id="dashboardTab" class="tab-button flex-1 sm:flex-none px-4 sm:px-6 py-3 border-b-2 border-ieee font-medium text-ieee text-sm">
                        <i class="fas fa-ticket-alt mr-2"></i>Mis Tickets
                    </button>
                    <button onclick="switchTab('profile')" id="profileTab" class="tab-button flex-1 sm:flex-none px-4 sm:px-6 py-3 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-user-edit mr-2"></i>Mi Perfil
                    </button>
                    <button onclick="switchTab('birthdays')" id="birthdaysTab" class="tab-button flex-1 sm:flex-none px-4 sm:px-6 py-3 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-calendar-alt mr-2"></i>Calendario
                    </button>
                    <button onclick="switchTab('contests')" id="contestsTab" class="tab-button flex-1 sm:flex-none px-4 sm:px-6 py-3 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-trophy mr-2"></i>Concursos
                    </button>
                    <button onclick="goToModule('asistencia')" class="tab-button flex-1 sm:flex-none px-4 sm:px-6 py-3 border-b-2 border-transparent font-medium text-gray-500 hover:text-gray-700 text-sm">
                        <i class="fas fa-clipboard-check mr-2"></i>Asistencias
                        <i class="fas fa-external-link-alt ml-1 text-xs opacity-60"></i>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardContent" class="tab-content">
            <!-- Stats Card -->
            <div class="bg-gradient-to-r from-ieee to-blue-700 rounded-lg shadow-sm p-5 mb-6 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold" id="welcomeUserName">Cargando...</h2>
                        <div class="flex items-center gap-4 mt-2 text-sm opacity-90">
                            <span id="userUniversityDisplay"><i class="fas fa-university mr-1"></i> -</span>
                            <span id="ieeeStatusDisplay"><i class="fas fa-id-badge mr-1"></i> -</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <p class="text-4xl font-bold" id="totalTicketsCount">0</p>
                        <p class="text-xs opacity-90">tickets</p>
                    </div>
                </div>
            </div>

            <!-- Tickets List -->
            <div class="bg-white rounded-lg shadow-sm">
                <div class="p-4 border-b border-gray-100">
                    <h2 class="font-bold text-gray-900"><i class="fas fa-ticket-alt mr-2 text-ieee"></i>Mis Tickets</h2>
                </div>
                <div id="ticketsList" class="divide-y divide-gray-100">
                    <div class="p-4 text-center text-gray-500">
                        <i class="fas fa-spinner fa-spin mr-2"></i>Cargando...
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Tab -->
        <div id="profileContent" class="tab-content hidden">
            <form id="profileForm" class="space-y-4">

                <!-- Seccion: Foto de Perfil -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <div class="p-4 flex flex-col sm:flex-row items-center gap-4">
                        <div class="relative">
                            <div id="profilePhotoContainer" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg">
                                <img id="profilePhotoImg" src="" alt="Foto de perfil" class="w-full h-full object-cover hidden">
                                <span id="profilePhotoInitial" class="text-3xl font-bold text-gray-400">?</span>
                            </div>
                            <button type="button" onclick="document.getElementById('photoInput').click()" class="absolute -bottom-1 -right-1 w-8 h-8 bg-ieee rounded-full flex items-center justify-center text-white shadow hover:bg-blue-700 transition">
                                <i class="fas fa-camera text-sm"></i>
                            </button>
                        </div>
                        <div class="text-center sm:text-left">
                            <h3 class="font-medium text-gray-900">Foto de Perfil</h3>
                            <p class="text-sm text-gray-500 mt-1">JPG, PNG o WebP. Máx 10MB.</p>
                            <div class="flex gap-2 mt-2">
                                <button type="button" onclick="document.getElementById('photoInput').click()" class="text-sm text-ieee hover:underline">
                                    <i class="fas fa-upload mr-1"></i>Subir foto
                                </button>
                                <button type="button" id="deletePhotoBtn" onclick="deleteProfilePhoto()" class="text-sm text-red-600 hover:underline hidden">
                                    <i class="fas fa-trash mr-1"></i>Eliminar
                                </button>
                            </div>
                        </div>
                        <input type="file" id="photoInput" accept="image/jpeg,image/png,image/webp,image/gif" class="hidden" onchange="uploadProfilePhoto(this)">
                    </div>
                </div>

                <!-- Seccion: Información Básica -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <button type="button" onclick="toggleSection('basic')" class="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-user text-blue-600"></i>
                            </div>
                            <span class="font-medium">Información Básica</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition" id="icon-basic"></i>
                    </button>
                    <div id="section-basic" class="p-4 border-t border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nombre Completo *</label>
                                <input type="text" id="name" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee focus:border-ieee">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Apodo (como te gusta que te llamen)</label>
                                <input type="text" id="nick" placeholder="Ej: Juancho, Pao" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                            </div>

                            <!-- Sección de Emails -->
                            <div class="md:col-span-2 bg-blue-50 rounded-lg p-4 space-y-3">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="fas fa-envelope text-blue-600"></i>
                                    <span class="font-medium text-gray-700">Correos Electrónicos</span>
                                    <span class="text-xs text-gray-500">(El correo principal recibe los códigos OTP)</span>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                            <input type="radio" name="primary_email_type" value="email_personal" class="text-ieee" onchange="updatePrimaryEmail()">
                                            Email Personal
                                        </label>
                                        <input type="email" id="email_personal" placeholder="personal@gmail.com" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee text-sm">
                                    </div>
                                    <div>
                                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                            <input type="radio" name="primary_email_type" value="email_institutional" class="text-ieee" onchange="updatePrimaryEmail()">
                                            Email Institucional
                                        </label>
                                        <input type="email" id="email_institutional" placeholder="usuario@utadeo.edu.co" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee text-sm">
                                    </div>
                                    <div>
                                        <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-1">
                                            <input type="radio" name="primary_email_type" value="email_ieee" class="text-ieee" onchange="updatePrimaryEmail()">
                                            Email IEEE
                                        </label>
                                        <input type="email" id="email_ieee" placeholder="usuario@ieee.org" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee text-sm">
                                    </div>
                                </div>

                                <div id="primaryEmailInfo" class="text-xs text-blue-700 bg-blue-100 rounded px-3 py-2 mt-2">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    <span id="primaryEmailText">Selecciona un correo como principal para recibir códigos OTP</span>
                                </div>

                                <!-- Email original (oculto, solo para referencia) -->
                                <input type="hidden" id="email">
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                                <div class="flex gap-2">
                                    <select id="country_code" class="w-28 px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                        <option value="+57">+57</option>
                                        <option value="+1">+1</option>
                                        <option value="+52">+52</option>
                                    </select>
                                    <input type="tel" id="phone" placeholder="3001234567" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Identificación</label>
                                <input type="text" id="identification" placeholder="Cédula o documento" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Nacimiento</label>
                                <input type="date" id="birthday" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seccion: Información Académica -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <button type="button" onclick="toggleSection('academic')" class="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-graduation-cap text-green-600"></i>
                            </div>
                            <span class="font-medium">Información Académica</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition" id="icon-academic"></i>
                    </button>
                    <div id="section-academic" class="p-4 border-t border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Universidad *</label>
                                <select id="university_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Programa Académico *</label>
                                <select id="academic_program_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Semestre Actual *</label>
                                <select id="semester_range_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Estimada de Grado</label>
                                <input type="month" id="expected_graduation" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Nivel de Inglés</label>
                                <select id="english_level_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="flex items-center gap-3 p-3 border border-purple-200 rounded-lg cursor-pointer hover:bg-purple-50 transition">
                                    <input type="checkbox" id="is_professor" class="w-5 h-5 rounded border-gray-300 text-purple-600 focus:ring-2 focus:ring-purple-500">
                                    <div>
                                        <span class="font-medium text-gray-800">Soy Profesor / Docente</span>
                                        <p class="text-xs text-gray-500">Marcar si eres docente universitario</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seccion: Otros Estudios -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <button type="button" onclick="toggleSection('studies')" class="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-book-reader text-purple-600"></i>
                            </div>
                            <span class="font-medium">Otros Estudios</span>
                            <span id="studies-count" class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition" id="icon-studies"></i>
                    </button>
                    <div id="section-studies" class="p-4 border-t border-gray-100 hidden">
                        <p class="text-sm text-gray-500 mb-4">Agrega otros estudios de pregrado, posgrado u otros programas que hayas cursado o estés cursando.</p>

                        <!-- Lista de estudios -->
                        <div id="studies-list" class="space-y-3 mb-4">
                            <!-- Estudios se cargan dinámicamente -->
                        </div>

                        <!-- Formulario para agregar nuevo estudio -->
                        <div class="border-t pt-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Agregar nuevo estudio</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de estudio *</label>
                                    <select id="new_study_type" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">Seleccionar...</option>
                                        <option value="tecnica">Técnica</option>
                                        <option value="tecnologia">Tecnología</option>
                                        <option value="pregrado">Pregrado</option>
                                        <option value="posgrado">Posgrado</option>
                                        <option value="otro">Otro (diplomado, certificación, etc.)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Estado *</label>
                                    <select id="new_study_status" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="cursando">Cursando</option>
                                        <option value="egresado">Egresado</option>
                                        <option value="sin_terminar">Sin terminar</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Nombre del programa *</label>
                                    <input type="text" id="new_study_program" placeholder="Ej: Maestría en Ciencia de Datos" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Institución</label>
                                    <input type="text" id="new_study_institution" placeholder="Universidad de Bogotá Jorge Tadeo Lozano" class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                                </div>
                            </div>
                            <button type="button" onclick="addStudy()" class="mt-3 inline-flex items-center gap-2 px-4 py-2 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                <i class="fas fa-plus"></i>
                                Agregar Estudio
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Seccion: Membresía IEEE -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <button type="button" onclick="toggleSection('ieee')" class="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-id-card text-blue-600"></i>
                            </div>
                            <span class="font-medium">Membresía IEEE</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition" id="icon-ieee"></i>
                    </button>
                    <div id="section-ieee" class="p-4 border-t border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado de Membresía *</label>
                                <select id="ieee_membership_status_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Número de Membresía IEEE</label>
                                <input type="text" id="ieee_member_id" placeholder="Ej: 12345678" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                <p class="text-xs text-gray-500 mt-1">Si eres miembro activo, ingresa tu número</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sociedades Técnicas de Interés</label>
                                <div id="societies-container" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                                    <!-- Se llena dinamicamente -->
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Roles previos en IEEE</label>
                                <textarea id="ieee_roles_history" rows="2" placeholder="Ej: Voluntario 2023, Asistente de tesorería 2024" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seccion: Habilidades e Intereses -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <button type="button" onclick="toggleSection('skills')" class="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-tools text-purple-600"></i>
                            </div>
                            <span class="font-medium">Habilidades e Intereses</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition" id="icon-skills"></i>
                    </button>
                    <div id="section-skills" class="p-4 border-t border-gray-100">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Habilidades Técnicas</label>
                                <div id="skills-technical" class="flex flex-wrap gap-2">
                                    <!-- Se llena dinamicamente -->
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Habilidades Blandas</label>
                                <div id="skills-soft" class="flex flex-wrap gap-2">
                                    <!-- Se llena dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Seccion: Disponibilidad y Preferencias -->
                <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                    <button type="button" onclick="toggleSection('availability')" class="w-full p-4 flex items-center justify-between bg-gray-50 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-clock text-orange-600"></i>
                            </div>
                            <span class="font-medium">Disponibilidad y Preferencias</span>
                        </div>
                        <i class="fas fa-chevron-down text-gray-400 transition" id="icon-availability"></i>
                    </button>
                    <div id="section-availability" class="p-4 border-t border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Área de Interés Principal</label>
                                <select id="interest_area_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Disponibilidad Semanal</label>
                                <select id="availability_level_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Canal de Comunicación Preferido</label>
                                <select id="preferred_channel_id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee">
                                    <option value="">Seleccionar...</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">¿Qué buscas en la Rama?</label>
                                <textarea id="goals_in_branch" rows="2" placeholder="Ej: Aprender sobre robótica, conocer personas del sector, liderar proyectos…" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-ieee"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Botones de accion -->
                <div class="flex flex-col sm:flex-row gap-3 pt-4">
                    <button type="submit" class="flex-1 bg-ieee text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium transition">
                        <i class="fas fa-save mr-2"></i>Guardar Cambios
                    </button>
                    <button type="button" onclick="showChangePassword()" class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition">
                        <i class="fas fa-key mr-2"></i>Cambiar Contraseña
                    </button>
                </div>
            </form>
        </div>

        <!-- Calendar Tab -->
        <div id="birthdaysContent" class="tab-content hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-ieee to-indigo-600 rounded-lg shadow-sm p-5 mb-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-calendar-alt text-3xl mr-4"></i>
                        <div>
                            <h2 class="text-xl font-bold">Calendario <span id="calYearTitle"></span></h2>
                            <p class="text-blue-100 text-sm">Cumplea&ntilde;os y eventos de la rama</p>
                        </div>
                    </div>
                    <div class="flex gap-1">
                        <span class="inline-flex items-center text-xs"><span class="w-2 h-2 rounded-full bg-pink-400 mr-1"></span>Cumplea&ntilde;os</span>
                        <span class="inline-flex items-center text-xs ml-3"><span class="w-2 h-2 rounded-full bg-yellow-400 mr-1"></span>Eventos</span>
                    </div>
                </div>
            </div>

            <!-- Today alert -->
            <div id="todayAlert" class="hidden mb-4">
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div id="todayAlertContent" class="flex flex-wrap gap-2 items-center text-sm"></div>
                </div>
            </div>

            <!-- Year calendar grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 mb-6" id="yearCalendarGrid"></div>

            <!-- Upcoming section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Upcoming events -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-calendar-check text-ieee mr-2"></i>Pr&oacute;ximos Eventos</h3>
                    <div id="upcomingEvents" class="space-y-2"></div>
                </div>
                <!-- Upcoming birthdays -->
                <div class="bg-white rounded-lg shadow-sm p-4">
                    <h3 class="font-bold text-gray-800 mb-3"><i class="fas fa-birthday-cake text-pink-500 mr-2"></i>Pr&oacute;ximos Cumplea&ntilde;os</h3>
                    <div id="upcomingBirthdays" class="space-y-2"></div>
                </div>
            </div>

            <!-- Day detail popup -->
            <div id="dayDetailPopup" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeDayDetail()">
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full p-5">
                    <div class="flex justify-between items-center mb-3">
                        <h3 id="dayDetailTitle" class="font-bold text-gray-900"></h3>
                        <button onclick="closeDayDetail()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
                    </div>
                    <div id="dayDetailContent"></div>
                </div>
            </div>
        </div>

        <!-- Contests Tab -->
        <div id="contestsContent" class="tab-content hidden">
            <!-- Header -->
            <div class="bg-gradient-to-r from-amber-500 to-orange-600 rounded-lg shadow-sm p-5 mb-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-trophy text-3xl mr-4"></i>
                        <div>
                            <h2 class="text-xl font-bold">Concursos y Convocatorias 2026</h2>
                            <p class="text-amber-100 text-sm">Oportunidades de premios, financiacion y crecimiento profesional</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtro de categoria -->
            <div class="flex items-center gap-2 mb-4 flex-wrap">
                <button onclick="filterPortalContests('')" class="portal-contest-filter text-xs px-3 py-1.5 rounded-full border font-medium bg-ieee text-white border-ieee">Todos</button>
                <button onclick="filterPortalContests('IEEE')" class="portal-contest-filter text-xs px-3 py-1.5 rounded-full border font-medium bg-white text-gray-600 border-gray-300 hover:bg-gray-50">IEEE</button>
                <button onclick="filterPortalContests('Gobierno')" class="portal-contest-filter text-xs px-3 py-1.5 rounded-full border font-medium bg-white text-gray-600 border-gray-300 hover:bg-gray-50">Gobierno</button>
                <button onclick="filterPortalContests('Empresa')" class="portal-contest-filter text-xs px-3 py-1.5 rounded-full border font-medium bg-white text-gray-600 border-gray-300 hover:bg-gray-50">Empresa</button>
                <button onclick="filterPortalContests('Universidad')" class="portal-contest-filter text-xs px-3 py-1.5 rounded-full border font-medium bg-white text-gray-600 border-gray-300 hover:bg-gray-50">Universidad</button>
            </div>

            <!-- Lista de concursos -->
            <div id="portalContestsList" class="space-y-3">
                <div class="text-center py-8 text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-2"></i>Cargando concursos...
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de cambio/creacion de contrasena -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-bold text-gray-900" id="passwordModalTitle">Crear Contraseña</h2>
                <button onclick="closePasswordModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p id="passwordModalDesc" class="text-sm text-gray-600 mb-4">Crea una contraseña para acceder sin necesidad de código OTP.</p>
            <form id="passwordForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nueva Contraseña</label>
                    <input type="password" id="newPassword" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                    <p class="text-xs text-gray-500 mt-1">Mínimo 6 caracteres</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Confirmar Contraseña</label>
                    <input type="password" id="confirmPassword" required minlength="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                </div>
                <div id="passwordError" class="hidden text-sm text-red-600 bg-red-50 p-2 rounded"></div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closePasswordModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 bg-ieee text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                        Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notificaciones -->
    <div id="notification" class="hidden fixed top-4 right-4 max-w-sm bg-white shadow-lg rounded-lg p-4 z-50 border-l-4"></div>

    <script>
        // Variables globales
        let currentProfile = {};
        let catalogs = {};
        const token = localStorage.getItem('user_access_token');

        // Verificar autenticacion
        if (!token) {
            window.location.href = '/portal/login';
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCatalogs();
            await loadProfile();
            await loadTickets();
            await loadStudies();
        });

        // Cargar catalogos
        async function loadCatalogs() {
            try {
                const endpoints = [
                    'academic-programs', 'semester-ranges', 'english-levels',
                    'ieee-membership-statuses', 'ieee-societies', 'interest-areas',
                    'availability-levels', 'communication-channels', 'skills'
                ];

                const responses = await Promise.all(
                    endpoints.map(e => fetch(`/portal/catalogs/${e}`).then(r => r.json()))
                );

                catalogs = {
                    academicPrograms: responses[0],
                    semesterRanges: responses[1],
                    englishLevels: responses[2],
                    membershipStatuses: responses[3],
                    societies: responses[4],
                    interestAreas: responses[5],
                    availabilityLevels: responses[6],
                    channels: responses[7],
                    skills: responses[8]
                };

                // Poblar universidades
                const uniResp = await fetch('/universities/?active_only=true');
                catalogs.universities = await uniResp.json();

                populateSelects();
                populateSocieties();
                populateSkills();
            } catch (error) {
                console.error('Error cargando catalogos:', error);
            }
        }

        // Poblar selects
        function populateSelects() {
            populateSelect('university_id', catalogs.universities, 'name');
            populateSelect('academic_program_id', catalogs.academicPrograms, 'name');
            populateSelect('semester_range_id', catalogs.semesterRanges, 'name');
            populateSelect('english_level_id', catalogs.englishLevels, 'name');
            populateSelect('ieee_membership_status_id', catalogs.membershipStatuses, 'name');
            populateSelect('interest_area_id', catalogs.interestAreas, 'name');
            populateSelect('availability_level_id', catalogs.availabilityLevels, 'name');
            populateSelect('preferred_channel_id', catalogs.channels, 'name');
        }

        function populateSelect(id, items, labelField) {
            const select = document.getElementById(id);
            if (!select) return;
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[labelField];
                select.appendChild(option);
            });
        }

        // Poblar sociedades IEEE (checkboxes)
        function populateSocieties() {
            const container = document.getElementById('societies-container');
            if (!container) return;
            container.innerHTML = catalogs.societies.map(s => `
                <label class="flex items-center gap-2 p-2 border rounded-lg cursor-pointer hover:bg-gray-50 transition society-checkbox" data-id="${s.id}">
                    <input type="checkbox" value="${s.id}" class="society-input rounded text-ieee focus:ring-ieee">
                    <span class="text-sm" style="color: ${s.color}">${s.code}</span>
                </label>
            `).join('');
        }

        // Poblar habilidades (chips seleccionables con colores)
        function populateSkills() {
            const technicalContainer = document.getElementById('skills-technical');
            const softContainer = document.getElementById('skills-soft');

            // Separar por tipo (categorías: 'technical' y 'soft')
            const technical = catalogs.skills.filter(s => s.category === 'technical');
            const soft = catalogs.skills.filter(s => s.category === 'soft');

            // Función para generar HTML de skill
            const generateSkillHTML = (s) => `
                <button type="button" class="skill-chip px-3 py-1.5 rounded-full border-2 text-sm font-medium transition-all duration-200 hover:scale-105"
                        data-id="${s.id}"
                        style="--skill-color: ${s.color || '#6366f1'}; border-color: ${s.color || '#6366f1'}; color: ${s.color || '#6366f1'}">
                    <i class="fas fa-${s.icon || 'code'} mr-1.5"></i>${s.name}
                </button>
            `;

            // Ordenar alfabéticamente y renderizar
            if (technicalContainer) {
                const sortedTechnical = [...technical].sort((a, b) => a.name.localeCompare(b.name));
                technicalContainer.innerHTML = sortedTechnical.map(generateSkillHTML).join('');
            }

            if (softContainer) {
                const sortedSoft = [...soft].sort((a, b) => a.name.localeCompare(b.name));
                if (sortedSoft.length > 0) {
                    softContainer.innerHTML = sortedSoft.map(generateSkillHTML).join('');
                } else {
                    softContainer.innerHTML = '<span class="text-gray-400 text-sm italic">No hay habilidades blandas disponibles</span>';
                }
            }

            // Agregar eventos a los chips
            document.querySelectorAll('.skill-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    chip.classList.toggle('selected');
                    const color = chip.style.getPropertyValue('--skill-color');
                    if (chip.classList.contains('selected')) {
                        chip.style.backgroundColor = color;
                        chip.style.color = 'white';
                    } else {
                        chip.style.backgroundColor = 'transparent';
                        chip.style.color = color;
                    }
                });
            });
        }

        // Cargar perfil
        async function loadProfile() {
            try {
                const response = await fetch('/portal/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    currentProfile = await response.json();
                    populateProfileForm();
                    updateDashboardInfo();

                    // Mostrar banner si perfil incompleto
                    if (!currentProfile.profile_completed) {
                        document.getElementById('profileBanner').classList.remove('hidden');
                    }

                    // Mostrar botón de admin si tiene acceso
                    if (currentProfile.has_admin_access) {
                        document.getElementById('adminBtn').classList.remove('hidden');
                    }
                } else if (response.status === 401) {
                    logout();
                }
            } catch (error) {
                console.error('Error cargando perfil:', error);
            }
        }

        // Poblar formulario
        function populateProfileForm() {
            document.getElementById('userName').textContent = currentProfile.name;
            document.getElementById('name').value = currentProfile.name || '';
            document.getElementById('nick').value = currentProfile.nick || '';

            // Actualizar foto de perfil
            updateProfilePhotoDisplay();
            document.getElementById('email').value = currentProfile.email || '';

            // Emails múltiples
            document.getElementById('email_personal').value = currentProfile.email_personal || '';
            document.getElementById('email_institutional').value = currentProfile.email_institutional || '';
            document.getElementById('email_ieee').value = currentProfile.email_ieee || '';

            // Marcar email principal
            const primaryType = currentProfile.primary_email_type || 'email_personal';
            const radioBtn = document.querySelector(`input[name="primary_email_type"][value="${primaryType}"]`);
            if (radioBtn) {
                radioBtn.checked = true;
            }
            updatePrimaryEmail();

            document.getElementById('country_code').value = currentProfile.country_code || '+57';
            document.getElementById('phone').value = currentProfile.phone || '';
            document.getElementById('identification').value = currentProfile.identification || '';

            if (currentProfile.birthday) {
                document.getElementById('birthday').value = new Date(currentProfile.birthday).toISOString().split('T')[0];
            }

            // Academica
            document.getElementById('university_id').value = currentProfile.university_id || '';
            document.getElementById('academic_program_id').value = currentProfile.academic_program_id || '';
            document.getElementById('semester_range_id').value = currentProfile.semester_range_id || '';
            document.getElementById('english_level_id').value = currentProfile.english_level_id || '';
            document.getElementById('is_professor').checked = currentProfile.is_professor || false;

            if (currentProfile.expected_graduation) {
                const date = new Date(currentProfile.expected_graduation);
                document.getElementById('expected_graduation').value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }

            // IEEE
            document.getElementById('ieee_membership_status_id').value = currentProfile.ieee_membership_status_id || '';
            document.getElementById('ieee_member_id').value = currentProfile.ieee_member_id || '';
            document.getElementById('ieee_roles_history').value = currentProfile.ieee_roles_history || '';

            // Sociedades seleccionadas
            if (currentProfile.ieee_societies) {
                currentProfile.ieee_societies.forEach(s => {
                    const checkbox = document.querySelector(`.society-input[value="${s.id}"]`);
                    if (checkbox) checkbox.checked = true;
                });
            }

            // Disponibilidad
            document.getElementById('interest_area_id').value = currentProfile.interest_area_id || '';
            document.getElementById('availability_level_id').value = currentProfile.availability_level_id || '';
            document.getElementById('preferred_channel_id').value = currentProfile.preferred_channel_id || '';
            document.getElementById('goals_in_branch').value = currentProfile.goals_in_branch || '';

            // Habilidades seleccionadas
            if (currentProfile.skills) {
                currentProfile.skills.forEach(s => {
                    const chip = document.querySelector(`.skill-chip[data-id="${s.id}"]`);
                    if (chip) {
                        chip.classList.add('selected');
                        const color = chip.style.getPropertyValue('--skill-color') || s.color || '#6366f1';
                        chip.style.backgroundColor = color;
                        chip.style.color = 'white';
                    }
                });
            }
        }

        // Actualizar info del dashboard
        function updateDashboardInfo() {
            document.getElementById('welcomeUserName').textContent = `Hola, ${currentProfile.nick || currentProfile.name?.split(' ')[0] || 'Usuario'}`;

            const uni = currentProfile.university?.short_name || currentProfile.university?.name || 'Sin universidad';
            document.getElementById('userUniversityDisplay').innerHTML = `<i class="fas fa-university mr-1"></i> ${uni}`;

            const ieeeStatus = currentProfile.ieee_membership_status?.name || (currentProfile.is_ieee_member ? 'Miembro IEEE' : 'No miembro');
            document.getElementById('ieeeStatusDisplay').innerHTML = `<i class="fas fa-id-badge mr-1"></i> ${ieeeStatus}`;
        }

        // Cargar tickets
        async function loadTickets() {
            try {
                const response = await fetch('/portal/tickets', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    const tickets = await response.json();
                    renderTickets(tickets);
                }
            } catch (error) {
                console.error('Error cargando tickets:', error);
            }
        }

        // Renderizar tickets
        function renderTickets(tickets) {
            document.getElementById('totalTicketsCount').textContent = tickets.length;
            const container = document.getElementById('ticketsList');

            if (tickets.length === 0) {
                container.innerHTML = '<div class="p-8 text-center text-gray-500"><i class="fas fa-ticket-alt text-4xl mb-3 opacity-50"></i><p>No tienes tickets registrados</p></div>';
                return;
            }

            container.innerHTML = tickets.map(t => `
                <div class="p-4 hover:bg-gray-50 transition">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <h3 class="font-medium text-gray-900">${t.event_name}</h3>
                            <p class="text-sm text-gray-500 mt-1">
                                <i class="fas fa-calendar mr-1"></i>${new Date(t.event_date).toLocaleDateString('es-CO', {dateStyle: 'long'})}
                            </p>
                            <p class="text-sm text-gray-500">
                                <i class="fas fa-map-marker-alt mr-1"></i>${t.event_location}
                            </p>
                            <p class="text-xs text-gray-400 mt-2">Código: ${t.ticket_code.substring(0, 8)}...</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${t.is_used ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-700'}">
                                ${t.is_used ? 'Usado' : 'Activo'}
                            </span>
                            ${t.unique_url ? `<a href="/portal/ticket/${t.unique_url}" target="_blank" class="block mt-2 text-xs text-ieee hover:underline"><i class="fas fa-external-link-alt mr-1"></i>Ver ticket</a>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Ir a módulo externo
        async function goToModule(moduleName) {
            try {
                const response = await fetch('/portal/generate-external-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('user_access_token')}`
                    },
                    body: JSON.stringify({ module_name: moduleName })
                });

                if (!response.ok) {
                    const err = await response.json();
                    showNotification(err.detail || 'Error al acceder al módulo', 'error');
                    return;
                }

                const data = await response.json();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    showNotification('Módulo no configurado correctamente', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        }

        // Tabs
        let contestsLoaded = false;
        let portalContestsData = [];

        function switchTab(tab) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('border-ieee', 'text-ieee');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

            const tabEl = document.getElementById(tab + 'Tab');
            const contentEl = document.getElementById(tab + 'Content');
            if (tabEl) tabEl.classList.add('border-ieee', 'text-ieee');
            if (contentEl) contentEl.classList.remove('hidden');
            if (tab === 'birthdays' && !birthdaysLoaded) loadBirthdays();
            if (tab === 'contests' && !contestsLoaded) loadPortalContests();
        }

        // Concursos del portal
        async function loadPortalContests() {
            try {
                const response = await fetch('/api/contests?active_only=true');
                if (!response.ok) throw new Error('Error');
                portalContestsData = await response.json();
                contestsLoaded = true;
                renderPortalContests(portalContestsData);
            } catch (error) {
                document.getElementById('portalContestsList').innerHTML =
                    '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-circle mr-2"></i>Error al cargar concursos</div>';
            }
        }

        function renderPortalContests(contests) {
            const container = document.getElementById('portalContestsList');
            if (contests.length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500"><i class="fas fa-info-circle mr-2"></i>No hay concursos disponibles en este momento</div>';
                return;
            }

            const categoryColors = {
                'IEEE': 'bg-blue-100 text-blue-700 border-blue-200',
                'Gobierno': 'bg-green-100 text-green-700 border-green-200',
                'Empresa': 'bg-purple-100 text-purple-700 border-purple-200',
                'Universidad': 'bg-amber-100 text-amber-700 border-amber-200',
                'ONG': 'bg-teal-100 text-teal-700 border-teal-200',
                'Otro': 'bg-gray-100 text-gray-700 border-gray-200'
            };

            const modalityIcons = {
                'Virtual': '<i class="fas fa-laptop text-blue-500"></i>',
                'Presencial': '<i class="fas fa-map-marker-alt text-red-500"></i>',
                'Hibrida': '<i class="fas fa-sync-alt text-green-500"></i>'
            };

            let html = '';
            contests.forEach(c => {
                const catClass = categoryColors[c.category] || categoryColors['Otro'];
                const modIcon = c.modality ? (modalityIcons[c.modality] || '') : '';

                html += `
                <div class="portal-contest-card bg-white rounded-lg shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow" data-category="${c.category || ''}">
                    <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-lg bg-amber-50 flex items-center justify-center flex-shrink-0 mt-0.5">
                            <i class="fas fa-trophy text-amber-500"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 flex-wrap mb-1">
                                <h3 class="font-semibold text-gray-900 text-sm">${c.name}</h3>
                                <span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${catClass}">${c.category || 'Otro'}</span>
                                ${c.modality ? `<span class="inline-flex items-center gap-1 text-xs text-gray-500">${modIcon} ${c.modality}</span>` : ''}
                            </div>
                            ${c.description ? `<p class="text-sm text-gray-600 mb-2">${c.description}</p>` : ''}
                            <div class="flex flex-wrap gap-x-4 gap-y-1.5 text-xs">
                                ${c.prizes ? `<span class="inline-flex items-center gap-1 text-amber-700 bg-amber-50 px-2 py-1 rounded-md"><i class="fas fa-award"></i> ${c.prizes}</span>` : ''}
                                ${c.deadline ? `<span class="inline-flex items-center gap-1 text-red-600 bg-red-50 px-2 py-1 rounded-md"><i class="fas fa-clock"></i> ${c.deadline}</span>` : ''}
                                ${c.url ? `<a href="${c.url}" target="_blank" class="inline-flex items-center gap-1 text-ieee hover:underline px-2 py-1 rounded-md bg-blue-50"><i class="fas fa-external-link-alt"></i> Ver convocatoria</a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
        }

        function filterPortalContests(category) {
            // Update filter buttons style
            document.querySelectorAll('.portal-contest-filter').forEach(btn => {
                btn.classList.remove('bg-ieee', 'text-white', 'border-ieee');
                btn.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
            });
            event.target.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
            event.target.classList.add('bg-ieee', 'text-white', 'border-ieee');

            if (!category) {
                renderPortalContests(portalContestsData);
            } else {
                renderPortalContests(portalContestsData.filter(c => c.category === category));
            }
        }

        // Toggle secciones
        function toggleSection(name) {
            const section = document.getElementById(`section-${name}`);
            const icon = document.getElementById(`icon-${name}`);
            section.classList.toggle('hidden');
            icon.classList.toggle('rotate-180');
        }

        // Guardar perfil
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Obtener sociedades seleccionadas
            const societyIds = [...document.querySelectorAll('.society-input:checked')].map(c => parseInt(c.value));

            // Obtener habilidades seleccionadas
            const skillIds = [...document.querySelectorAll('.skill-chip.selected')].map(c => parseInt(c.dataset.id));

            // Construir fecha de graduacion
            let expectedGraduation = null;
            const gradInput = document.getElementById('expected_graduation').value;
            if (gradInput) {
                expectedGraduation = new Date(gradInput + '-01');
            }

            // Obtener email principal seleccionado
            const primaryEmailType = document.querySelector('input[name="primary_email_type"]:checked')?.value || 'email_personal';

            const data = {
                name: document.getElementById('name').value,
                nick: document.getElementById('nick').value || null,
                email_personal: document.getElementById('email_personal').value || null,
                email_institutional: document.getElementById('email_institutional').value || null,
                email_ieee: document.getElementById('email_ieee').value || null,
                primary_email_type: primaryEmailType,
                country_code: document.getElementById('country_code').value,
                phone: document.getElementById('phone').value || null,
                identification: document.getElementById('identification').value || null,
                birthday: document.getElementById('birthday').value || null,
                university_id: parseInt(document.getElementById('university_id').value) || 0,
                academic_program_id: parseInt(document.getElementById('academic_program_id').value) || 0,
                semester_range_id: parseInt(document.getElementById('semester_range_id').value) || 0,
                expected_graduation: expectedGraduation,
                english_level_id: parseInt(document.getElementById('english_level_id').value) || 0,
                is_professor: document.getElementById('is_professor').checked,
                ieee_membership_status_id: parseInt(document.getElementById('ieee_membership_status_id').value) || 0,
                ieee_member_id: document.getElementById('ieee_member_id').value || null,
                ieee_roles_history: document.getElementById('ieee_roles_history').value || null,
                ieee_society_ids: societyIds,
                interest_area_id: parseInt(document.getElementById('interest_area_id').value) || 0,
                availability_level_id: parseInt(document.getElementById('availability_level_id').value) || 0,
                preferred_channel_id: parseInt(document.getElementById('preferred_channel_id').value) || 0,
                goals_in_branch: document.getElementById('goals_in_branch').value || null,
                skill_ids: skillIds
            };

            try {
                const response = await fetch('/portal/profile', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Perfil actualizado exitosamente', 'success');
                    if (result.profile_completed) {
                        document.getElementById('profileBanner').classList.add('hidden');
                    }
                    loadProfile();
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Error al actualizar', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        });

        // Cambiar/crear contrasena
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const errorDiv = document.getElementById('passwordError');
            errorDiv.classList.add('hidden');

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Validar que coincidan
            if (newPassword !== confirmPassword) {
                errorDiv.textContent = 'Las contraseñas no coinciden';
                errorDiv.classList.remove('hidden');
                return;
            }

            // Validar longitud
            if (newPassword.length < 6) {
                errorDiv.textContent = 'La contraseña debe tener al menos 6 caracteres';
                errorDiv.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch('/portal/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    })
                });
                if (response.ok) {
                    const result = await response.json();
                    showNotification(result.message || 'Contraseña guardada', 'success');
                    closePasswordModal();
                    document.getElementById('passwordForm').reset();
                    // Actualizar estado local
                    currentProfile.has_password = true;
                } else {
                    const data = await response.json();
                    errorDiv.textContent = data.detail || 'Error al guardar';
                    errorDiv.classList.remove('hidden');
                }
            } catch (error) {
                errorDiv.textContent = 'Error de conexión';
                errorDiv.classList.remove('hidden');
            }
        });

        function showChangePassword() {
            const hasPassword = currentProfile.has_password;
            const modal = document.getElementById('passwordModal');
            const title = document.getElementById('passwordModalTitle');
            const desc = document.getElementById('passwordModalDesc');
            const errorDiv = document.getElementById('passwordError');

            // Limpiar
            document.getElementById('passwordForm').reset();
            errorDiv.classList.add('hidden');

            if (hasPassword) {
                title.textContent = 'Cambiar Contraseña';
                desc.textContent = 'Ingresa tu nueva contraseña.';
            } else {
                title.textContent = 'Crear Contraseña';
                desc.textContent = 'Crea una contraseña para acceder sin necesidad de código OTP.';
            }

            modal.classList.remove('hidden');
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 max-w-sm shadow-lg rounded-lg p-4 z-50 border-l-4 ${type === 'success' ? 'bg-green-50 text-green-800 border-green-500' : 'bg-red-50 text-red-800 border-red-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        // Actualizar información del email principal
        function updatePrimaryEmail() {
            const selected = document.querySelector('input[name="primary_email_type"]:checked');
            const infoDiv = document.getElementById('primaryEmailInfo');
            const textSpan = document.getElementById('primaryEmailText');

            if (!selected) {
                textSpan.textContent = 'Selecciona un correo como principal para recibir códigos OTP';
                return;
            }

            const emailTypes = {
                'email_personal': { label: 'Personal', input: 'email_personal' },
                'email_institutional': { label: 'Institucional', input: 'email_institutional' },
                'email_ieee': { label: 'IEEE', input: 'email_ieee' }
            };

            const type = emailTypes[selected.value];
            const emailValue = document.getElementById(type.input).value;

            if (emailValue) {
                textSpan.innerHTML = `<strong>Email principal:</strong> ${emailValue} (${type.label}) - Los códigos OTP llegarán a este correo`;
                infoDiv.className = 'text-xs text-green-700 bg-green-100 rounded px-3 py-2 mt-2';
            } else {
                textSpan.innerHTML = `<i class="fas fa-exclamation-triangle mr-1"></i> Ingresa tu correo ${type.label.toLowerCase()} para establecerlo como principal`;
                infoDiv.className = 'text-xs text-yellow-700 bg-yellow-100 rounded px-3 py-2 mt-2';
            }
        }

        // Actualizar al escribir en los campos de email
        document.addEventListener('DOMContentLoaded', function() {
            ['email_personal', 'email_institutional', 'email_ieee'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', updatePrimaryEmail);
                }
            });
        });

        // ========== FUNCIONES DE ESTUDIOS ==========
        let userStudies = [];

        async function loadStudies() {
            try {
                const response = await fetch('/portal/profile/studies', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (response.ok) {
                    userStudies = await response.json();
                    renderStudies();
                }
            } catch (error) {
                console.error('Error cargando estudios:', error);
            }
        }

        function renderStudies() {
            const container = document.getElementById('studies-list');
            const countBadge = document.getElementById('studies-count');

            countBadge.textContent = userStudies.length;

            if (userStudies.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-400 italic">No has agregado otros estudios aún.</p>';
                return;
            }

            const studyTypeLabels = {
                'tecnica': { label: 'Técnica', color: 'teal' },
                'tecnologia': { label: 'Tecnología', color: 'cyan' },
                'pregrado': { label: 'Pregrado', color: 'blue' },
                'posgrado': { label: 'Posgrado', color: 'purple' },
                'otro': { label: 'Otro', color: 'gray' }
            };

            const statusLabels = {
                'cursando': { label: 'Cursando', color: 'yellow', icon: 'fa-book-open' },
                'egresado': { label: 'Egresado', color: 'green', icon: 'fa-graduation-cap' },
                'sin_terminar': { label: 'Sin terminar', color: 'orange', icon: 'fa-pause-circle' }
            };

            container.innerHTML = userStudies.map(study => {
                const typeInfo = studyTypeLabels[study.study_type] || studyTypeLabels['otro'];
                const statusInfo = statusLabels[study.status] || statusLabels['cursando'];
                return `
                    <div class="flex items-start justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="text-xs px-2 py-0.5 rounded-full bg-${typeInfo.color}-100 text-${typeInfo.color}-700">${typeInfo.label}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full bg-${statusInfo.color}-100 text-${statusInfo.color}-700"><i class="fas ${statusInfo.icon} mr-1"></i>${statusInfo.label}</span>
                                ${study.is_primary ? '<span class="text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700"><i class="fas fa-star mr-1"></i>Principal</span>' : ''}
                            </div>
                            <p class="font-medium text-gray-800">${study.program_name}</p>
                            ${study.institution ? `<p class="text-sm text-gray-500"><i class="fas fa-university mr-1"></i>${study.institution}</p>` : ''}
                        </div>
                        <div class="flex gap-1">
                            <button onclick="openEditStudyModal(${study.id}, '${study.study_type}', '${study.program_name.replace(/'/g, "\\'")}', '${(study.institution || '').replace(/'/g, "\\'")}', '${study.status || 'cursando'}', ${study.is_primary})" class="text-blue-500 hover:text-blue-700 p-1" title="Editar estudio">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteStudy(${study.id})" class="text-red-500 hover:text-red-700 p-1" title="Eliminar estudio">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function addStudy() {
            const studyType = document.getElementById('new_study_type').value;
            const programName = document.getElementById('new_study_program').value.trim();
            const institution = document.getElementById('new_study_institution').value.trim();
            const status = document.getElementById('new_study_status').value;

            if (!studyType) {
                showNotification('Selecciona el tipo de estudio', 'error');
                return;
            }
            if (!programName) {
                showNotification('Ingresa el nombre del programa', 'error');
                return;
            }

            try {
                const response = await fetch('/portal/profile/studies', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        study_type: studyType,
                        program_name: programName,
                        institution: institution || null,
                        status: status || 'cursando',
                        is_primary: false
                    })
                });

                if (response.ok) {
                    showNotification('Estudio agregado exitosamente', 'success');
                    // Limpiar formulario
                    document.getElementById('new_study_type').value = '';
                    document.getElementById('new_study_program').value = '';
                    document.getElementById('new_study_institution').value = '';
                    document.getElementById('new_study_status').value = 'cursando';
                    // Recargar lista
                    await loadStudies();
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Error al agregar estudio', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        }

        async function deleteStudy(studyId) {
            if (!confirm('¿Estás seguro de eliminar este estudio?')) return;

            try {
                const response = await fetch(`/portal/profile/studies/${studyId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    showNotification('Estudio eliminado', 'success');
                    await loadStudies();
                } else {
                    showNotification('Error al eliminar estudio', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        }

        // ========== EDITAR ESTUDIO ==========
        let editingStudyId = null;

        function openEditStudyModal(studyId, studyType, programName, institution, status, isPrimary) {
            editingStudyId = studyId;
            document.getElementById('edit_study_type').value = studyType;
            document.getElementById('edit_study_program').value = programName;
            document.getElementById('edit_study_institution').value = institution || '';
            document.getElementById('edit_study_status').value = status || 'cursando';
            document.getElementById('edit_study_primary').checked = isPrimary;
            document.getElementById('editStudyModal').classList.remove('hidden');
        }

        function closeEditStudyModal() {
            document.getElementById('editStudyModal').classList.add('hidden');
            editingStudyId = null;
        }

        async function updateStudy() {
            if (!editingStudyId) return;

            const studyType = document.getElementById('edit_study_type').value;
            const programName = document.getElementById('edit_study_program').value.trim();
            const institution = document.getElementById('edit_study_institution').value.trim();
            const status = document.getElementById('edit_study_status').value;
            const isPrimary = document.getElementById('edit_study_primary').checked;

            if (!studyType) {
                showNotification('Selecciona el tipo de estudio', 'error');
                return;
            }
            if (!programName) {
                showNotification('Ingresa el nombre del programa', 'error');
                return;
            }

            try {
                const response = await fetch(`/portal/profile/studies/${editingStudyId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        study_type: studyType,
                        program_name: programName,
                        institution: institution || null,
                        status: status,
                        is_primary: isPrimary
                    })
                });

                if (response.ok) {
                    showNotification('Estudio actualizado exitosamente', 'success');
                    closeEditStudyModal();
                    await loadStudies();
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Error al actualizar estudio', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('user_access_token');
            localStorage.removeItem('user_data');
            window.location.href = '/portal/login';
        }

        // ========== IR A ADMIN (AUTO-LOGIN) ==========
        async function goToAdmin() {
            try {
                const response = await fetch('/portal/auth/admin-token', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Guardar token de admin (el admin usa 'access_token')
                    localStorage.setItem('access_token', data.access_token);
                    // Guardar el rol para que se muestre el menú correcto
                    localStorage.setItem('user_role', data.role.toLowerCase());
                    // Guardar permisos para filtrar menú
                    localStorage.setItem('user_permissions', JSON.stringify(data.permissions || {}));
                    localStorage.setItem('admin_user', JSON.stringify({
                        username: data.username,
                        full_name: data.full_name,
                        role: data.role
                    }));
                    // Ir al admin
                    window.location.href = '/admin';
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'No tienes acceso administrativo', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        }

        // ========== FOTO DE PERFIL ==========
        function updateProfilePhotoDisplay() {
            const img = document.getElementById('profilePhotoImg');
            const initial = document.getElementById('profilePhotoInitial');
            const deleteBtn = document.getElementById('deletePhotoBtn');

            if (currentProfile.photo_path) {
                img.src = currentProfile.photo_path;
                img.classList.remove('hidden');
                initial.classList.add('hidden');
                deleteBtn.classList.remove('hidden');
            } else {
                img.classList.add('hidden');
                initial.classList.remove('hidden');
                deleteBtn.classList.add('hidden');
                // Mostrar inicial del nombre
                if (currentProfile.name) {
                    initial.textContent = currentProfile.name.charAt(0).toUpperCase();
                }
            }
        }

        async function uploadProfilePhoto(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            const formData = new FormData();
            formData.append('photo', file);

            try {
                showNotification('Subiendo foto...', 'info');

                const response = await fetch('/portal/profile/photo', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    currentProfile.photo_path = result.photo_path;
                    updateProfilePhotoDisplay();
                    showNotification('Foto actualizada correctamente', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Error al subir la foto', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }

            // Limpiar input
            input.value = '';
        }

        async function deleteProfilePhoto() {
            if (!confirm('¿Estás seguro de eliminar tu foto de perfil?')) return;

            try {
                const response = await fetch('/portal/profile/photo', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    currentProfile.photo_path = null;
                    updateProfilePhotoDisplay();
                    showNotification('Foto eliminada', 'success');
                } else {
                    const error = await response.json();
                    showNotification(error.detail || 'Error al eliminar', 'error');
                }
            } catch (error) {
                showNotification('Error de conexión', 'error');
            }
        }

        // ============================================
        // Calendar (Birthdays + Events)
        // ============================================
        const MONTH_NAMES = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
        const DAY_NAMES = ['Lu','Ma','Mi','Ju','Vi','Sa','Do'];
        let allBirthdays = [];
        let allEvents = [];
        let birthdaysLoaded = false;

        async function loadBirthdays() {
            try {
                const headers = { 'Authorization': `Bearer ${localStorage.getItem('user_access_token')}` };
                const [bRes, eRes] = await Promise.all([
                    fetch('/portal/birthdays', { headers }),
                    fetch('/portal/events', { headers })
                ]);
                if (bRes.ok) allBirthdays = await bRes.json();
                if (eRes.ok) allEvents = await eRes.json();
                birthdaysLoaded = true;
                renderCalendar();
            } catch (error) {
                console.error('Error cargando calendario:', error);
            }
        }

        function renderCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            document.getElementById('calYearTitle').textContent = year;

            // Today alert
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();
            const todayBdays = allBirthdays.filter(b => b.month === todayMonth && b.day === todayDay);
            const todayEvts = allEvents.filter(e => {
                const d = new Date(e.event_date);
                return d.getFullYear() === year && d.getMonth() + 1 === todayMonth && d.getDate() === todayDay;
            });
            const alertEl = document.getElementById('todayAlert');
            if (todayBdays.length > 0 || todayEvts.length > 0) {
                alertEl.classList.remove('hidden');
                let html = '<i class="fas fa-star text-yellow-500 mr-1"></i><strong>Hoy:</strong> ';
                if (todayBdays.length > 0) html += '<i class="fas fa-birthday-cake text-pink-500 mx-1"></i>' + todayBdays.map(b => b.name).join(', ');
                if (todayEvts.length > 0) html += (todayBdays.length ? ' &bull; ' : '') + '<i class="fas fa-calendar-check text-ieee mx-1"></i>' + todayEvts.map(e => e.name).join(', ');
                document.getElementById('todayAlertContent').innerHTML = html;
            }

            // Render 12 months
            const grid = document.getElementById('yearCalendarGrid');
            grid.innerHTML = '';
            for (let m = 0; m < 12; m++) {
                grid.innerHTML += renderMiniMonth(year, m, today);
            }

            renderUpcoming(today);
        }

        function renderMiniMonth(year, monthIdx, today) {
            const month = monthIdx + 1;
            const isCurrentMonth = (today.getFullYear() === year && today.getMonth() === monthIdx);
            const firstDay = new Date(year, monthIdx, 1);
            let startDay = firstDay.getDay() - 1;
            if (startDay < 0) startDay = 6; // Monday-based
            const daysInMonth = new Date(year, monthIdx + 1, 0).getDate();

            const headerBg = isCurrentMonth ? 'bg-ieee text-white' : 'bg-gray-100 text-gray-700';

            let html = `<div class="bg-white rounded-lg shadow-sm overflow-hidden border ${isCurrentMonth ? 'border-ieee' : 'border-gray-200'}">`;
            html += `<div class="${headerBg} px-3 py-2 text-center font-bold text-sm">${MONTH_NAMES[monthIdx]}</div>`;
            html += '<div class="p-2">';
            // Day headers
            html += '<div class="grid grid-cols-7 gap-0 mb-1">';
            DAY_NAMES.forEach(d => { html += `<div class="text-center text-xs text-gray-400 font-medium">${d}</div>`; });
            html += '</div>';
            // Days grid
            html += '<div class="grid grid-cols-7 gap-0">';
            for (let i = 0; i < startDay; i++) html += '<div></div>';
            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = isCurrentMonth && d === today.getDate();
                const hasBday = allBirthdays.some(b => b.month === month && b.day === d);
                const hasEvent = allEvents.some(e => {
                    const ed = new Date(e.event_date);
                    return ed.getFullYear() === year && ed.getMonth() + 1 === month && ed.getDate() === d;
                });
                const hasData = hasBday || hasEvent;

                let cls = 'relative flex flex-col items-center justify-center text-xs h-7 rounded';
                if (isToday) cls += ' bg-ieee text-white font-bold';
                else if (hasData) cls += ' cursor-pointer hover:bg-gray-100';
                else cls += ' text-gray-600';

                const onclick = hasData ? `onclick="showDayDetail(${year},${month},${d})"` : '';

                html += `<div class="${cls}" ${onclick}>${d}`;
                if (hasBday || hasEvent) {
                    html += '<div class="flex gap-0.5 absolute -bottom-0.5">';
                    if (hasBday) html += '<span class="w-1 h-1 rounded-full bg-pink-400"></span>';
                    if (hasEvent) html += '<span class="w-1 h-1 rounded-full bg-yellow-500"></span>';
                    html += '</div>';
                }
                html += '</div>';
            }
            html += '</div></div></div>';
            return html;
        }

        function showDayDetail(year, month, day) {
            const monthName = MONTH_NAMES[month - 1];
            document.getElementById('dayDetailTitle').textContent = `${day} de ${monthName}`;
            const bdays = allBirthdays.filter(b => b.month === month && b.day === day);
            const evts = allEvents.filter(e => {
                const d = new Date(e.event_date);
                return d.getFullYear() === year && d.getMonth() + 1 === month && d.getDate() === day;
            });
            let html = '';
            if (bdays.length > 0) {
                html += '<div class="mb-3"><p class="text-xs font-bold text-pink-600 mb-1"><i class="fas fa-birthday-cake mr-1"></i>Cumplea&ntilde;os</p>';
                bdays.forEach(b => {
                    html += `<div class="flex items-center gap-2 mb-1">${renderAvatar(b, 'w-7 h-7 text-xs')}<div><p class="text-sm font-medium">${b.name}</p><p class="text-xs text-gray-500">${b.academic_program || ''}</p></div></div>`;
                });
                html += '</div>';
            }
            if (evts.length > 0) {
                html += '<div><p class="text-xs font-bold text-ieee mb-1"><i class="fas fa-calendar-check mr-1"></i>Eventos</p>';
                evts.forEach(e => {
                    const typeIcon = e.event_type === 'organized' ? 'fa-users' : 'fa-handshake';
                    html += `<div class="mb-1 p-2 bg-blue-50 rounded"><p class="text-sm font-medium"><i class="fas ${typeIcon} text-ieee mr-1"></i>${e.name}</p>${e.location ? `<p class="text-xs text-gray-500"><i class="fas fa-map-marker-alt mr-1"></i>${e.location}</p>` : ''}</div>`;
                });
                html += '</div>';
            }
            document.getElementById('dayDetailContent').innerHTML = html;
            document.getElementById('dayDetailPopup').classList.remove('hidden');
        }

        function closeDayDetail() {
            document.getElementById('dayDetailPopup').classList.add('hidden');
        }

        function renderAvatar(b, sizeClass) {
            if (b.photo_path) {
                const src = b.photo_path.startsWith('/') ? b.photo_path : '/' + b.photo_path;
                return `<img src="${src}" class="${sizeClass} rounded-full object-cover" alt="${b.name}">`;
            }
            const initial = b.name.charAt(0).toUpperCase();
            const colors = ['bg-blue-500','bg-green-500','bg-purple-500','bg-pink-500','bg-indigo-500','bg-teal-500','bg-orange-500','bg-red-500'];
            const color = colors[initial.charCodeAt(0) % colors.length];
            return `<div class="${sizeClass} rounded-full ${color} text-white flex items-center justify-center font-bold">${initial}</div>`;
        }

        function renderUpcoming(today) {
            const todayMonth = today.getMonth() + 1;
            const todayDay = today.getDate();

            // Upcoming birthdays (next 30 days, circular)
            const upBdays = [...allBirthdays].sort((a, b) => {
                const da = ((a.month - todayMonth + 12) % 12) * 31 + (a.day - todayDay);
                const db = ((b.month - todayMonth + 12) % 12) * 31 + (b.day - todayDay);
                return (da <= 0 ? da + 365 : da) - (db <= 0 ? db + 365 : db);
            }).slice(0, 5);

            document.getElementById('upcomingBirthdays').innerHTML = upBdays.length === 0
                ? '<p class="text-gray-400 text-sm text-center py-4">Sin datos</p>'
                : upBdays.map(b => `
                    <div class="flex items-center gap-2 p-2 rounded hover:bg-pink-50">
                        ${renderAvatar(b, 'w-8 h-8 text-xs')}
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate">${b.name}</p>
                            <p class="text-xs text-gray-500">${b.day} de ${MONTH_NAMES[b.month - 1]}</p>
                        </div>
                    </div>`).join('');

            // Upcoming events
            const now = today.getTime();
            const upEvts = allEvents
                .filter(e => new Date(e.event_date).getTime() >= now - 86400000)
                .sort((a, b) => new Date(a.event_date) - new Date(b.event_date))
                .slice(0, 5);

            document.getElementById('upcomingEvents').innerHTML = upEvts.length === 0
                ? '<p class="text-gray-400 text-sm text-center py-4">No hay eventos pr&oacute;ximos</p>'
                : upEvts.map(e => {
                    const d = new Date(e.event_date);
                    const isPast = d.getTime() < now;
                    const typeIcon = e.event_type === 'organized' ? 'fa-users' : 'fa-handshake';
                    return `
                    <div class="flex items-center gap-2 p-2 rounded hover:bg-blue-50 ${isPast ? 'opacity-60' : ''}">
                        <div class="w-10 h-10 rounded-lg ${isPast ? 'bg-gray-100' : 'bg-ieee bg-opacity-10'} flex flex-col items-center justify-center text-xs">
                            <span class="font-bold ${isPast ? 'text-gray-500' : 'text-ieee'}">${d.getDate()}</span>
                            <span class="text-gray-500" style="font-size:9px">${MONTH_NAMES[d.getMonth()].substring(0,3)}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium truncate"><i class="fas ${typeIcon} text-ieee mr-1"></i>${e.name}</p>
                            <p class="text-xs text-gray-500 truncate">${e.location || ''}</p>
                        </div>
                    </div>`;
                }).join('');
        }
    </script>

    <!-- Modal Editar Estudio -->
    <div id="editStudyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
            <div class="flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-edit text-purple-600 mr-2"></i>Editar Estudio
                </h3>
                <button onclick="closeEditStudyModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Estudio *</label>
                    <select id="edit_study_type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="">Seleccionar...</option>
                        <option value="tecnica">Técnica</option>
                        <option value="tecnologia">Tecnología</option>
                        <option value="pregrado">Pregrado</option>
                        <option value="posgrado">Posgrado</option>
                        <option value="otro">Otro (diplomado, certificación, etc.)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Programa *</label>
                    <input type="text" id="edit_study_program" placeholder="Ej: Ingeniería de Sistemas" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado *</label>
                    <select id="edit_study_status" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="cursando">Cursando</option>
                        <option value="egresado">Egresado</option>
                        <option value="sin_terminar">Sin terminar</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Institución</label>
                    <input type="text" id="edit_study_institution" placeholder="Universidad de Bogotá Jorge Tadeo Lozano" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="edit_study_primary" class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
                    <label for="edit_study_primary" class="ml-2 text-sm text-gray-700">Marcar como estudio principal</label>
                </div>
            </div>
            <div class="flex gap-3 p-4 border-t bg-gray-50 rounded-b-xl">
                <button onclick="closeEditStudyModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition">
                    Cancelar
                </button>
                <button onclick="updateStudy()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-save mr-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
