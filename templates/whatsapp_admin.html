{% extends "base.html" %}

{% block title %}Gesti√≥n de WhatsApp - IEEE Tadeo Control System{% endblock %}

{% block extra_css %}
<style>
    .whatsapp-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .tabs {
        display: flex;
        gap: 5px;
        border-bottom: 2px solid #e5e7eb;
        margin-bottom: 20px;
    }

    .tab {
        padding: 12px 24px;
        cursor: pointer;
        border: none;
        background: none;
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        transition: all 0.2s;
    }

    .tab:hover {
        color: #25D366;
    }

    .tab.active {
        color: #25D366;
        border-bottom-color: #25D366;
    }

    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    .status-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .status-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
    }

    .status-indicator {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: bold;
    }

    .status-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    .status-dot.ready { background: #25D366; }
    .status-dot.error { background: #dc3545; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .api-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .api-info-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 8px;
    }

    .api-info-label {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 4px;
    }

    .api-info-value {
        font-weight: 600;
        color: #1f2937;
    }

    .quality-badge {
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
    }

    .quality-badge.green { background: #d4edda; color: #155724; }
    .quality-badge.yellow { background: #fff3cd; color: #856404; }
    .quality-badge.red { background: #f8d7da; color: #721c24; }

    .meta-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #0668E1 0%, #1877F2 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 16px;
        font-weight: 600;
        font-size: 12px;
    }

    /* Templates Section */
    .templates-grid {
        display: grid;
        gap: 15px;
    }

    .template-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 20px;
    }

    .template-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
    }

    .template-name {
        font-weight: 600;
        font-size: 16px;
        color: #1f2937;
    }

    .template-status {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }

    .template-status.approved { background: #d4edda; color: #155724; }
    .template-status.pending { background: #fff3cd; color: #856404; }
    .template-status.rejected { background: #f8d7da; color: #721c24; }

    .template-body {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        font-size: 13px;
        color: #4b5563;
        white-space: pre-wrap;
        margin-bottom: 12px;
    }

    .template-meta {
        display: flex;
        gap: 15px;
        font-size: 12px;
        color: #6b7280;
    }

    /* Template Details Styles */
    .template-components {
        border-top: 1px solid #e5e7eb;
        margin-top: 12px;
        padding-top: 12px;
    }

    .template-component {
        margin-bottom: 10px;
    }

    .template-component-label {
        font-size: 11px;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .template-component-content {
        background: #f8f9fa;
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 13px;
        color: #374151;
        white-space: pre-wrap;
    }

    .template-header-image {
        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: #4338ca;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .template-variables {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
    }

    .template-variable-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }

    .template-variable-badge code {
        background: #bfdbfe;
        padding: 1px 4px;
        border-radius: 3px;
        font-family: monospace;
    }

    .template-preview-toggle {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: 1px solid #e5e7eb;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        color: #6b7280;
        cursor: pointer;
        transition: all 0.2s;
        margin-top: 10px;
    }

    .template-preview-toggle:hover {
        background: #f3f4f6;
        color: #374151;
    }

    .template-preview-section {
        display: none;
        margin-top: 12px;
        border: 2px dashed #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        background: #fafafa;
    }

    .template-preview-section.show {
        display: block;
    }

    .template-preview-phone {
        max-width: 320px;
        margin: 0 auto;
        background: #e5ddd5;
        border-radius: 10px;
        padding: 15px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .template-preview-bubble {
        background: white;
        border-radius: 8px;
        padding: 10px 12px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        font-size: 14px;
        line-height: 1.4;
    }

    .template-preview-bubble .header {
        font-weight: 600;
        margin-bottom: 6px;
        color: #1f2937;
    }

    .template-preview-bubble .body {
        color: #374151;
        white-space: pre-wrap;
    }

    .template-preview-bubble .footer {
        margin-top: 8px;
        font-size: 12px;
        color: #9ca3af;
    }

    .template-preview-bubble .buttons {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #e5e7eb;
    }

    .template-preview-bubble .buttons button {
        width: 100%;
        background: none;
        border: none;
        color: #25D366;
        font-weight: 500;
        padding: 8px;
        cursor: default;
    }

    /* Conversations/Inbox */
    .inbox-container {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 20px;
        height: 600px;
    }

    .conversations-list {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .conversations-header {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        font-weight: 600;
    }

    .conversations-scroll {
        flex: 1;
        overflow-y: auto;
    }

    .conversation-item {
        padding: 15px;
        border-bottom: 1px solid #f3f4f6;
        cursor: pointer;
        transition: background 0.2s;
    }

    .conversation-item:hover {
        background: #f9fafb;
    }

    .conversation-item.active {
        background: #ecfdf5;
        border-left: 3px solid #25D366;
    }

    .conversation-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
    }

    .conversation-preview {
        font-size: 13px;
        color: #6b7280;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .conversation-time {
        font-size: 11px;
        color: #9ca3af;
    }

    .unread-badge {
        background: #25D366;
        color: white;
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
    }

    .chat-container {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .chat-header {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f0f2f5;
    }

    .message-bubble {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 12px;
        margin-bottom: 10px;
        font-size: 14px;
    }

    .message-bubble.received {
        background: white;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }

    .message-bubble.sent {
        background: #dcf8c6;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }

    .message-time {
        font-size: 11px;
        color: #6b7280;
        margin-top: 4px;
    }

    .chat-input-container {
        padding: 15px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 10px;
    }

    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
    }

    .chat-input:focus {
        border-color: #25D366;
    }

    /* Buttons */
    .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border: none;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background: #25D366;
        color: white;
    }

    .btn-primary:hover {
        background: #1da851;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-secondary:hover {
        background: #4b5563;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
    }

    /* Forms */
    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 6px;
        color: #374151;
    }

    .form-control {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
    }

    .form-control:focus {
        outline: none;
        border-color: #25D366;
        box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
    }

    .form-select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        background: white;
    }

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        padding: 24px;
        width: 100%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .modal-title {
        font-size: 18px;
        font-weight: 600;
    }

    .modal-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #6b7280;
    }

    /* Alert */
    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 15px;
        font-size: 14px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert-warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }

    .empty-state i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }
</style>
{% endblock %}

{% block content %}
<div class="whatsapp-container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1 style="margin: 0;">
            <i class="fab fa-whatsapp" style="color: #25D366;"></i> Gesti√≥n de WhatsApp
        </h1>
        <span class="meta-badge">
            <i class="fab fa-meta"></i> Meta Cloud API
        </span>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer"></div>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" data-tab="status">Estado</button>
        <button class="tab" data-tab="inbox">
            Bandeja de Entrada
            <span class="unread-badge" id="totalUnread" style="display: none;">0</span>
        </button>
        <button class="tab" data-tab="templates">Templates</button>
        <button class="tab" data-tab="test">Probar</button>
    </div>

    <!-- Status Tab -->
    <div class="tab-content active" id="tab-status">
        <div class="status-card">
            <div class="status-header">
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Verificando conexi√≥n...</span>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="refreshStatus()">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
            </div>

            <div class="api-info-grid" id="apiInfoGrid" style="display: none;">
                <div class="api-info-item">
                    <div class="api-info-label">N√∫mero</div>
                    <div class="api-info-value" id="phoneNumber">-</div>
                </div>
                <div class="api-info-item">
                    <div class="api-info-label">Nombre Verificado</div>
                    <div class="api-info-value" id="verifiedName">-</div>
                </div>
                <div class="api-info-item">
                    <div class="api-info-label">Calidad</div>
                    <div class="api-info-value">
                        <span class="quality-badge green" id="qualityRating">-</span>
                    </div>
                </div>
                <div class="api-info-item">
                    <div class="api-info-label">Plataforma</div>
                    <div class="api-info-value" id="platformType">CLOUD_API</div>
                </div>
            </div>

            <div id="errorInfo" style="display: none; color: #dc3545; margin-top: 10px;">
                <i class="fas fa-exclamation-triangle"></i>
                <span id="errorMessage"></span>
            </div>
        </div>

        <div class="status-card">
            <h3 style="margin-top: 0;">Informaci√≥n sobre Meta Cloud API</h3>
            <ul style="color: #4b5563; line-height: 1.8;">
                <li>Esta integraci√≥n usa la <strong>API oficial de WhatsApp Business</strong> de Meta</li>
                <li>No requiere mantener un tel√©fono conectado ni escanear c√≥digos QR</li>
                <li>Para enviar mensajes a usuarios nuevos, debes usar <strong>Message Templates</strong> aprobados</li>
                <li>Los mensajes de texto libre solo funcionan si el usuario escribi√≥ en las √∫ltimas 24 horas</li>
            </ul>
        </div>
    </div>

    <!-- Inbox Tab -->
    <div class="tab-content" id="tab-inbox">
        <div class="inbox-container">
            <div class="conversations-list">
                <div class="conversations-header">
                    <i class="fas fa-inbox"></i> Conversaciones
                </div>
                <div class="conversations-scroll" id="conversationsList">
                    <div class="empty-state">
                        <i class="fas fa-comments"></i>
                        <p>No hay conversaciones</p>
                    </div>
                </div>
            </div>

            <div class="chat-container">
                <div class="chat-header" id="chatHeader">
                    <div>
                        <div style="font-weight: 600;" id="chatContactName">Selecciona una conversaci√≥n</div>
                        <div style="font-size: 12px; color: #6b7280;" id="chatContactPhone"></div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="empty-state">
                        <i class="fab fa-whatsapp"></i>
                        <p>Selecciona una conversaci√≥n para ver los mensajes</p>
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="replyInput" placeholder="Escribe un mensaje..." disabled>
                    <button class="btn btn-primary" onclick="sendReply()" id="sendBtn" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Templates Tab -->
    <div class="tab-content" id="tab-templates">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Message Templates</h3>
            <button class="btn btn-primary" onclick="openCreateTemplateModal()">
                <i class="fas fa-plus"></i> Crear Template
            </button>
        </div>

        <div class="alert alert-warning">
            <i class="fas fa-info-circle"></i>
            Los templates nuevos deben ser aprobados por Meta antes de poder usarlos (24-48 horas).
        </div>

        <div class="templates-grid" id="templatesList">
            <div class="empty-state">
                <i class="fas fa-file-alt"></i>
                <p>Cargando templates...</p>
            </div>
        </div>
    </div>

    <!-- Test Tab -->
    <div class="tab-content" id="tab-test">
        <div class="status-card">
            <h3 style="margin-top: 0;"><i class="fas fa-paper-plane"></i> Enviar Mensaje de Prueba</h3>

            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Importante:</strong> Los mensajes de texto libre solo llegar√°n si el destinatario ha escrito
                al n√∫mero +57 305 4497235 en las √∫ltimas 24 horas. De lo contrario, usa un Template.
            </div>

            <div class="form-group">
                <label class="form-label">Tipo de mensaje</label>
                <select class="form-select" id="testMessageType" onchange="toggleTestForm()">
                    <option value="template">Usar Template (recomendado)</option>
                    <option value="text">Texto libre (solo ventana 24h)</option>
                </select>
            </div>

            <div id="templateTestForm">
                <div class="form-group">
                    <label class="form-label">Template</label>
                    <select class="form-select" id="testTemplate" onchange="onTestTemplateChange()">
                        <option value="">Cargando templates...</option>
                    </select>
                </div>

                <!-- Variables din√°micas seg√∫n el template -->
                <div id="templateVariablesSection" style="display: none;">
                    <div class="alert alert-warning" style="font-size: 13px;">
                        <i class="fas fa-info-circle"></i>
                        Este template requiere variables. Completa los campos:
                    </div>
                    <div id="templateVariablesFields"></div>
                </div>

                <!-- Header de imagen (si aplica) -->
                <div id="templateImageSection" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Imagen de Header (URL p√∫blica)</label>
                        <input type="text" class="form-control" id="testHeaderImageUrl"
                               placeholder="https://ejemplo.com/imagen.jpg">
                        <small style="color: #6b7280;">Opcional: URL p√∫blica de la imagen para el header</small>
                    </div>
                </div>
            </div>

            <div id="textTestForm" style="display: none;">
                <div class="form-group">
                    <label class="form-label">Mensaje</label>
                    <textarea class="form-control" id="testMessage" rows="4" placeholder="Escribe tu mensaje...">Hola! Este es un mensaje de prueba desde IEEE Tadeo Control System.</textarea>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">N√∫mero de tel√©fono (con c√≥digo de pa√≠s)</label>
                <input type="text" class="form-control" id="testPhone" placeholder="573001234567">
            </div>

            <button class="btn btn-primary" onclick="sendTestMessage()">
                <i class="fas fa-paper-plane"></i> Enviar Mensaje
            </button>
        </div>
    </div>
</div>

<!-- Create Template Modal -->
<div class="modal" id="createTemplateModal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 class="modal-title">Crear Template de WhatsApp</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <form id="createTemplateForm" onsubmit="createTemplate(event)">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Nombre del template *</label>
                    <input type="text" class="form-control" id="templateName" required
                           pattern="[a-z0-9_]+" title="Solo min√∫sculas, n√∫meros y guion bajo"
                           placeholder="mi_template_ejemplo">
                    <small style="color: #6b7280;">Solo min√∫sculas, n√∫meros y guion bajo (_)</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Nombre para mostrar *</label>
                    <input type="text" class="form-control" id="templateDisplayName" required
                           placeholder="Mi Template de Ejemplo">
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label class="form-label">Categor√≠a *</label>
                    <select class="form-select" id="templateCategory" required onchange="onCategoryChange()">
                        <option value="UTILITY">Utilidad (confirmaciones, notificaciones)</option>
                        <option value="MARKETING">Marketing (promociones, ofertas)</option>
                        <option value="AUTHENTICATION">Autenticaci√≥n (c√≥digos OTP)</option>
                    </select>
                    <small id="categoryHelp" style="color: #6b7280;">Para confirmaciones de eventos, recordatorios</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Idioma *</label>
                    <select class="form-select" id="templateLanguage" required>
                        <option value="es_MX">Espa√±ol (M√©xico/Latinoam√©rica)</option>
                        <option value="es">Espa√±ol (Espa√±a)</option>
                        <option value="en_US">Ingl√©s (US)</option>
                    </select>
                </div>
            </div>

            <!-- Header Section -->
            <div class="form-group" id="headerSection">
                <label class="form-label">Encabezado (Header)</label>
                <select class="form-select" id="templateHeaderType" onchange="onHeaderTypeChange()">
                    <option value="NONE">Sin encabezado</option>
                    <option value="TEXT">Texto</option>
                    <option value="IMAGE">Imagen (para QR o banners)</option>
                </select>

                <div id="headerTextInput" style="display: none; margin-top: 10px;">
                    <input type="text" class="form-control" id="templateHeaderText"
                           placeholder="Registro Confirmado">
                    <small style="color: #dc3545;">‚ö†Ô∏è Sin emojis, asteriscos ni saltos de l√≠nea en el encabezado</small>
                </div>

                <div id="headerImageInput" style="display: none; margin-top: 10px;">
                    <!-- Info: Image headers -->
                    <div id="imageHeaderWarning" style="margin-bottom: 12px; padding: 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px;">
                        <div style="display: flex; align-items: flex-start; gap: 10px;">
                            <i class="fas fa-info-circle" style="color: #2563eb; font-size: 18px; margin-top: 2px;"></i>
                            <div>
                                <p style="margin: 0 0 6px 0; font-weight: 600; color: #1e40af;">Headers con imagen</p>
                                <p style="margin: 0; font-size: 13px; color: #1e3a8a;">
                                    La imagen que subas se usar√° como <strong>ejemplo</strong> para que Meta apruebe el template.
                                    Al enviar mensajes, podr√°s usar cualquier imagen (ej: QR del ticket).
                                    <br><strong>Recomendado:</strong> Usa una imagen representativa de lo que enviar√°s.
                                </p>
                            </div>
                        </div>
                    </div>
                    <!-- Image Upload Area -->
                    <div id="imageUploadArea" style="background: #f0f9ff; border: 2px dashed #3b82f6; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('headerImageFile').click()">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #3b82f6; margin-bottom: 10px;"></i>
                        <p style="margin: 0; color: #1e40af; font-weight: 500;">Haz clic para subir imagen de referencia</p>
                        <small style="color: #6b7280;">PNG, JPG hasta 5MB - Se optimizar√° autom√°ticamente</small>
                        <input type="file" id="headerImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    </div>

                    <!-- Image Preview -->
                    <div id="imagePreviewContainer" style="display: none; margin-top: 10px;">
                        <div style="position: relative; display: inline-block; max-width: 100%;">
                            <img id="imagePreview" style="max-width: 300px; max-height: 200px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <button type="button" onclick="removeHeaderImage()" style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 12px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="imageInfo" style="margin-top: 8px; font-size: 12px; color: #6b7280;"></div>
                    </div>

                    <!-- Image optimization info -->
                    <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; font-size: 12px;">
                        <i class="fas fa-info-circle" style="color: #d97706;"></i>
                        <span style="color: #92400e;">
                            <strong>Nota:</strong> La imagen se guardar√° como referencia. Al enviar el mensaje,
                            deber√°s proporcionar la imagen real (ej: QR del ticket).
                        </span>
                    </div>
                </div>
            </div>

            <!-- Body Section -->
            <div class="form-group">
                <label class="form-label">Cuerpo del mensaje *</label>
                <textarea class="form-control" id="templateBody" rows="5" required
                          oninput="updateVariablesList(); updatePreview();"
                          placeholder="üé´ ¬°Hola {{1}}! Tu registro para {{2}} ha sido confirmado.

üìÖ Fecha: {{3}}
üìç Lugar: {{4}}

¬°Te esperamos!"></textarea>
                <small style="color: #6b7280;">
                    Usa <code>&#123;&#123;1&#125;&#125;</code>, <code>&#123;&#123;2&#125;&#125;</code>, etc. para variables.
                    Puedes usar emojis en el cuerpo ‚úÖ
                </small>
            </div>

            <!-- Variables Section -->
            <div class="form-group" id="variablesSection" style="display: none;">
                <label class="form-label">
                    <i class="fas fa-code"></i> Variables detectadas
                    <small style="font-weight: normal; color: #6b7280;">(proporciona ejemplos para Meta)</small>
                </label>
                <div id="variablesList" style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <!-- Variables will be listed here -->
                </div>
            </div>

            <!-- Footer Section -->
            <div class="form-group">
                <label class="form-label">Footer (opcional)</label>
                <input type="text" class="form-control" id="templateFooter"
                       placeholder="IEEE Tadeo Student Branch" value="IEEE Tadeo Student Branch"
                       oninput="updatePreview()">
            </div>

            <!-- Preview Section -->
            <div class="form-group">
                <label class="form-label"><i class="fab fa-whatsapp"></i> Vista previa</label>
                <div style="background: #e5ddd5; border-radius: 8px; padding: 20px;">
                    <div style="background: white; border-radius: 8px; padding: 12px; max-width: 300px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">
                        <div id="previewHeader" style="font-weight: bold; margin-bottom: 8px; display: none;"></div>
                        <div id="previewBody" style="white-space: pre-wrap; font-size: 14px; color: #303030;">
                            Tu mensaje aparecer√° aqu√≠...
                        </div>
                        <div id="previewFooter" style="font-size: 12px; color: #8696a0; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e9edef;">
                            IEEE Tadeo Student Branch
                        </div>
                    </div>
                </div>
            </div>

            <!-- Authentication Warning -->
            <div id="authWarning" style="display: none;" class="alert alert-warning">
                <i class="fas fa-key"></i>
                <strong>Templates de Autenticaci√≥n:</strong> Tienen formato fijo de Meta con bot√≥n "Copiar c√≥digo".
                El mensaje ser√°: "Tu c√≥digo de verificaci√≥n es [c√≥digo]"
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Crear y Enviar a Meta
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentConversation = null;
let templates = [];

// Tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');

        // Load data when switching tabs
        if (tab.dataset.tab === 'inbox') loadConversations();
        if (tab.dataset.tab === 'templates') loadTemplates();
    });
});

// Show alert
function showAlert(message, type = 'success') {
    const container = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
    container.innerHTML = '';
    container.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

// Status functions
async function refreshStatus() {
    try {
        const response = await fetch('/whatsapp/status');
        const data = await response.json();

        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const apiInfoGrid = document.getElementById('apiInfoGrid');
        const errorInfo = document.getElementById('errorInfo');

        if (data.ready) {
            statusDot.className = 'status-dot ready';
            statusText.textContent = 'API Conectada';
            apiInfoGrid.style.display = 'grid';
            errorInfo.style.display = 'none';

            document.getElementById('phoneNumber').textContent = data.phone_number || '-';
            document.getElementById('verifiedName').textContent = data.verified_name || '-';
            document.getElementById('platformType').textContent = data.platform_type || 'CLOUD_API';

            const qualityBadge = document.getElementById('qualityRating');
            const quality = data.quality_rating || 'N/A';
            qualityBadge.textContent = quality;
            qualityBadge.className = 'quality-badge ' + (quality === 'GREEN' ? 'green' : quality === 'YELLOW' ? 'yellow' : 'green');
        } else {
            statusDot.className = 'status-dot error';
            statusText.textContent = 'Error de Conexi√≥n';
            apiInfoGrid.style.display = 'none';
            errorInfo.style.display = 'block';
            document.getElementById('errorMessage').textContent = data.error || 'Error desconocido';
        }
    } catch (error) {
        console.error('Error:', error);
    }
}

// Conversations/Inbox functions
async function loadConversations() {
    try {
        const response = await fetch('/whatsapp/conversations');
        const data = await response.json();

        const container = document.getElementById('conversationsList');

        if (data.conversations.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-comments"></i><p>No hay conversaciones</p></div>';
            return;
        }

        container.innerHTML = data.conversations.map(conv => `
            <div class="conversation-item ${currentConversation === conv.phone_number ? 'active' : ''}"
                 onclick="selectConversation('${conv.phone_number}', '${conv.contact_name || conv.phone_number}')">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div class="conversation-name">${conv.contact_name || conv.phone_number}</div>
                    ${conv.unread_count > 0 ? `<span class="unread-badge">${conv.unread_count}</span>` : ''}
                </div>
                <div class="conversation-time">${conv.last_message_at ? new Date(conv.last_message_at).toLocaleString() : ''}</div>
            </div>
        `).join('');

        // Update total unread
        const totalUnread = data.conversations.reduce((sum, c) => sum + c.unread_count, 0);
        const badge = document.getElementById('totalUnread');
        if (totalUnread > 0) {
            badge.textContent = totalUnread;
            badge.style.display = 'inline';
        } else {
            badge.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading conversations:', error);
    }
}

async function selectConversation(phone, name) {
    currentConversation = phone;
    document.getElementById('chatContactName').textContent = name;
    document.getElementById('chatContactPhone').textContent = phone;
    document.getElementById('replyInput').disabled = false;
    document.getElementById('sendBtn').disabled = false;

    // Update active state
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
        if (item.onclick.toString().includes(phone)) {
            item.classList.add('active');
        }
    });

    // Load messages
    try {
        const response = await fetch(`/whatsapp/conversations/${phone}/messages`);
        const data = await response.json();

        const container = document.getElementById('chatMessages');

        if (data.messages.length === 0) {
            container.innerHTML = '<div class="empty-state"><p>No hay mensajes</p></div>';
            return;
        }

        // Reverse to show oldest first
        const messages = data.messages.reverse();

        container.innerHTML = messages.map(msg => `
            <div class="message-bubble received">
                <div>${msg.text_body || msg.caption || `[${msg.message_type}]`}</div>
                <div class="message-time">${new Date(msg.timestamp).toLocaleString()}</div>
            </div>
        `).join('');

        container.scrollTop = container.scrollHeight;

        // Reload conversations to update unread count
        loadConversations();
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

async function sendReply() {
    if (!currentConversation) return;

    const input = document.getElementById('replyInput');
    const message = input.value.trim();
    if (!message) return;

    try {
        const response = await fetch(`/whatsapp/conversations/${currentConversation}/reply`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: currentConversation, message })
        });

        const data = await response.json();

        if (data.success) {
            // Add message to chat
            const container = document.getElementById('chatMessages');
            container.innerHTML += `
                <div class="message-bubble sent">
                    <div>${message}</div>
                    <div class="message-time">${new Date().toLocaleString()}</div>
                </div>
            `;
            container.scrollTop = container.scrollHeight;
            input.value = '';
        } else {
            showAlert(data.error || 'Error al enviar mensaje', 'error');
        }
    } catch (error) {
        showAlert('Error de conexi√≥n', 'error');
    }
}

// Enter key to send
document.getElementById('replyInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendReply();
});

// Templates functions
let headerImageData = null; // Store the uploaded image data

function toggleTemplatePreview(index) {
    const preview = document.getElementById(`templatePreview${index}`);
    const btn = preview.previousElementSibling;

    if (preview.classList.contains('show')) {
        preview.classList.remove('show');
        btn.innerHTML = '<i class="fas fa-mobile-alt"></i> Ver preview';
    } else {
        preview.classList.add('show');
        btn.innerHTML = '<i class="fas fa-times"></i> Ocultar preview';
    }
}

// Image upload and optimization functions
async function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    // Validate file type
    if (!file.type.startsWith('image/')) {
        showAlert('Por favor selecciona un archivo de imagen', 'error');
        return;
    }

    // Validate file size (max 5MB)
    if (file.size > 5 * 1024 * 1024) {
        showAlert('La imagen no debe superar 5MB', 'error');
        return;
    }

    try {
        // Show loading state
        document.getElementById('imageUploadArea').innerHTML = `
            <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: #3b82f6; margin-bottom: 10px;"></i>
            <p style="margin: 0; color: #1e40af;">Optimizando imagen...</p>
        `;

        // Optimize the image
        const optimizedImage = await optimizeImage(file);

        // Display preview
        document.getElementById('imagePreview').src = optimizedImage.dataUrl;
        document.getElementById('imagePreviewContainer').style.display = 'block';
        document.getElementById('imageUploadArea').style.display = 'none';

        // Store image data
        headerImageData = {
            dataUrl: optimizedImage.dataUrl,
            originalName: file.name,
            originalSize: file.size,
            optimizedSize: optimizedImage.size,
            width: optimizedImage.width,
            height: optimizedImage.height,
            type: optimizedImage.type
        };

        // Show image info
        const savings = Math.round((1 - optimizedImage.size / file.size) * 100);
        document.getElementById('imageInfo').innerHTML = `
            <i class="fas fa-check-circle" style="color: #10b981;"></i>
            <strong>${optimizedImage.width}x${optimizedImage.height}px</strong> |
            Original: ${formatFileSize(file.size)} ‚Üí
            Optimizado: ${formatFileSize(optimizedImage.size)}
            ${savings > 0 ? `<span style="color: #10b981;">(${savings}% reducido)</span>` : ''}
        `;

        // Update preview
        updatePreview();

    } catch (error) {
        console.error('Error processing image:', error);
        showAlert('Error al procesar la imagen', 'error');
        resetImageUpload();
    }
}

async function optimizeImage(file) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        const reader = new FileReader();

        reader.onload = (e) => {
            img.onload = () => {
                // Target dimensions for WhatsApp (max 1024px, recommended 800x418 for headers)
                const maxWidth = 1024;
                const maxHeight = 1024;

                let width = img.width;
                let height = img.height;

                // Scale down if necessary
                if (width > maxWidth || height > maxHeight) {
                    const ratio = Math.min(maxWidth / width, maxHeight / height);
                    width = Math.round(width * ratio);
                    height = Math.round(height * ratio);
                }

                // Create canvas and draw resized image
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, width, height);
                ctx.drawImage(img, 0, 0, width, height);

                // Determine output format and quality
                let outputType = 'image/jpeg';
                let quality = 0.85;

                // Keep PNG for images with transparency or if original is PNG
                if (file.type === 'image/png') {
                    // Check if image has transparency
                    const imageData = ctx.getImageData(0, 0, width, height);
                    const hasTransparency = checkTransparency(imageData);
                    if (hasTransparency) {
                        outputType = 'image/png';
                        quality = undefined;
                    }
                }

                // Convert to data URL
                const dataUrl = canvas.toDataURL(outputType, quality);

                // Calculate size
                const base64Length = dataUrl.split(',')[1].length;
                const size = Math.round(base64Length * 0.75);

                resolve({
                    dataUrl,
                    width,
                    height,
                    size,
                    type: outputType
                });
            };

            img.onerror = () => reject(new Error('Error loading image'));
            img.src = e.target.result;
        };

        reader.onerror = () => reject(new Error('Error reading file'));
        reader.readAsDataURL(file);
    });
}

function checkTransparency(imageData) {
    const data = imageData.data;
    for (let i = 3; i < data.length; i += 4) {
        if (data[i] < 255) return true;
    }
    return false;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}

function removeHeaderImage() {
    headerImageData = null;
    document.getElementById('headerImageFile').value = '';
    document.getElementById('imagePreviewContainer').style.display = 'none';
    resetImageUpload();
    updatePreview();
}

function resetImageUpload() {
    document.getElementById('imageUploadArea').style.display = 'block';
    document.getElementById('imageUploadArea').innerHTML = `
        <i class="fas fa-cloud-upload-alt" style="font-size: 32px; color: #3b82f6; margin-bottom: 10px;"></i>
        <p style="margin: 0; color: #1e40af; font-weight: 500;">Haz clic para subir imagen de referencia</p>
        <small style="color: #6b7280;">PNG, JPG hasta 5MB - Se optimizara automaticamente</small>
        <input type="file" id="headerImageFile" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
    `;
}

async function loadTemplates() {
    try {
        const response = await fetch('/whatsapp/templates');
        const data = await response.json();

        templates = data.templates || [];

        const container = document.getElementById('templatesList');
        const testSelect = document.getElementById('testTemplate');

        if (templates.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="fas fa-file-alt"></i><p>No hay templates</p></div>';
            testSelect.innerHTML = '<option value="">No hay templates disponibles</option>';
            return;
        }

        container.innerHTML = templates.map((t, index) => {
            const header = t.components.find(c => c.type === 'HEADER');
            const body = t.components.find(c => c.type === 'BODY');
            const footer = t.components.find(c => c.type === 'FOOTER');
            const buttons = t.components.find(c => c.type === 'BUTTONS');

            // Extract variables from body
            const bodyText = body?.text || '';
            const variableMatches = bodyText.match(/\{\{(\d+)\}\}/g) || [];
            const uniqueVars = [...new Set(variableMatches)].sort((a, b) =>
                parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0])
            );

            // Get example values if available
            const examples = body?.example?.body_text?.[0] || [];

            // Variable suggestions
            const varSuggestions = {
                '{{1}}': 'Nombre del usuario',
                '{{2}}': 'Nombre del evento',
                '{{3}}': 'Fecha/hora',
                '{{4}}': 'Ubicaci√≥n',
                '{{5}}': 'C√≥digo',
                '{{6}}': 'PIN'
            };

            // Build header HTML
            let headerHtml = '';
            if (header) {
                if (header.format === 'IMAGE') {
                    headerHtml = `
                        <div class="template-component">
                            <div class="template-component-label"><i class="fas fa-image"></i> HEADER (Imagen)</div>
                            <div class="template-header-image">
                                <i class="fas fa-photo-video"></i>
                                Se requiere enviar imagen al usar este template
                            </div>
                        </div>`;
                } else if (header.text) {
                    headerHtml = `
                        <div class="template-component">
                            <div class="template-component-label"><i class="fas fa-heading"></i> HEADER</div>
                            <div class="template-component-content">${header.text}</div>
                        </div>`;
                }
            }

            // Build variables HTML
            let variablesHtml = '';
            if (uniqueVars.length > 0) {
                variablesHtml = `
                    <div class="template-variables">
                        ${uniqueVars.map((v, i) => {
                            const varNum = parseInt(v.match(/\d+/)[0]);
                            const example = examples[varNum - 1] || '';
                            const suggestion = varSuggestions[v] || `Variable ${varNum}`;
                            return `<span class="template-variable-badge">
                                <code>${v}</code> ${suggestion}${example ? ` ‚Üí "${example}"` : ''}
                            </span>`;
                        }).join('')}
                    </div>`;
            }

            // Build footer HTML
            let footerHtml = '';
            if (footer?.text) {
                footerHtml = `
                    <div class="template-component">
                        <div class="template-component-label"><i class="fas fa-shoe-prints"></i> FOOTER</div>
                        <div class="template-component-content" style="font-size: 12px; color: #6b7280;">${footer.text}</div>
                    </div>`;
            }

            // Build buttons HTML for preview
            let buttonsHtml = '';
            if (buttons?.buttons) {
                buttonsHtml = `
                    <div class="buttons">
                        ${buttons.buttons.map(b => `<button>${b.text || b.otp_type || 'Bot√≥n'}</button>`).join('')}
                    </div>`;
            }

            // Replace variables with example values for preview
            let previewBodyText = bodyText;
            uniqueVars.forEach((v, i) => {
                const varNum = parseInt(v.match(/\d+/)[0]);
                const example = examples[varNum - 1] || varSuggestions[v] || `[Variable ${varNum}]`;
                previewBodyText = previewBodyText.replace(
                    new RegExp(`\\{\\{${varNum}\\}\\}`, 'g'),
                    `<span style="background: #dcfce7; padding: 0 3px; border-radius: 3px;">${example}</span>`
                );
            });

            // Category icon
            const categoryIcon = {
                'UTILITY': 'fa-tools',
                'MARKETING': 'fa-bullhorn',
                'AUTHENTICATION': 'fa-key'
            }[t.category] || 'fa-file';

            return `
            <div class="template-card">
                <div class="template-header">
                    <div>
                        <div class="template-name">${t.name}</div>
                        <div style="font-size: 12px; color: #6b7280;">
                            <i class="fas ${categoryIcon}" style="margin-right: 4px;"></i>
                            ${t.category} - ${t.language}
                        </div>
                    </div>
                    <span class="template-status ${t.status.toLowerCase()}">${t.status}</span>
                </div>

                <div class="template-components">
                    ${headerHtml}

                    <div class="template-component">
                        <div class="template-component-label"><i class="fas fa-align-left"></i> BODY</div>
                        <div class="template-component-content">${bodyText || '(Template de autenticaci√≥n - formato fijo de Meta)'}</div>
                    </div>

                    ${footerHtml}
                </div>

                ${variablesHtml}

                <button class="template-preview-toggle" onclick="toggleTemplatePreview(${index})">
                    <i class="fas fa-mobile-alt"></i> Ver preview
                </button>

                <div class="template-preview-section" id="templatePreview${index}">
                    <div class="template-preview-phone">
                        <div class="template-preview-bubble">
                            ${header?.text ? `<div class="header">${header.text}</div>` : ''}
                            ${header?.format === 'IMAGE' ? '<div style="background: #ddd; height: 150px; border-radius: 6px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; color: #666;"><i class="fas fa-image fa-2x"></i></div>' : ''}
                            <div class="body">${previewBodyText || 'Tu c√≥digo de verificaci√≥n es {{1}}'}</div>
                            ${footer?.text ? `<div class="footer">${footer.text}</div>` : ''}
                            ${buttonsHtml}
                        </div>
                    </div>
                </div>

                <div class="template-meta" style="margin-top: 12px;">
                    <span><i class="fas fa-language"></i> ${t.language}</span>
                    <span><i class="fas fa-hashtag"></i> ${uniqueVars.length} variable${uniqueVars.length !== 1 ? 's' : ''}</span>
                    ${header ? `<span><i class="fas fa-${header.format === 'IMAGE' ? 'image' : 'heading'}"></i> Con header</span>` : ''}
                </div>
            </div>
        `}).join('');

        // Update test select
        const approvedTemplates = templates.filter(t => t.status === 'APPROVED');
        testSelect.innerHTML = approvedTemplates.length > 0
            ? approvedTemplates.map(t => `<option value="${t.name}" data-language="${t.language}">${t.name} (${t.language})</option>`).join('')
            : '<option value="">No hay templates aprobados</option>';

    } catch (error) {
        console.error('Error loading templates:', error);
    }
}

function openCreateTemplateModal() {
    document.getElementById('createTemplateModal').classList.add('show');
    updatePreview();
}

function closeModal() {
    document.getElementById('createTemplateModal').classList.remove('show');
    document.getElementById('createTemplateForm').reset();
    document.getElementById('variablesSection').style.display = 'none';
    document.getElementById('headerTextInput').style.display = 'none';
    document.getElementById('headerImageInput').style.display = 'none';
    // Reset image upload
    headerImageData = null;
    document.getElementById('imagePreviewContainer').style.display = 'none';
    resetImageUpload();
}

function onCategoryChange() {
    const category = document.getElementById('templateCategory').value;
    const helpText = document.getElementById('categoryHelp');
    const authWarning = document.getElementById('authWarning');
    const bodySection = document.getElementById('templateBody').parentElement;
    const headerSection = document.getElementById('headerSection');

    authWarning.style.display = 'none';
    bodySection.style.display = 'block';
    headerSection.style.display = 'block';

    switch(category) {
        case 'UTILITY':
            helpText.textContent = 'Para confirmaciones de eventos, recordatorios, notificaciones';
            break;
        case 'MARKETING':
            helpText.textContent = 'Para promociones, ofertas, campa√±as. Puede incluir im√°genes.';
            break;
        case 'AUTHENTICATION':
            helpText.textContent = 'Para c√≥digos OTP/verificaci√≥n. Formato fijo de Meta.';
            authWarning.style.display = 'block';
            bodySection.style.display = 'none';
            headerSection.style.display = 'none';
            break;
    }
}

function onHeaderTypeChange() {
    const headerType = document.getElementById('templateHeaderType').value;
    document.getElementById('headerTextInput').style.display = headerType === 'TEXT' ? 'block' : 'none';
    document.getElementById('headerImageInput').style.display = headerType === 'IMAGE' ? 'block' : 'none';

    // Mostrar aviso si seleccionan IMAGE (a√∫n no completamente implementado)
    const imageWarning = document.getElementById('imageHeaderWarning');
    if (imageWarning) {
        imageWarning.style.display = headerType === 'IMAGE' ? 'block' : 'none';
    }

    updatePreview();
}

function updateVariablesList() {
    const body = document.getElementById('templateBody').value;
    const matches = body.match(/\{\{(\d+)\}\}/g) || [];
    const uniqueVars = [...new Set(matches)].sort((a, b) => {
        return parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0]);
    });

    const section = document.getElementById('variablesSection');
    const list = document.getElementById('variablesList');

    if (uniqueVars.length === 0) {
        section.style.display = 'none';
        return;
    }

    section.style.display = 'block';

    // Common variable suggestions
    const suggestions = {
        '{{1}}': 'Nombre del usuario',
        '{{2}}': 'Nombre del evento',
        '{{3}}': 'Fecha del evento',
        '{{4}}': 'Lugar del evento',
        '{{5}}': 'C√≥digo del ticket',
        '{{6}}': 'PIN de acceso'
    };

    const exampleValues = {
        '{{1}}': 'Mar√≠a Garc√≠a',
        '{{2}}': 'Workshop de Python',
        '{{3}}': '15 de Enero 2025 - 10:00 AM',
        '{{4}}': 'Auditorio UTadeo',
        '{{5}}': 'TKT-12345',
        '{{6}}': '1234'
    };

    list.innerHTML = uniqueVars.map(v => `
        <div style="display: grid; grid-template-columns: 80px 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px;">
            <code style="background: #e5e7eb; padding: 4px 8px; border-radius: 4px; font-weight: bold;">${v}</code>
            <input type="text" class="form-control" style="font-size: 13px;"
                   id="varDesc${v.match(/\d+/)[0]}"
                   placeholder="Descripci√≥n"
                   value="${suggestions[v] || ''}">
            <input type="text" class="form-control" style="font-size: 13px;"
                   id="varExample${v.match(/\d+/)[0]}"
                   placeholder="Ejemplo"
                   value="${exampleValues[v] || ''}"
                   oninput="updatePreview()">
        </div>
    `).join('');
}

function updatePreview() {
    const headerType = document.getElementById('templateHeaderType').value;
    const headerText = document.getElementById('templateHeaderText').value;
    const body = document.getElementById('templateBody').value;
    const footer = document.getElementById('templateFooter').value;

    // Header preview
    const previewHeader = document.getElementById('previewHeader');
    if (headerType === 'TEXT' && headerText) {
        previewHeader.style.display = 'block';
        previewHeader.textContent = headerText;
    } else if (headerType === 'IMAGE') {
        previewHeader.style.display = 'block';
        if (headerImageData && headerImageData.dataUrl) {
            previewHeader.innerHTML = `<img src="${headerImageData.dataUrl}" style="max-width: 100%; max-height: 150px; border-radius: 4px; margin-bottom: 8px;">`;
        } else {
            previewHeader.innerHTML = '<div style="background: #f0f0f0; height: 120px; border-radius: 4px; display: flex; align-items: center; justify-content: center; margin-bottom: 8px;"><i class="fas fa-image" style="font-size: 32px; color: #9ca3af;"></i></div>';
        }
    } else {
        previewHeader.style.display = 'none';
    }

    // Body preview with variable replacement
    let previewBody = body || 'Tu mensaje aparecer√° aqu√≠...';
    const matches = body.match(/\{\{(\d+)\}\}/g) || [];
    matches.forEach(v => {
        const num = v.match(/\d+/)[0];
        const exampleInput = document.getElementById(`varExample${num}`);
        const example = exampleInput ? exampleInput.value : `[Variable ${num}]`;
        previewBody = previewBody.replace(v, `<span style="background: #dcfce7; padding: 0 2px; border-radius: 2px;">${example || `[${num}]`}</span>`);
    });
    document.getElementById('previewBody').innerHTML = previewBody.replace(/\n/g, '<br>');

    // Footer preview
    const previewFooter = document.getElementById('previewFooter');
    if (footer) {
        previewFooter.style.display = 'block';
        previewFooter.textContent = footer;
    } else {
        previewFooter.style.display = 'none';
    }
}

async function createTemplate(e) {
    e.preventDefault();

    const category = document.getElementById('templateCategory').value;
    const headerType = document.getElementById('templateHeaderType').value;
    const body = document.getElementById('templateBody').value;

    // Collect variable examples
    const matches = body.match(/\{\{(\d+)\}\}/g) || [];
    const uniqueVars = [...new Set(matches)].sort((a, b) => {
        return parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0]);
    });

    const variableExamples = uniqueVars.map(v => {
        const num = v.match(/\d+/)[0];
        const exampleInput = document.getElementById(`varExample${num}`);
        return exampleInput ? exampleInput.value : `Ejemplo ${num}`;
    });

    // Validar que si es IMAGE, haya una imagen cargada
    if (headerType === 'IMAGE' && !headerImageData) {
        showAlert('Debes subir una imagen para el header', 'error');
        return;
    }

    const data = {
        name: document.getElementById('templateName').value,
        display_name: document.getElementById('templateDisplayName').value,
        category: category,
        language: document.getElementById('templateLanguage').value,
        body_text: category === 'AUTHENTICATION' ? null : body,
        footer_text: document.getElementById('templateFooter').value || null,
        header_type: headerType !== 'NONE' ? headerType : null,
        header_text: headerType === 'TEXT' ? document.getElementById('templateHeaderText').value : null,
        header_image_base64: headerType === 'IMAGE' && headerImageData ? headerImageData.dataUrl : null,
        variable_examples: variableExamples.length > 0 ? variableExamples : null
    };

    try {
        const response = await fetch('/whatsapp/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            const statusMsg = result.status === 'APPROVED'
                ? '¬°Template aprobado autom√°ticamente!'
                : result.status === 'REJECTED'
                ? 'Template rechazado por Meta. Revisa el contenido.'
                : 'Template enviado a Meta para aprobaci√≥n (24-48h)';

            showAlert(statusMsg, result.status === 'REJECTED' ? 'error' : 'success');
            closeModal();
            loadTemplates();
        } else {
            // Show detailed error
            let errorMsg = result.error || 'Error al crear template';
            if (result.error_user_msg) {
                errorMsg += ': ' + result.error_user_msg;
            }
            if (result.error_code) {
                errorMsg += ` (Code: ${result.error_code})`;
            }
            // Log full error for debugging
            console.error('Template creation error:', result);
            showAlert(errorMsg, 'error');
        }
    } catch (error) {
        showAlert('Error de conexi√≥n', 'error');
    }
}

// Test functions
function toggleTestForm() {
    const type = document.getElementById('testMessageType').value;
    document.getElementById('templateTestForm').style.display = type === 'template' ? 'block' : 'none';
    document.getElementById('textTestForm').style.display = type === 'text' ? 'block' : 'none';
}

// Variable suggestions for known templates
const templateVariableInfo = {
    'tickets_event': {
        variables: ['Nombre del usuario', 'Nombre del evento', 'Fecha del evento', 'Lugar del evento'],
        examples: ['Mar√≠a Garc√≠a', 'Workshop de Python', '15 de Feb 2026 - 10:00 AM', 'Auditorio UTadeo'],
        hasImage: true
    },
    'event_reminder': {
        variables: ['Nombre', 'Evento', 'Fecha', 'Lugar'],
        examples: ['Juan', 'Conferencia IEEE', 'Ma√±ana 3:00 PM', 'Sala 301'],
        hasImage: false
    }
};

function onTestTemplateChange() {
    const templateSelect = document.getElementById('testTemplate');
    const templateName = templateSelect.value;
    const variablesSection = document.getElementById('templateVariablesSection');
    const variablesFields = document.getElementById('templateVariablesFields');
    const imageSection = document.getElementById('templateImageSection');

    if (!templateName) {
        variablesSection.style.display = 'none';
        imageSection.style.display = 'none';
        return;
    }

    // Buscar informaci√≥n del template seleccionado
    const selectedTemplate = templates.find(t => t.name === templateName);
    if (!selectedTemplate) {
        variablesSection.style.display = 'none';
        imageSection.style.display = 'none';
        return;
    }

    // Extraer variables del body del template
    const body = selectedTemplate.components.find(c => c.type === 'BODY');
    const header = selectedTemplate.components.find(c => c.type === 'HEADER');
    const bodyText = body?.text || '';
    const variableMatches = bodyText.match(/\{\{(\d+)\}\}/g) || [];
    const uniqueVars = [...new Set(variableMatches)].sort((a, b) =>
        parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0])
    );

    // Obtener info predefinida o generar gen√©rica
    const info = templateVariableInfo[templateName] || {
        variables: uniqueVars.map((v, i) => `Variable ${i + 1}`),
        examples: uniqueVars.map((v, i) => `Ejemplo ${i + 1}`),
        hasImage: header?.format === 'IMAGE'
    };

    // Mostrar campos de variables
    if (uniqueVars.length > 0) {
        variablesSection.style.display = 'block';
        variablesFields.innerHTML = uniqueVars.map((v, i) => `
            <div class="form-group">
                <label class="form-label">${info.variables[i] || 'Variable ' + (i + 1)} <code>${v}</code></label>
                <input type="text" class="form-control" id="testVar${i}"
                       placeholder="${info.examples[i] || ''}"
                       value="${info.examples[i] || ''}">
            </div>
        `).join('');
    } else {
        variablesSection.style.display = 'none';
    }

    // Mostrar campo de imagen si el template tiene header IMAGE
    if (header?.format === 'IMAGE') {
        imageSection.style.display = 'block';
    } else {
        imageSection.style.display = 'none';
    }
}

async function sendTestMessage() {
    const phone = document.getElementById('testPhone').value.trim();
    if (!phone) {
        showAlert('Ingresa un numero de telefono', 'error');
        return;
    }

    const type = document.getElementById('testMessageType').value;

    try {
        let response;

        if (type === 'template') {
            const templateSelect = document.getElementById('testTemplate');
            const templateName = templateSelect.value;
            if (!templateName) {
                showAlert('Selecciona un template', 'error');
                return;
            }
            const templateLanguage = templateSelect.selectedOptions[0].dataset.language || 'es_MX';

            // Recoger variables
            const variables = [];
            let i = 0;
            while (document.getElementById(`testVar${i}`)) {
                const value = document.getElementById(`testVar${i}`).value.trim();
                if (value) {
                    variables.push(value);
                }
                i++;
            }

            // Recoger imagen de header si existe
            const headerImageUrl = document.getElementById('testHeaderImageUrl')?.value.trim() || null;

            const requestBody = {
                phone,
                template_name: templateName,
                language: templateLanguage
            };

            // Solo agregar variables si hay alguna
            if (variables.length > 0) {
                requestBody.variables = variables;
            }

            // Agregar imagen si se proporcion√≥
            if (headerImageUrl) {
                requestBody.header_image_link = headerImageUrl;
            }

            console.log('Enviando template:', requestBody);

            response = await fetch('/whatsapp/send-template', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
        } else {
            const message = document.getElementById('testMessage').value.trim();
            if (!message) {
                showAlert('Escribe un mensaje', 'error');
                return;
            }

            response = await fetch('/whatsapp/test-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, message })
            });
        }

        const data = await response.json();

        if (data.success) {
            showAlert('Mensaje enviado exitosamente! ID: ' + data.message_id);
        } else {
            showAlert(data.error || 'Error al enviar mensaje', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error de conexi√≥n', 'error');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    refreshStatus();
    loadTemplates();

    // Check unread count
    fetch('/whatsapp/unread-count')
        .then(r => r.json())
        .then(data => {
            const badge = document.getElementById('totalUnread');
            if (data.unread_count > 0) {
                badge.textContent = data.unread_count;
                badge.style.display = 'inline';
            }
        });
});
</script>
{% endblock %}
