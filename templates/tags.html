{% extends "base.html" %}

{% block title %}Etiquetas - IEEE Tadeo Control System{% endblock %}

{% block content %}
<div class="rounded-lg border bg-card text-card-foreground shadow-sm">
    <div class="flex flex-col space-y-1.5 p-6">
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-2xl font-semibold leading-none tracking-tight">Gestion de Etiquetas</h3>
                <p class="text-sm text-muted-foreground mt-1">Administra las etiquetas para categorizar usuarios</p>
            </div>
            <button onclick="openModal()" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2">
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Nueva Etiqueta
            </button>
        </div>

        <!-- Barra de busqueda -->
        <div class="mt-4 flex gap-4 items-center">
            <div class="flex-1 relative">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Buscar etiquetas..."
                    class="flex h-10 w-full rounded-md border border-input bg-background pl-10 pr-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"
                    onkeyup="filterTags()"
                >
            </div>
            <select id="statusFilter" onchange="filterTags()" class="flex h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                <option value="all">Todas</option>
                <option value="active">Solo activas</option>
                <option value="inactive">Solo inactivas</option>
            </select>
        </div>
    </div>

    <div class="p-6 pt-0">
        <!-- Vista de tarjetas -->
        <div id="tagsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-8 text-muted-foreground">
                Cargando etiquetas...
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear/editar etiqueta -->
<div id="tagModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h3 id="modalTitle" class="text-lg font-semibold leading-none tracking-tight">Nueva Etiqueta</h3>
                <button onclick="closeModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6">
            <form id="tagForm" class="space-y-4">
                <input type="hidden" id="tagId" name="tagId">

                <div class="space-y-2">
                    <label for="name" class="text-sm font-medium leading-none">Nombre *</label>
                    <input type="text" id="name" name="name" required placeholder="Ej: IEEE Tadeo, YP Colombia" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                </div>

                <div class="space-y-2">
                    <label for="description" class="text-sm font-medium leading-none">Descripcion</label>
                    <textarea id="description" name="description" rows="2" placeholder="Descripcion opcional de la etiqueta" class="flex w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2"></textarea>
                </div>

                <div class="space-y-2">
                    <label for="color" class="text-sm font-medium leading-none">Color</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="color" name="color" value="#3B82F6" class="h-10 w-16 rounded-md border border-input cursor-pointer">
                        <div id="colorPreview" class="flex-1 h-10 rounded-md flex items-center justify-center text-white text-sm font-medium" style="background-color: #3B82F6;">
                            Vista previa
                        </div>
                    </div>
                    <!-- Colores predefinidos -->
                    <div class="flex flex-wrap gap-2 mt-2">
                        <button type="button" onclick="setColor('#3B82F6')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #3B82F6;" title="Azul"></button>
                        <button type="button" onclick="setColor('#10B981')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #10B981;" title="Verde"></button>
                        <button type="button" onclick="setColor('#F59E0B')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #F59E0B;" title="Amarillo"></button>
                        <button type="button" onclick="setColor('#EF4444')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #EF4444;" title="Rojo"></button>
                        <button type="button" onclick="setColor('#8B5CF6')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #8B5CF6;" title="Morado"></button>
                        <button type="button" onclick="setColor('#EC4899')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #EC4899;" title="Rosa"></button>
                        <button type="button" onclick="setColor('#06B6D4')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #06B6D4;" title="Cyan"></button>
                        <button type="button" onclick="setColor('#6B7280')" class="w-6 h-6 rounded-full border-2 border-white shadow" style="background-color: #6B7280;" title="Gris"></button>
                    </div>
                </div>

                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="is_active" name="is_active" checked class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <label for="is_active" class="text-sm font-medium leading-none">
                        Etiqueta activa
                    </label>
                </div>

                <button type="submit" id="submitBtn" class="inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground hover:bg-primary/90 h-10 px-4 py-2 w-full">
                    Guardar Etiqueta
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Modal para ver usuarios de una etiqueta -->
<div id="usersModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[80vh] flex flex-col">
        <div class="flex flex-col space-y-1.5 p-6 border-b">
            <div class="flex items-center justify-between">
                <h3 id="usersModalTitle" class="text-lg font-semibold leading-none tracking-tight">Usuarios con etiqueta</h3>
                <button onclick="closeUsersModal()" class="rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <div id="usersContent">
                Cargando usuarios...
            </div>
        </div>
    </div>
</div>

<!-- Notificacion flotante -->
<div id="notification" class="hidden fixed top-4 left-1/2 transform -translate-x-1/2 z-[60] w-11/12 max-w-md shadow-lg rounded-lg transition-all duration-300"></div>
{% endblock %}

{% block extra_js %}
<script>
    let isEditMode = false;
    let tags = [];
    const token = localStorage.getItem('access_token');

    // Funcion para mostrar notificacion flotante
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        const bgColor = type === 'success' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
        const textColor = type === 'success' ? 'text-green-900' : 'text-red-900';

        notification.innerHTML = `
            <div class="border ${bgColor} px-4 py-3 ${textColor} flex items-center justify-between">
                <span class="font-medium">${message}</span>
                <button onclick="hideNotification()" class="ml-4 text-current opacity-70 hover:opacity-100">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        `;

        notification.classList.remove('hidden');
        setTimeout(() => hideNotification(), 3000);
    }

    function hideNotification() {
        document.getElementById('notification').classList.add('hidden');
    }

    // Cargar etiquetas
    async function loadTags() {
        try {
            const response = await fetch('/tags/?active_only=false', {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                tags = await response.json();
                renderTags();
            }
        } catch (error) {
            console.error('Error al cargar etiquetas:', error);
            showNotification('Error al cargar etiquetas', 'error');
        }
    }

    function renderTags() {
        const grid = document.getElementById('tagsGrid');

        if (tags.length === 0) {
            grid.innerHTML = `
                <div class="col-span-full flex flex-col items-center justify-center py-12 text-center">
                    <svg class="h-16 w-16 text-muted-foreground mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                    </svg>
                    <p class="text-muted-foreground text-lg">No hay etiquetas registradas</p>
                    <p class="text-muted-foreground text-sm mt-1">Crea la primera etiqueta para categorizar usuarios</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = tags.map(tag => {
            const textColor = getContrastColor(tag.color || '#3B82F6');
            return `
                <div class="tag-card border rounded-lg overflow-hidden transition-all hover:shadow-md ${!tag.is_active ? 'opacity-60' : ''}" data-name="${tag.name.toLowerCase()}" data-active="${tag.is_active}">
                    <div class="h-2" style="background-color: ${tag.color || '#3B82F6'}"></div>
                    <div class="p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="inline-flex items-center rounded-full px-3 py-1 text-sm font-medium" style="background-color: ${tag.color || '#3B82F6'}; color: ${textColor}">
                                    ${tag.name}
                                </span>
                                ${!tag.is_active ? '<span class="text-xs text-muted-foreground">(Inactiva)</span>' : ''}
                            </div>
                        </div>
                        ${tag.description ? `<p class="text-sm text-muted-foreground mb-3">${tag.description}</p>` : ''}
                        <div class="flex items-center justify-between">
                            <button onclick="showTagUsers(${tag.id}, '${tag.name.replace(/'/g, "\\'")}')" class="text-sm text-blue-600 hover:underline flex items-center gap-1">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                                Ver usuarios
                            </button>
                            <div class="flex gap-1">
                                <button onclick='editTag(${JSON.stringify(tag).replace(/'/g, "&#39;")})' class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors border border-input bg-background hover:bg-accent hover:text-accent-foreground h-7 w-7" title="Editar">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="deleteTag(${tag.id}, '${tag.name.replace(/'/g, "\\'")}')" class="inline-flex items-center justify-center rounded text-xs font-medium transition-colors bg-destructive text-destructive-foreground hover:bg-destructive/90 h-7 w-7" title="Eliminar">
                                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // Funcion para determinar color de texto basado en color de fondo
    function getContrastColor(hexColor) {
        const r = parseInt(hexColor.slice(1, 3), 16);
        const g = parseInt(hexColor.slice(3, 5), 16);
        const b = parseInt(hexColor.slice(5, 7), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5 ? '#000000' : '#FFFFFF';
    }

    // Modal funciones
    function openModal() {
        isEditMode = false;
        document.getElementById('modalTitle').textContent = 'Nueva Etiqueta';
        document.getElementById('submitBtn').textContent = 'Guardar Etiqueta';
        document.getElementById('tagForm').reset();
        document.getElementById('is_active').checked = true;
        document.getElementById('color').value = '#3B82F6';
        updateColorPreview('#3B82F6');
        document.getElementById('tagModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('tagModal').classList.add('hidden');
        document.getElementById('tagForm').reset();
        document.getElementById('tagId').value = '';
        isEditMode = false;
    }

    function setColor(color) {
        document.getElementById('color').value = color;
        updateColorPreview(color);
    }

    function updateColorPreview(color) {
        const preview = document.getElementById('colorPreview');
        preview.style.backgroundColor = color;
        preview.style.color = getContrastColor(color);
    }

    document.getElementById('color').addEventListener('input', (e) => {
        updateColorPreview(e.target.value);
    });

    // Submit form
    document.getElementById('tagForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const tagId = document.getElementById('tagId').value;
        const formData = {
            name: document.getElementById('name').value,
            description: document.getElementById('description').value || null,
            color: document.getElementById('color').value,
            is_active: document.getElementById('is_active').checked
        };

        try {
            let response;
            if (isEditMode && tagId) {
                response = await fetch(`/tags/${tagId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            } else {
                response = await fetch('/tags/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
            }

            const data = await response.json();

            if (response.ok) {
                showNotification(isEditMode ? 'Etiqueta actualizada' : 'Etiqueta creada', 'success');
                closeModal();
                loadTags();
            } else {
                showNotification(`Error: ${data.detail}`, 'error');
            }
        } catch (error) {
            showNotification('Error al guardar etiqueta', 'error');
        }
    });

    function editTag(tag) {
        isEditMode = true;
        document.getElementById('modalTitle').textContent = 'Editar Etiqueta';
        document.getElementById('submitBtn').textContent = 'Actualizar Etiqueta';

        document.getElementById('tagId').value = tag.id;
        document.getElementById('name').value = tag.name;
        document.getElementById('description').value = tag.description || '';
        document.getElementById('color').value = tag.color || '#3B82F6';
        document.getElementById('is_active').checked = tag.is_active;

        updateColorPreview(tag.color || '#3B82F6');
        document.getElementById('tagModal').classList.remove('hidden');
    }

    async function deleteTag(id, name) {
        if (!confirm(`Â¿Estas seguro de eliminar la etiqueta "${name}"?\n\nSi hay usuarios con esta etiqueta, se les quitara automaticamente.`)) {
            return;
        }

        try {
            const response = await fetch(`/tags/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            const data = await response.json();

            if (response.ok) {
                showNotification('Etiqueta eliminada', 'success');
                loadTags();
            } else {
                showNotification(`Error: ${data.detail}`, 'error');
            }
        } catch (error) {
            showNotification('Error al eliminar etiqueta', 'error');
        }
    }

    // Ver usuarios de una etiqueta
    async function showTagUsers(tagId, tagName) {
        document.getElementById('usersModalTitle').textContent = `Usuarios con etiqueta: ${tagName}`;
        document.getElementById('usersContent').innerHTML = '<div class="text-center py-8 text-muted-foreground">Cargando usuarios...</div>';
        document.getElementById('usersModal').classList.remove('hidden');

        try {
            const response = await fetch(`/users/by-tag/${tagId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (response.ok) {
                const users = await response.json();

                if (users.length === 0) {
                    document.getElementById('usersContent').innerHTML = `
                        <div class="text-center py-8">
                            <svg class="mx-auto h-12 w-12 text-muted-foreground mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="text-muted-foreground">No hay usuarios con esta etiqueta</p>
                        </div>
                    `;
                    return;
                }

                document.getElementById('usersContent').innerHTML = `
                    <p class="text-sm text-muted-foreground mb-4">${users.length} usuario(s) encontrado(s)</p>
                    <div class="space-y-2 max-h-96 overflow-y-auto">
                        ${users.map(user => `
                            <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-muted/50">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                                        <span class="text-primary font-medium">${user.name.charAt(0).toUpperCase()}</span>
                                    </div>
                                    <div>
                                        <p class="font-medium">${user.name}</p>
                                        <p class="text-sm text-muted-foreground">${user.email}</p>
                                    </div>
                                </div>
                                <a href="/admin/users?search=${encodeURIComponent(user.email)}" class="text-sm text-blue-600 hover:underline">
                                    Ver perfil
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                document.getElementById('usersContent').innerHTML = '<p class="text-red-600">Error al cargar usuarios</p>';
            }
        } catch (error) {
            document.getElementById('usersContent').innerHTML = '<p class="text-red-600">Error de conexion</p>';
        }
    }

    function closeUsersModal() {
        document.getElementById('usersModal').classList.add('hidden');
    }

    // Filtrar etiquetas
    function filterTags() {
        const searchInput = document.getElementById('searchInput').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value;
        const cards = document.querySelectorAll('.tag-card');

        let visibleCount = 0;

        cards.forEach(card => {
            const name = card.dataset.name;
            const isActive = card.dataset.active === 'true';

            const matchesSearch = searchInput === '' || name.includes(searchInput);
            const matchesStatus = statusFilter === 'all' ||
                (statusFilter === 'active' && isActive) ||
                (statusFilter === 'inactive' && !isActive);

            if (matchesSearch && matchesStatus) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
    }

    // Cargar al iniciar
    window.addEventListener('DOMContentLoaded', loadTags);
</script>
{% endblock %}
